<!--
  Soirée de carte – INDEX
  Version: v3.3 (2025-11-02)
  Auteur: Jean-François + ChatGPT
  Points clés:
    - Fond d’écran Jeep conservé
    - Cartes fond sombre (opacité 35%)
    - Texte des cartes en blanc pur, taille de police augmentée
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Soirée de carte – Accueil</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#ffffff; --muted:#dfe3ec; --accent:#4fd1c5; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220 url('https://jads.ca/image/fond_jeep.webp') center/cover no-repeat fixed;color:var(--text);font-size:1.05rem}
    .wrap{max-width:680px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .card{background:rgba(0,0,0,0.35);border:1px solid #3a4a6a;border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);color:#ffffff;font-size:1.1rem}
    h1{margin:4px 0 0;font-size:2rem;color:#ffffff}
    h2{margin:0 0 6px;font-size:1.3rem;color:#ffffff}
    .info{color:#ffffff;font-size:1.05rem;line-height:1.4}
    label{color:#ffffff;font-size:1.05rem}
    input[type="number"],textarea,input[type="tel"]{width:100%;font-size:1.15rem;padding:14px 16px;border-radius:14px;border:2px solid transparent;background:#0f1a30;color:#ffffff;outline:none}
    input:focus,textarea:focus{border-color:var(--accent)}
    textarea{min-height:140px;resize:vertical}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:54px;padding:14px;border-radius:14px;font-size:1.15rem;font-weight:800;color:#0c111b;background:var(--accent)}
    .btn.small{min-height:48px;padding:12px;font-weight:700}
    .grid{display:grid;gap:12px}
    .cols{display:grid;gap:12px}
    @media(min-width:640px){.cols{grid-template-columns:1fr 1fr}}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
    .ok{background:#0e2b1b;border:1px solid #1f6b3a;padding:10px;border-radius:12px;color:#d6ffe8;display:none}
    .footer{color:#ffffff;text-align:center;font-size:.95rem;margin-top:8px}
  </style>

  <script type="module">
    const HOST = location.hostname;
    const FIREBASE_ALLOWED = (
      HOST === 'localhost' ||
      HOST === '127.0.0.1' ||
      HOST === 'jads.ca' ||
      HOST === 'www.jads.ca' ||
      HOST === 'jeffb1959.github.io'
    );

    const $ = (id)=>document.getElementById(id);
    const showError = (msg)=>{ const b=$('error'); b.textContent=msg; b.style.display='block'; $('ok').style.display='none'; };
    const showOk    = (msg)=>{ const b=$('ok');    b.textContent=msg; b.style.display='block'; $('error').style.display='none'; };

    const LS_KEY = 'sc_sandbox_soirees';
    const storeRead  = ()=>{ try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch{return{}} };
    const storeWrite = (obj)=>{ try{localStorage.setItem(LS_KEY, JSON.stringify(obj))}catch{} };

    let api = null;

    if (FIREBASE_ALLOWED) {
      (async () => {
        try{
          const [appMod, authMod, fsMod] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js'),
          ]);
          const { initializeApp } = appMod;
          const { getAuth, signInAnonymously, onAuthStateChanged } = authMod;
          const { getFirestore, doc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs } = fsMod;

          const firebaseConfig = {
            apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
            authDomain: "soireecartev2.firebaseapp.com",
            projectId: "soireecartev2",
            storageBucket: "soireecartev2.firebasestorage.app",
            messagingSenderId: "784781686361",
            appId: "1:784781686361:web:033693cb22fb1a55af2348"
          };

          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const db   = getFirestore(app);

          api = {
            async initAuth(){
              try{ await signInAnonymously(auth); }catch(e){ showError(`Auth anonyme impossible: ${e?.message||e}`); }
              onAuthStateChanged(auth, (user)=>{
                if(!user) return;
                $('btnStart').disabled = false;
                $('btnJoinAsPlayer').disabled = false;
                $('btnJoinAsHost').disabled   = false;
              });
            },
            async create(code, names, n){
              await setDoc(doc(db, 'soirees', code), {
                code,
                playerCount: n,
                players: names.map((name, idx)=>({ name, order: idx, confirmed: idx === 0 })),
                status: 'setup',
                createdAt: serverTimestamp()
              });
            },
            async getLatestCode(){
              try{
                const q = query(collection(db,'soirees'), orderBy('createdAt','desc'), limit(1));
                const snap = await getDocs(q);
                if(!snap.empty){
                  const d = snap.docs[0];
                  const data = d.data()||{};
                  return String(data.code || d.id || '').replace(/\D/g,'').slice(0,4);
                }
              }catch(e){ }
              return '';
            }
          };

          await api.initAuth();
        }catch(e){ setupSandbox(); }
      })();
    } else {
      setupSandbox();
    }

    function setupSandbox(){
      api = {
        async initAuth(){
          $('btnStart').disabled = false;
          $('btnJoinAsPlayer').disabled = false;
          $('btnJoinAsHost').disabled   = false;
        },
        async create(code, names, n){
          const store = storeRead();
          store[code] = {
            code,
            playerCount: n,
            players: names.map((name, idx)=>({ name, order: idx, confirmed: idx === 0 })),
            status: 'setup',
            createdAt: Date.now()
          };
          storeWrite(store);
        },
        async getLatestCode(){
          return (localStorage.getItem('sc_code')||'').replace(/\D/g,'').slice(0,4);
        }
      };
      api.initAuth();
    }

    window.addEventListener('DOMContentLoaded', () => {
      const nb   = $('playersCount');
      const list = $('playersNames');
      const btn  = $('btnStart');
      const resume = $('resumeCode');

      nb.addEventListener('change', () => {
        const v = Math.max(2, Math.min(8, parseInt(nb.value||'0',10)));
        nb.value = String(isNaN(v)?4:v);
      });

      (async function prefill(){
        try{
          for(let i=0;i<20;i++){
            if(api && typeof api.getLatestCode === 'function') break;
            await new Promise(r=>setTimeout(r,75));
          }
          if(api && api.getLatestCode){
            const last = await api.getLatestCode();
            if(last && last.length===4){ resume.value = last; }
          }
        }catch{}
      })();

      btn.addEventListener('click', async () => {
        const n = Math.max(2, Math.min(8, parseInt(nb.value||'0',10)));
        const names = (list.value||'')
          .replace(/\r/g,'')
          .split(/\n+/)
          .map(s => s.trim())
          .filter(Boolean);

        if(names.length !== n){ showError(`Veuillez entrer exactement ${n} nom(s).`); return; }

        const code = String(Math.floor(1000 + Math.random()*9000));
        localStorage.setItem('sc_code', code);
        localStorage.setItem('sc_players', JSON.stringify(names));
        localStorage.setItem('sc_count', String(n));

        try{
          await api.create(code, names, n);
          showOk(`Soirée #${code} créée. Ouverture de l'écran hôte…`);
          window.location.href = `attente_confirmation.html?code=${code}&host=1`;
        }catch(err){ showError(`Échec: ${err?.message||err}`); }
      });

      const codeInput = $('resumeCode');
      const btnPlayer = $('btnJoinAsPlayer');
      const btnHost   = $('btnJoinAsHost');
      const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);

      btnPlayer.addEventListener('click', ()=>{
        const v = sanitizeCode(codeInput.value || localStorage.getItem('sc_code'));
        if(v.length!==4){ showError('Entrez un code valide.'); return; }
        localStorage.setItem('sc_code', v);
        window.location.href = `confirmation_joueurs.html?code=${v}`;
      });

      btnHost.addEventListener('click', ()=>{
        const v = sanitizeCode(codeInput.value || localStorage.getItem('sc_code'));
        if(v.length!==4){ showError('Entrez un code valide.'); return; }
        localStorage.setItem('sc_code', v);
        window.location.href = `attente_confirmation.html?code=${v}&host=1`;
      });
    });
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card grid">
      <h1>Soirée de carte</h1>
      <p class="info">Inscrire le nom des joueurs en commençant par le maître du jeu, puis dans le sens horaire.</p>
      <label for="playersCount">Nombre de joueurs</label>
      <input id="playersCount" type="number" min="2" max="8" value="4" inputmode="numeric" />
      <label for="playersNames">Noms ou surnoms (une ligne par nom)</label>
      <textarea id="playersNames" placeholder="Ex. Jean-François (hôte)\nLise\nMarc\nLouise"></textarea>
      <button class="btn" id="btnStart" disabled>Débuter la soirée</button>
      <div id="error" class="err"></div>
      <div id="ok" class="ok"></div>
    </section>

    <section class="card grid">
      <h2>Reprendre une soirée</h2>
      <label for="resumeCode">Code (4 chiffres)</label>
      <input id="resumeCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Ex.: 1234" />
      <div class="cols">
        <button class="btn small" id="btnJoinAsPlayer" disabled>Rejoindre comme joueur</button>
        <button class="btn small" id="btnJoinAsHost" disabled>Reprendre comme hôte</button>
      </div>
      <p class="info">Le dernier code s’affiche automatiquement lorsqu’il est disponible.</p>
    </section>

    <div class="footer">v3.3 • Esthétique mise à jour (fond sombre + texte blanc pur)</div>
  </main>
</body>
</html>
