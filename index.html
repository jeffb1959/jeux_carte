<!--
  Soirée de carte – INDEX (page 1)
  Version: v2.3 (2025-10-30)
  Auteur: Jean‑François + ChatGPT
  Objet: Page principale minimaliste + Firebase (auth anonyme + Firestore) + création de la soirée
         + Reprendre une soirée (joueur ou hôte)
  Changements v2.3:
    - Le premier nom saisi (ordre 0) est l’hôte et est marqué automatiquement comme confirmé (confirmed: true).
    - Reste du flux inchangé (redirection hôte vers attente_confirmantion.html?host=1).
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Soirée de carte – Index</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:color-mix(in srgb, var(--card) 92%, white 8%);border:1px solid #243252;border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:4px 0 0;font-size:1.8rem}
    h2{margin:0 0 6px;font-size:1.2rem;color:var(--muted)}
    .info{color:var(--muted);font-size:1rem;line-height:1.35}
    label{color:var(--muted);font-size:1.05rem}
    input[type="number"],textarea,input[type="tel"]{width:100%;font-size:1.2rem;padding:14px 16px;border-radius:14px;border:2px solid transparent;background:#0f1a30;color:var(--text);outline:none}
    input:focus,textarea:focus{border-color:var(--accent)}
    textarea{min-height:140px;resize:vertical}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:56px;padding:16px;border-radius:16px;font-size:1.25rem;font-weight:800;color:#0c111b;background:var(--accent)}
    .btn.small{min-height:48px;padding:12px;font-size:1.05rem}
    .grid{display:grid;gap:12px}
    .row{display:grid;gap:8px}
    .cols{display:grid;gap:12px}
    @media(min-width:640px){.cols{grid-template-columns:1fr 1fr}}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
    .ok{background:#0e2b1b;border:1px solid #1f6b3a;padding:10px;border-radius:12px;color:#d6ffe8;display:none}
    .footer{color:var(--muted);text-align:center;font-size:.95rem}
  </style>
  <!-- Firebase v11 (CDN modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === 1) CONFIG FIREBASE (fourni) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    // === 2) INIT APP/AUTH/DB ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Connexion anonyme
    signInAnonymously(auth).catch(err => {
      showError(`Auth anonyme impossible: ${err?.message||err}`);
    });

    onAuthStateChanged(auth, (user) => {
      if(!user) return;
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnJoinAsPlayer').disabled = false;
      document.getElementById('btnJoinAsHost').disabled = false;
    });

    // === 3) MIN UI (5 objets pour la création) ===
    window.addEventListener('DOMContentLoaded', () => {
      const nb   = document.getElementById('playersCount');
      const list = document.getElementById('playersNames');
      const btn  = document.getElementById('btnStart');

      // Validation douce des bornes (2..8)
      nb.addEventListener('change', () => {
        const v = Math.max(2, Math.min(8, parseInt(nb.value||'0',10)));
        nb.value = String(isNaN(v)?4:v);
      });

      btn.addEventListener('click', async () => {
        const n = Math.max(2, Math.min(8, parseInt(nb.value||'0',10)));
        // Normalise CRLF, découpe par 1+ sauts de ligne, trim, filtre vides
        const names = (list.value||'')
          .replace(/\r/g, '')
          .split(/\n+/)
          .map(s => s.trim())
          .filter(Boolean);
        if(names.length !== n){
          showError(`Veuillez entrer exactement ${n} nom(s), une ligne par nom.`);
          return;
        }
        // Génère code à 4 chiffres
        const code = String(Math.floor(1000 + Math.random()*9000));

        // Mémorise localement
        localStorage.setItem('sc_code', code);
        localStorage.setItem('sc_players', JSON.stringify(names));
        localStorage.setItem('sc_count', String(n));

        // Écrit dans Firestore (collection: soirees, doc: code)
        try{
          await setDoc(doc(db, 'soirees', code), {
            code,
            playerCount: n,
            // ✅ Hôte (ordre 0) confirmé automatiquement
            players: names.map((name, idx)=>({ name, order: idx, confirmed: idx === 0 })),
            status: 'setup',
            createdAt: serverTimestamp()
          });
          showOk(`Soirée #${code} créée. Ouverture de l'écran hôte…`);
          // L'hôte va directement sur la page d'attente (avec ?host=1)
          window.location.href = `attente_confirmantion.html?code=${code}&host=1`;
        }catch(err){
          showError(`Échec Firestore: ${err?.message||err}`);
        }
      });

      // Reprendre une soirée — rejoindre comme joueur ou comme hôte
      const codeInput = document.getElementById('resumeCode');
      const btnPlayer = document.getElementById('btnJoinAsPlayer');
      const btnHost   = document.getElementById('btnJoinAsHost');

      const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);

      btnPlayer.addEventListener('click', ()=>{
        const v = sanitizeCode(codeInput.value || localStorage.getItem('sc_code'));
        if(v.length!==4){ showError('Entrez un code à 4 chiffres pour rejoindre.'); return; }
        localStorage.setItem('sc_code', v);
        window.location.href = `confirmation_joueurs.html?code=${v}`;
      });

      btnHost.addEventListener('click', ()=>{
        const v = sanitizeCode(codeInput.value || localStorage.getItem('sc_code'));
        if(v.length!==4){ showError('Entrez un code à 4 chiffres pour reprendre comme hôte.'); return; }
        localStorage.setItem('sc_code', v);
        window.location.href = `attente_confirmantion.html?code=${v}&host=1`;
      });
    });

    // === Helpers min UI ===
    function showError(msg){ const b=document.getElementById('error'); b.textContent=msg; b.style.display='block'; document.getElementById('ok').style.display='none'; }
    function showOk(msg){ const b=document.getElementById('ok'); b.textContent=msg; b.style.display='block'; document.getElementById('error').style.display='none'; }

    // === Tests intégrés console (découpe noms + sanitize) ===
    (function runTests(){
      const assert=(c,m)=> c? console.log('✅',m):console.error('❌',m);
      let raw='A\nB\nC\nD';
      let names=raw.replace(/\r/g,'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      assert(names.length===4 && names[3]==='D', 'split \\n+ sur 4 lignes');
      raw='A\r\nB\r\nC';
      names=raw.replace(/\r/g,'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      assert(names.length===3 && names[1]==='B', 'support CRLF');
      raw='A\n\nB';
      names=raw.replace(/\r/g,'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      assert(names.length===2 && names[1]==='B', 'ignorer lignes vides');
      const s=(x)=>String(x).replace(/\D/g,'').slice(0,4);
      assert(s('12a34')==='1234','sanitize 12a34 → 1234');
      assert(s('9 8 7 6')==='9876','sanitize 9 8 7 6 → 9876');
      assert(s('12345')==='1234','sanitize coupe à 4');
    })();
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card grid">
      <!-- (1) Titre -->
      <h1>Soirée de carte</h1>

      <!-- (2) Informations -->
      <p class="info">Inscrire le nom des joueurs.<br>
      Veuillez inscrire le nom des joueurs en commençant par le maître du jeu, puis dans le sens des aiguilles d’une montre. L’ordre déterminera l’ordre de jeu.</p>

      <!-- (3) Case nombre de joueurs (min 2, max 8, défaut 4) -->
      <label for="playersCount">Nombre de joueurs</label>
      <input id="playersCount" type="number" min="2" max="8" value="4" inputmode="numeric" />

      <!-- (4) Case noms (une ligne par nom) -->
      <label for="playersNames">Noms ou surnoms (une ligne par nom)</label>
      <textarea id="playersNames" placeholder="Ex.\nJean‑François (hôte)\nLise\nMarc\nLouise"></textarea>

      <!-- (5) Bouton Débuter la soirée → écran hôte -->
      <button class="btn" id="btnStart" disabled>Débuter la soirée</button>

      <!-- Zones messages -->
      <div id="error" class="err" role="alert"></div>
      <div id="ok" class="ok" role="status"></div>
    </section>

    <!-- Bloc Reprendre une soirée -->
    <section class="card grid">
      <h2>Reprendre une soirée</h2>
      <div class="row">
        <label for="resumeCode">Code de la soirée (4 chiffres)</label>
        <input id="resumeCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Ex.: 1234" />
      </div>
      <div class="cols">
        <button class="btn small" id="btnJoinAsPlayer" disabled>Rejoindre comme joueur</button>
        <button class="btn small" id="btnJoinAsHost" disabled>Reprendre comme hôte</button>
      </div>
      <p class="info">Astuce : si le code est vide, on utilisera le dernier code mémorisé sur cet appareil.</p>
    </section>

    <div class="footer">v2.3 • Page minimale • Firestore (setup) • Auth anonyme • Reprise intégrée • Hôte auto‑confirmé</div>
  </main>
</body>
</html>
