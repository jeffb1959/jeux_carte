<!--
  index.html â€“ Accueil de l'application "Jeux de cartes"
  Version : 3.1 (2025-10-31)
  Correctifs :
    - Redirection vers attente_confirmation.html (orthographe corrigÃ©e)
    - Connexion Firebase anonyme (auth ready avant action)
    - VÃ©rification du code avant crÃ©ation de soirÃ©e
    - Interface Ã©purÃ©e et lisible sur mobile
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeux de cartes â€“ Accueil</title>

  <style>
    :root{
      --bg:#0b1220;--card:#111a2e;--text:#f5f7fb;
      --muted:#b9c2d0;--accent:#4fd1c5;--error:#f87171;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    main{display:grid;place-items:center;height:100%;padding:20px;}
    .card{background:color-mix(in srgb,var(--card) 92%,white 8%);
      border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.25);
      padding:28px;max-width:420px;width:100%;text-align:center;}
    h1{margin:0 0 10px;font-size:1.8rem;}
    p{color:var(--muted);margin:4px 0 20px;}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid #243252;background:#0f1a30;color:var(--text);font-size:1rem;text-align:center;}
    button{width:100%;margin-top:12px;padding:12px 0;border:none;border-radius:8px;background:var(--accent);color:#000;font-weight:600;font-size:1rem;cursor:pointer;}
    button:hover{opacity:.9;}
    .link{color:var(--accent);cursor:pointer;text-decoration:none;}
    .muted{color:var(--muted);}
    .error{color:var(--error);font-size:.9rem;margin-top:6px;}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    let userReady = false;
    let currentUser = null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ await signInAnonymously(auth); return; }
      currentUser = user;
      userReady = true;
      $("status").textContent = "ConnectÃ©";
      $("status").style.color = "var(--accent)";
      $("btnHost").disabled = false;
      $("btnJoin").disabled = false;
    });

    function randCode(){
      return Math.floor(1000 + Math.random()*9000).toString();
    }

    async function createSoiree(){
      if(!userReady) return alert("Connexion en cours...");
      const code = randCode();
      const ref = doc(db, "soirees", code);
      await setDoc(ref,{
        code,
        playerCount: 1,
        players: [{ order:0, name:"HÃ´te", confirmed:true, uid:currentUser.uid }],
        status: "open",
        createdAt: serverTimestamp()
      });
      localStorage.setItem("sc_code", code);
      window.location.href = `attente_confirmation.html?code=${code}&host=1`;
    }

    async function joinSoiree(){
      if(!userReady) return alert("Connexion en cours...");
      const code = $("codeInput").value.trim();
      if(!/^[0-9]{4}$/.test(code)){
        $("errorMsg").textContent = "Code invalide (4 chiffres)";
        return;
      }
      $("errorMsg").textContent = "";
      const ref = doc(db,"soirees",code);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        $("errorMsg").textContent = "Aucune soirÃ©e trouvÃ©e avec ce code";
        return;
      }
      window.location.href = `confirmation_joueurs.html?code=${code}`;
    }

    window.onload = ()=>{
      $("btnHost").addEventListener("click", createSoiree);
      $("btnJoin").addEventListener("click", joinSoiree);
    };
  </script>
</head>

<body>
  <main>
    <div class="card">
      <h1>SoirÃ©e de cartes</h1>
      <p class="muted">Bienvenue&nbsp;! Connectez-vous pour crÃ©er ou rejoindre une soirÃ©e.</p>

      <button id="btnHost" disabled>âž• Nouvelle soirÃ©e</button>

      <p style="margin:20px 0 10px;">ou</p>

      <input id="codeInput" maxlength="4" placeholder="Code Ã  4 chiffres" />
      <button id="btnJoin" disabled>ðŸŽ¯ Rejoindre</button>
      <div id="errorMsg" class="error"></div>

      <p id="status" class="muted" style="margin-top:20px;">Connexionâ€¦</p>
      <p class="muted" style="margin-top:8px;font-size:.85rem;">v3.1 â€¢ Firebase + Auth anonyme</p>
    </div>
  </main>
</body>
</html>
