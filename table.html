<!-- v1.2 – 2025-11-02 – Bouton "Fin de partie" (brasseur) avec sélection du gagnant via modal -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Table de jeu</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --line:#243252; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:rgba(17,26,46,0.85);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(4px)}
    header{display:flex;align-items:baseline;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:clamp(22px,5vw,28px)}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1a30}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}

    ul{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    li{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    .name{font-size:clamp(16px,4vw,20px)}
    .tag{font-size:.95rem}
    .me{color:#4fd1c5}
    .turn{color:#fbbf24}

    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:14px;font-weight:800;background:var(--accent);color:#0b1220;min-height:48px}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .footer{color:var(--muted);text-align:center}

    /* Modal gagnant */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{max-width:520px;width:100%;background:#101a2f;border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:16px}
    .modal h2{margin:0 0 10px;font-size:1.4rem}
    .winner-grid{display:grid;gap:8px}
    .winner-btn{display:flex;justify-content:space-between;align-items:center;width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:#0f1a30;color:var(--text);font-weight:700;cursor:pointer}
    .close-x{background:transparent;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const qs = (k)=>new URLSearchParams(location.search).get(k);
    const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);

    function getDeviceId(){
      const key = 'sc_deviceId';
      let id = localStorage.getItem(key);
      if(!id){ id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=> (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)); localStorage.setItem(key,id); }
      return id;
    }

    let code = sanitizeCode(qs('code') || localStorage.getItem('sc_code'));
    const DEVICE_ID = getDeviceId();
    let IS_DEALER = false;
    let CURRENT_PLAYERS = [];

    async function ensureCode(){ if(code){ return code; } location.href = 'index.html'; }

    function renderState(data){
      $('code').textContent = code;
      const status = String(data.status||'setup');
      $('status').textContent = status;

      const players = Array.isArray(data.players)? data.players.slice():[];
      CURRENT_PLAYERS = players.slice();
      const dealerId = data.dealerDeviceId || null;
      IS_DEALER = !!dealerId && dealerId === DEVICE_ID;

      const list = $('players'); list.innerHTML = '';
      players.sort((a,b)=>(a.order??0)-(b.order??0)).forEach(p=>{
        const li = document.createElement('li');
        const isMe = p.deviceId && p.deviceId === DEVICE_ID;
        const tags = [];
        if(isMe) tags.push('<span class="tag pill me">Moi</span>');
        if(p.confirmed) tags.push('<span class="tag pill">Confirmé</span>');
        li.innerHTML = `<span class="name">${esc(p.name||'Joueur')}</span><span>${tags.join(' ')}</span>`;
        list.appendChild(li);
      });

      $('dealer').textContent = data.dealerName || '';

      // Afficher/masquer le bouton Fin de partie pour le brasseur uniquement
      const endBtn = $('btnEndGame');
      endBtn.style.display = IS_DEALER ? 'inline-flex' : 'none';
      endBtn.setAttribute('aria-hidden', IS_DEALER ? 'false' : 'true');
    }

    function goSelection(){ location.href = `selection_jeux.html?code=${code}`; }
    function goIndex(){ location.href = `index.html`; }

    async function toggleReady(){
      try{
        const ref = doc(db,'soirees', code);
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const data = snap.data();
        const arr = Array.isArray(data.players)? data.players.slice():[];
        const i = arr.findIndex(p=> p && p.deviceId === DEVICE_ID);
        if(i>-1){ arr[i] = { ...arr[i], ready: !arr[i]?.ready } }
        await updateDoc(ref, { players: arr });
      }catch(e){ console.warn(e); }
    }

    // --- Fin de partie (modal gagnant) ---
    function openWinnerModal(){
      if(!IS_DEALER){ return; }
      const modal = $('winnerModal');
      const list = $('winnerList');
      list.innerHTML = '';
      CURRENT_PLAYERS
        .filter(p=>p && p.confirmed)
        .sort((a,b)=>(a.order??0)-(b.order??0))
        .forEach((p,idx)=>{
          const btn = document.createElement('button');
          btn.className = 'winner-btn';
          btn.setAttribute('data-idx', String(idx));
          btn.innerHTML = `<span>${esc(p.name||'Joueur')}</span><span class="pill">Choisir</span>`;
          btn.addEventListener('click', ()=> endGameWithWinner(p));
          list.appendChild(btn);
        });
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      $('closeModal').focus();
    }

    function closeWinnerModal(){
      const modal = $('winnerModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      $('btnEndGame').focus();
    }

    async function endGameWithWinner(player){
      if(!IS_DEALER) return;
      if(!player?.deviceId){ alert('Joueur invalide'); return; }
      try{
        const ref = doc(db,'soirees', code);
        await updateDoc(ref, { lastWinnerDeviceId: player.deviceId, status: 'ended' });
        closeWinnerModal();
        alert(`Partie terminée. Le gagnant est « ${player.name||'Joueur'} ». Il sera brasseur pour la prochaine partie.`);
      }catch(e){ alert(e?.message||e); }
    }

    // Accessibilité: fermer le modal avec ESC ou clic fond
    function bindModalAccessibility(){
      $('winnerModal').addEventListener('click', (e)=>{ if(e.target === $('winnerModal')) closeWinnerModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && $('winnerModal').style.display==='flex') closeWinnerModal(); });
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      await ensureCode();
      $('btnBack').addEventListener('click', goSelection);
      $('btnHome').addEventListener('click', goIndex);
      $('btnReady').addEventListener('click', toggleReady);
      $('btnEndGame').addEventListener('click', openWinnerModal);
      $('closeModal').addEventListener('click', closeWinnerModal);
      bindModalAccessibility();

      const ref = doc(db,'soirees', code);
      onSnapshot(ref, (snap)=>{
        if(!snap.exists()){ $('status').textContent='introuvable'; return; }
        renderState(snap.data());
      });
    });
  </script>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>Table de jeu <span class="muted">#<span id="code">----</span></span></h1>
      <div class="pill" aria-live="polite">Statut : <span id="status">chargement…</span></div>
    </header>

    <section class="card row" aria-labelledby="lblJoueurs">
      <div>
        <div id="lblJoueurs" class="muted" style="margin-bottom:8px">Joueurs (ordre de jeu)</div>
        <ul id="players" aria-live="polite"></ul>
      </div>
      <div>
        <div class="muted" style="margin-bottom:8px">Brasseur</div>
        <div class="pill" id="dealer">—</div>
        <div class="actions" style="margin-top:12px">
          <button id="btnReady" class="btn" aria-label="Je suis prêt">Je suis prêt</button>
          <button id="btnBack" class="btn ghost" aria-label="Retour au choix du jeu">Retour</button>
          <button id="btnHome" class="btn ghost" aria-label="Accueil">Accueil</button>
          <button id="btnEndGame" class="btn danger" aria-label="Fin de partie (choisir le gagnant)" style="display:none">Fin de partie</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="muted">Zone de jeu</div>
      <p style="margin:8px 0 0">Ici s’afficheront les composantes spécifiques au jeu choisi (Dame de pique, Chialeux, Jeu du 9…).</p>
    </section>

    <div class="footer">v1.2 • Bouton Fin de partie (brasseur) → sélection gagnant via modal → lastWinnerDeviceId + status: ended</div>
  </main>

  <!-- Modal sélection du gagnant -->
  <div id="winnerModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="winnerTitle">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px">
        <h2 id="winnerTitle" style="margin:0">Sélectionner le gagnant</h2>
        <button id="closeModal" class="close-x" aria-label="Fermer">Fermer</button>
      </div>
      <p class="muted" id="winnerDesc" style="margin-top:0">Choisis le gagnant de la manche. Il sera le <b>brasseur</b> pour la prochaine partie.</p>
      <div id="winnerList" class="winner-grid" aria-describedby="winnerDesc"></div>
    </div>
  </div>
</body>
</html>
