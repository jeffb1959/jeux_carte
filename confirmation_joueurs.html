<!-- v2.16 – 2025-11-02 – Correction "Soirée introuvable"
CAUSE: v2.15 lisait la collection `soirees` + un tableau `players`.
FIX: utilisation de `sessions/{code}` + sous-collection `players` (ordre par seatIndex), auth anonyme avant lecture.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Soirée de carte – Confirmation</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; --line:#243252; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220 url('https://jads.ca/image/fond_jeep.webp') center/cover no-repeat fixed;color:var(--text)}
    .wrap{max-width:680px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .card{background:rgba(17,26,46,0.85);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(4px)}
    h1{margin:4px 0 0;font-size:1.7rem}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:12px;font-weight:700;background:var(--accent);color:#0c111b}
    .btn.small{padding:8px 12px}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    ul{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    li{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1a30}
    .ok{color:#22c55e}
    .warn{color:#f59e0b}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const $  = (id)=>document.getElementById(id);
    const CODE = (new URLSearchParams(location.search).get('code')||'').replace(/\D/g,'').slice(0,4);

    function showError(msg){ const e=$('error'); e.textContent=msg; e.style.display='block'; }
    function clearError(){ const e=$('error'); e.style.display='none'; }

    function esc(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function getDeviceId(){ const k='sc_deviceId'; let id=localStorage.getItem(k); if(!id){ id=crypto.randomUUID(); localStorage.setItem(k,id);} return id; }
    const DEVICE_ID = getDeviceId();

    async function ensureAuth(){
      return new Promise(async (resolve)=>{
        if (auth.currentUser) return resolve(auth.currentUser);
        const stop = onAuthStateChanged(auth,(u)=>{ if(u){ stop(); resolve(u);} });
        try{ await signInAnonymously(auth); }catch{ resolve(null); }
      });
    }

    async function init(){
      if (!/^\d{4}$/.test(CODE)){ showError('Code manquant ou invalide.'); return; }
      $('code').textContent = CODE;

      await ensureAuth();

      // 1) Vérifie l'existence de sessions/{code}
      const sessionRef = doc(db,'sessions', CODE);
      const sessionSnap = await getDoc(sessionRef);
      if(!sessionSnap.exists()){
        showError("Soirée introuvable. Demandez à l'hôte de finaliser l'inscription des joueurs.");
        return;
      }

      // 2) Stream de la liste des joueurs: sessions/{code}/players (ordre horaire)
      const playersQ = query(collection(db,'sessions', CODE, 'players'), orderBy('seatIndex','asc'));
      onSnapshot(playersQ, (snap)=>{
        const ul = $('players');
        ul.innerHTML = '';
        if (snap.empty){
          const li = document.createElement('li');
          li.textContent = "Aucun joueur saisi pour le moment...";
          ul.appendChild(li);
          return;
        }
        const mine = { has:false, name:'' };
        const items = [];
        snap.forEach((d)=>{ const p={ id:d.id, ...d.data() }; items.push(p); if(p.deviceId===DEVICE_ID){ mine.has=true; mine.name=p.name; } });
        items.forEach((p,i)=>{
          const li = document.createElement('li');
          const left = document.createElement('span');
          left.innerHTML = `<strong>${esc(p.name||`Joueur ${i+1}`)}</strong> <span class="muted">(siège ${p.seatIndex})</span>`;
          const btn = document.createElement('button');
          const locked = p.deviceId && p.deviceId !== DEVICE_ID;
          const alreadyMine = p.deviceId === DEVICE_ID;
          btn.textContent = alreadyMine ? 'Appareil lié' : (locked ? 'Déjà pris' : "C'est moi");
          btn.disabled = locked || alreadyMine || (mine.has && !alreadyMine);
          btn.className = 'btn small';
          btn.onclick = ()=> claimPlayer(p);
          li.appendChild(left);
          li.appendChild(btn);
          ul.appendChild(li);
        });
        clearError();
      }, (err)=> showError('Erreur de lecture: '+(err?.message||err)) );
    }

    async function claimPlayer(player){
      try{
        await ensureAuth();
        // Empêche qu'un même appareil prenne 2 joueurs (validation côté client sur l'état courant)
        const ul = $('players');
        const already = Array.from(ul.querySelectorAll('button')).some(b=> b.textContent==='Appareil lié');
        if (already) { showError('Votre appareil est déjà lié à un joueur.'); return; }

        const ref = doc(db,'sessions', CODE, 'players', player.id);
        await updateDoc(ref, { deviceId: DEVICE_ID, uid: auth.currentUser?.uid || null, confirmed: true, confirmedAt: serverTimestamp() });
        await setDoc(doc(db,'roles', auth.currentUser.uid), { role:'player', sessionCode: CODE }, { merge:true });
        clearError();
      }catch(e){ showError('Impossible de confirmer : '+(e?.message||e)); }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Confirmer ma présence – Code <span class="pill" id="code">----</span></h1>
      <p class="muted">Clique sur ton nom pour te confirmer. Un appareil ne peut confirmer <b>qu’un</b> joueur.</p>
      <ul id="players"></ul>
      <div id="error" class="err" role="alert"></div>
    </section>
    <div class="footer" style="text-align:center;color:var(--muted)">v2.16 • sessions/{code}/players • auth d’abord • correctif "Soirée introuvable"</div>
  </main>
</body>
</html>
