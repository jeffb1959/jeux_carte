<!-- v3.0 – 2025-11-02 – Version de référence stable, restaurée depuis v2.15 -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Soirée de carte – Confirmation</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; --line:#243252; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220 url('https://jads.ca/image/fond_jeep.webp') center/cover no-repeat fixed;color:var(--text)}
    .wrap{max-width:680px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .card{background:rgba(17,26,46,0.85);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(4px)}
    h1{margin:4px 0 0;font-size:1.7rem}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:12px;font-weight:700;background:var(--accent);color:#0c111b}
    .btn.small{padding:8px 12px}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    ul{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    li{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1a30}
    .ok{color:#22c55e}
    .warn{color:#f59e0b}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db  = getFirestore(app);

    const qs   = new URLSearchParams(location.search);
    const CODE = (qs.get('code') || localStorage.getItem('sc_code') || '').replace(/\D/g,'').slice(0,4);
    if(!CODE){ alert('Code de soirée manquant'); }

    const $  = (id)=>document.getElementById(id);
    const esc = (s)=>String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    function getDeviceId(){
      const key = 'sc_deviceId';
      let id = localStorage.getItem(key);
      if(!id){
        id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=> (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16));
        localStorage.setItem(key,id);
      }
      return id;
    }
    const DEVICE_ID = getDeviceId();

    function allConfirmed(data){
      const players = Array.isArray(data.players)? data.players: [];
      const expected = Number(data.playerCount||players.length)||players.length;
      if(players.length < expected) return false;
      return expected>0 && players.filter(p=>p && p.confirmed===true).length === expected;
    }

    function render(players){
      const list = $('players');
      list.innerHTML = '';
      const myIdx = players.findIndex(p=> p && p.deviceId === DEVICE_ID);
      players.slice().sort((a,b)=>(a.order??0)-(b.order??0)).forEach((p,i)=>{
        const li = document.createElement('li');
        const name = esc(p.name || `Joueur ${i+1}`);
        const isMine  = p.deviceId === DEVICE_ID;
        const claimed = !!p.deviceId;
        const right = p.confirmed
          ? `<span class="pill ok">Confirmé ✓${isMine?' (mon appareil)':''}</span>`
          : (isMine
              ? `<button class="btn small" data-idx="${i}" data-act="confirm">C’est moi</button>`
              : (!claimed && (myIdx === -1)
                  ? `<button class="btn small" data-idx="${i}" data-act="confirm">C’est moi</button>`
                  : `<span class="pill">Réservé</span>`));
        li.innerHTML = `<span>${name}</span><span>${right}</span>`;
        list.appendChild(li);
      });
      list.querySelectorAll('button[data-act="confirm"]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const idx = Number(btn.getAttribute('data-idx'));
          await confirmIndex(idx);
        });
      });
    }

    async function confirmIndex(idx){
      const ref = doc(db,'soirees', CODE);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error('Soirée introuvable');
      const data = snap.data();
      const players = Array.isArray(data.players)? data.players.slice():[];

      const myIdx = players.findIndex(p => p && p.deviceId === DEVICE_ID);
      if(myIdx !== -1 && myIdx !== idx){ $('error').style.display='block'; $('error').textContent = 'Cet appareil est déjà associé à un autre joueur.'; return; }
      if(players[idx]?.deviceId && players[idx].deviceId !== DEVICE_ID){ $('error').style.display='block'; $('error').textContent = 'Ce nom est déjà confirmé ailleurs.'; return; }

      try{ await signInAnonymously(auth); }catch{}
      const uid = auth.currentUser?.uid || null;

      players[idx] = { ...players[idx], deviceId: DEVICE_ID, uid, confirmed: true };
      await updateDoc(ref, { players });
      $('error').style.display='none';

      const afterSnap = await getDoc(ref);
      const afterData = afterSnap.data();
      if(allConfirmed(afterData) && String(afterData.status) !== 'playing'){
        await updateDoc(ref, { status: 'playing' });
      }
    }

    let unwatch = null;
    async function start(){
      $('code').textContent = CODE;
      try{ await signInAnonymously(auth); }catch{}
      if(unwatch) unwatch();
      const ref = doc(db,'soirees', CODE);
      unwatch = onSnapshot(ref, (snap)=>{
        if(!snap.exists()){ $('error').style.display='block'; $('error').textContent='Soirée introuvable.'; return; }
        const data = snap.data();
        if(String(data.status)==='playing'){
          window.location.href = `Selection_Jeux.html?code=${CODE}`;
          return;
        }
        const players = Array.isArray(data.players)? data.players : [];
        render(players);
      }, (err)=>{
        $('error').style.display='block'; $('error').textContent = 'Erreur: '+(err?.message||err);
      });
    }

    window.addEventListener('DOMContentLoaded', start);
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Confirmer ma présence – Code <span class="pill" id="code">----</span></h1>
      <p class="muted">Clique sur ton nom pour te confirmer. Un appareil ne peut confirmer <b>qu’un</b> joueur.</p>
      <ul id="players"></ul>
      <div id="error" class="err" role="alert"></div>
    </section>
    <div class="footer" style="text-align:center;color:var(--muted)">v3.0 • Référence stable restaurée (base Firestore complète)</div>
  </main>
</body>

</html>
