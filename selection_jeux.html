<!-- v1.6 – 2025-11-02 – Auth+Functions; priorité gagnant; dealerUid; CF chooseGame; roulette + privilèges brasseur -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Sélection du jeu</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text);transition:background-color .3s ease}
    body.is-dealer{ background:#000; }
    body.is-not{ background:#3a0b0b; }
    .wrap{max-width:640px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:color-mix(in srgb, var(--card) 92%, white 8%);border:1px solid #243252;border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:4px 0 0;font-size:1.8rem}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:64px;padding:18px;border-radius:16px;font-size:1.25rem;font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.55;filter:grayscale(.7);cursor:not-allowed}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
    .footer{color:var(--muted);text-align:center;font-size:.95rem}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #243252;background:#0f1a30}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";
    import { getFirestore, doc, getDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg", authDomain: "soireecartev2.firebaseapp.com", projectId: "soireecartev2" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    const db  = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const qs = (k)=>new URLSearchParams(location.search).get(k);
    const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);
    const CODE = sanitizeCode(qs('code') || localStorage.getItem('sc_code'));

    function getDeviceId(){
      const key = 'sc_deviceId';
      let id = localStorage.getItem(key);
      if(!id){ id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=> (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)); localStorage.setItem(key,id); }
      return id;
    }
    const DEVICE_ID = getDeviceId();

    async function ensureDealer(){
      const ref = doc(db,'soirees', CODE);
      return await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error('Soirée introuvable');
        const data = snap.data()||{};
        if(data.dealerDeviceId){ return { ...data, already:true }; }
        const status = String(data.status||'setup');
        if(status !== 'playing'){ return { ...data, already:true }; }
        const players = Array.isArray(data.players)? data.players.filter(p=>p && p.confirmed):[];
        if(players.length===0) return { ...data, already:true };
        // 1) Priorité au vainqueur précédent
        if(data.lastWinnerDeviceId){
          const w = players.find(p=> p.deviceId === data.lastWinnerDeviceId);
          if(w){
            const payload = { dealerDeviceId: w.deviceId||null, dealerUid: w.uid||null, dealerName: w.name||'Brasseur', dealerOrder: w.order??null, gameNumber: (data.gameNumber||0)+1, dealerChosenAt: Date.now() };
            tx.update(ref, payload);
            return { ...data, ...payload, already:false };
          }
        }
        // 2) Sinon tirage au sort
        const rnd = Math.floor(Math.random()*players.length);
        const chosen = players[rnd];
        const payload = { dealerDeviceId: chosen.deviceId||null, dealerUid: chosen.uid||null, dealerName: chosen.name||'Brasseur', dealerOrder: chosen.order??null, gameNumber: (data.gameNumber||0)+1, dealerChosenAt: Date.now() };
        tx.update(ref, payload);
        return { ...data, ...payload, already:false };
      });
    }

    function rouletteEffect(isDealer){
      const body = document.body; let steps = 16; let delay = 90; let col = true;
      const tick = ()=>{ body.style.background = col ? '#7a0d0d' : '#000000'; col = !col; steps--; delay = Math.round(delay * 1.25); if(steps>0){ setTimeout(tick, delay);} else { body.classList.toggle('is-dealer', !!isDealer); body.classList.toggle('is-not', !isDealer);} };
      tick();
    }

    async function choose(game){
      const call = httpsCallable(functions, 'chooseGame');
      try{ await call({ code: CODE, game }); location.href = `${game}.html?code=${CODE}`; }
      catch(e){ alert(e?.message||e); }
    }

    async function boot(){
      if(!CODE){ alert('Code manquant'); location.href='index.html'; return; }
      $('titleCode').textContent = `#${CODE}`;
      try{ await signInAnonymously(auth); }catch{}

      // Assurer un brasseur si nécessaire
      let data = await ensureDealer();
      const isDealer = !!data.dealerDeviceId && data.dealerDeviceId === DEVICE_ID;

      // Effet roulette (1ère fois par partie+appareil)
      const rollKey = `sc_roll_done_${CODE}_${data.gameNumber||'0'}`;
      const firstTime = !localStorage.getItem(rollKey);
      if(firstTime){ try{ if(navigator.vibrate) navigator.vibrate([30,30,60]); }catch{} rouletteEffect(isDealer); localStorage.setItem(rollKey,'1'); }
      else{ document.body.classList.toggle('is-dealer', !!isDealer); document.body.classList.toggle('is-not', !isDealer); }

      // Désactiver boutons si non brasseur
      const buttons = ['btnDP','btnCH','btnJ9'].map($); buttons.forEach(b=>{ if(!b) return; b.disabled = !isDealer; });

      // Navigation via CF (sécurisée)
      $('btnDP').addEventListener('click', ()=> choose('dame_de_pique'));
      $('btnCH').addEventListener('click', ()=> choose('chialeux'));
      $('btnJ9').addEventListener('click', ()=> choose('jeu_du_9'));

      // Affichage du brasseur
      $('dealer').textContent = data.dealerName ? `${data.dealerName}` : (isDealer? 'Moi' : '—');
      $('role').textContent = isDealer ? 'Tu es le brasseur — choisis le jeu' : 'En attente du choix du brasseur';
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card grid">
      <h1>Sélectionner le type de jeu <span class="muted" id="titleCode"></span></h1>
      <div><span class="pill">Brasseur : <b id="dealer">—</b></span></div>
      <div class="muted" id="role"></div>
      <button id="btnDP" class="btn">Dame de pique</button>
      <button id="btnCH" class="btn">Le chialeux</button>
      <button id="btnJ9" class="btn">Jeu du 9</button>
      <div id="error" class="err" role="alert"></div>
    </section>
    <div class="footer">v1.6 • Auth+Functions • Gagnant prioritaire • Roulette • Boutons brasseur uniquement</div>
  </main>
</body>
</html>
