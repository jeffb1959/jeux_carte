<!-- Version: v4.3.7 (2025-11-04) -->
<!-- v4.3.3 Jeux actifs uniquement sur l'appareil du brasseur + badge visuel -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Sélection du jeu</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; --ok:#22c55e; --line:#243252; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:color-mix(in srgb, var(--card) 92%, white 8%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:4px 0 8px;font-size:1.8rem}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:64px;padding:18px;border-radius:16px;font-size:1.1rem;font-weight:800;color:#0c111b;background:var(--accent);transition:opacity .2s ease}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.green{background:var(--ok);color:#06210f}
    .row{display:grid;gap:10px}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
    .footer{color:var(--muted);text-align:center;font-size:.95rem}
    /* Badge & style brasseur */
    .btn.leader{ background: rgba(239,68,68,0.20); border:1px solid rgba(239,68,68,0.45); }
    .badge{ display:inline-block; margin-left:10px; padding:4px 8px; border-radius:999px; font-size:.85rem; font-weight:700; background:#fecaca; color:#7f1d1d; vertical-align:middle }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, addDoc, onSnapshot, deleteField } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const qs = (k)=>new URLSearchParams(location.search).get(k);
    const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);

    // Identifiant d'appareil (persisté localement)
    function getDeviceId(){
      let id = localStorage.getItem('deviceId') || localStorage.getItem('mgm_deviceId');
      if(!id){
        if (window.crypto?.randomUUID){ id = crypto.randomUUID(); }
        else { id = 'did_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }
        localStorage.setItem('deviceId', id);
      }
      return id;
    }

    async function ensureAuth(){ try{ await signInAnonymously(auth);}catch(e){ console.warn('Auth anonyme échouée', e); } }catch(e){} }

    let code = sanitizeCode(qs('code') || localStorage.getItem('sc_code'));

    // Compteur de rendu pour éviter les états vides persistants
    let _renderedCount = -1;

    // Rendu des joueurs (utilitaire centralisé)
    function renderPlayers(arr){
      const zone = $('playersBtns');
      if(!zone) return;
      zone.innerHTML = '';
      (arr||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.textContent = p?.name || `Joueur ${idx+1}`;
        btn.dataset.playerIndex = String(idx);
        btn.addEventListener('click', ()=> selectDealer(idx, p));
        zone.appendChild(btn);
      });
    }

    // Rendu des joueurs (utilitaire centralisé)
    function renderPlayers(arr){
      const zone = $('playersBtns');
      if(!zone) return;
      zone.innerHTML = '';
      (arr||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.textContent = p?.name || `Joueur ${idx+1}`;
        btn.dataset.playerIndex = String(idx);
        btn.addEventListener('click', ()=> selectDealer(idx, p));
        zone.appendChild(btn);
      });
    }

    function disableGameButtons(disabled=true){ ['btnDP','btnCH','btnJ9'].forEach(id=>{ const b=$(id); if(b){ b.disabled = disabled; }}); }
    function setPlayersButtonsEnabled(enabled){
      const container = $('playersBtns'); if(!container) return;
      [...container.querySelectorAll('button[data-player-index]')].forEach(b=> b.disabled = !enabled);
    }

    function renderLeaderDecor(data){
      const container = $('playersBtns'); if(!container) return;
      const leaderIdx = (typeof data?.leaderIndex === 'number') ? data.leaderIndex : null;
      [...container.querySelectorAll('button[data-player-index]')].forEach(b=>{
        b.classList.remove('leader');
        const old = b.querySelector('.badge'); if(old) old.remove();
      });
      if(leaderIdx!==null){
        const btn = container.querySelector(`button[data-player-index="${leaderIdx}"]`);
        if(btn){
          btn.classList.add('leader');
          const tag = document.createElement('span'); tag.className='badge'; tag.textContent='Brasseur';
          btn.appendChild(tag);
        }
      }
    }

    function applyLeaderState(data){
      const hasLeader = (typeof data?.leaderIndex === 'number');
      renderLeaderDecor(data);
      if(hasLeader){
        setPlayersButtonsEnabled(false);
        const isLeaderHere = data?.leaderDeviceId && data.leaderDeviceId === getDeviceId();
        disableGameButtons(!isLeaderHere);
      }else{
        setPlayersButtonsEnabled(true);
        disableGameButtons(true);
      }
    }

    async function loadPlayers(){
      const ref = doc(db,'soirees', code);
      const snap = await getDoc(ref);
      if(!snap.exists()){ showError('Soirée introuvable.'); return; }
      const data = snap.data();
      const players = Array.isArray(data.players)? data.players : [];
      const tc=$('titleCode'); if(tc) tc.textContent = `#${code}`;
      renderPlayers(players);
      applyLeaderState(data);
    }
      const data = snap.data();
      const players = Array.isArray(data.players)? data.players : [];

      $('titleCode').textContent = `#${code}`;
      const zone = $('playersBtns');
      zone.innerHTML = '';
      players.sort((a,b)=> (a?.order??0) - (b?.order??0)).forEach((p, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.textContent = p?.name || `Joueur ${idx+1}`;
        btn.dataset.playerIndex = String(idx);
        btn.addEventListener('click', ()=> selectDealer(idx, p));
        zone.appendChild(btn);
      });

      applyLeaderState(data);
    }

    async function selectDealer(index, player){
      // Désactive localement la sélection; l'activation des jeux sera gérée par l'écoute temps réel
      setPlayersButtonsEnabled(false);
      disableGameButtons(true);
      try{
        const soireeRef = doc(db,'soirees', code);
        // RELIRE le document pour obtenir la version la plus à jour du deviceId du joueur sélectionné
        const snap = await getDoc(soireeRef);
        let leaderDid = null;
        if(snap.exists()){
          const d = snap.data();
          const arr = Array.isArray(d.players) ? d.players : [];
          const p = arr[index];
          leaderDid = p?.deviceId || null;
          // Petit log d'aide
          console.log('[selectDealer] selected index=', index, 'name=', p?.name || player?.name, 'leaderDeviceId=', leaderDid);
        }
        await updateDoc(soireeRef, {
          leaderIndex: index,
          leaderName: player?.name || null,
          leaderDeviceId: leaderDid, // peut être null si l'appareil du joueur n'est pas encore lié
          leaderAt: serverTimestamp()
        });
      }catch(e){ console.warn('Erreur Firestore',e); }
    }

    async function startGameWithLeader(gameType){
      const soireeRef = doc(db,'soirees', code);
      const snap = await getDoc(soireeRef);
      if(!snap.exists()){ showError('Soirée introuvable'); return; }
      const s = snap.data();

      const colName = gameType === 'dame_de_pique' ? 'scores_dame_de_pique'
                    : gameType === 'chialeux'     ? 'scores_chialeux'
                    :                               'scores_jeu_du_9';

      const scoreRef = await addDoc(collection(db, colName), {
        code,
        leaderDeviceId: s.leaderDeviceId || null,
        leaderName: s.leaderName || null,
        leaderIndex: (typeof s.leaderIndex === 'number') ? s.leaderIndex : null,
        startedAt: serverTimestamp(),
        state: 'in_progress'
      });

      // Écrit le jeu courant pour déclencher la redirection simultanée sur tous les appareils
      await updateDoc(soireeRef, {
        currentGame: { type: gameType, gid: scoreRef.id, at: serverTimestamp() }
      });

      // Redirection immédiate locale (les autres appareils suivront via onSnapshot)
      const target = gameType === 'dame_de_pique' ? 'dame_de_pique.html'
                    : gameType === 'chialeux'     ? 'chialeux.html'
                    :                               'jeu_du_9.html';
      location.href = `${target}?code=${code}&gid=${scoreRef.id}`;
    }

    async function resetDealer(){(){
      try{
        const ref = doc(db,'soirees', code);
        await updateDoc(ref, {
          leaderIndex: deleteField(),
          leaderName: null,
          leaderDeviceId: null,
          leaderAt: deleteField()
        });
      }catch(e){ console.warn('resetDealer update failed', e); }
      // L'écoute temps réel supprimera le badge et réinitialisera l'UI
    }

    function showError(msg){ const e=$('error'); if(!e) return; e.style.display='block'; e.textContent=msg; }

    window.addEventListener('DOMContentLoaded', async ()=>{
      if(!code){ const v = prompt('Entrez le code de la soirée (4 chiffres)')||''; code = sanitizeCode(v); if(code.length!==4){ alert('Code invalide. Retour index.'); location.href='index.html'; return; } localStorage.setItem('sc_code', code); }
      await ensureAuth();
      await loadPlayers();

      const ref = doc(db,'soirees', code);
      onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const d = snap.data();
        const tc=$('titleCode'); if(tc) tc.textContent = `#${code}`;

        const arr = Array.isArray(d.players) ? d.players : [];
        // Rendre au premier snapshot ou si le nombre change
        if(_renderedCount !== arr.length){
          renderPlayers(arr);
          _renderedCount = arr.length;
        }
        applyLeaderState(d);

        // Redirection réactive pour tous les appareils si un jeu est en cours
        const cg = d.currentGame;
        if(cg && cg.gid && cg.type){
          const target = cg.type === 'dame_de_pique' ? 'dame_de_pique.html'
                       : cg.type === 'chialeux'      ? 'chialeux.html'
                       :                               'jeu_du_9.html';
          const url = `${target}?code=${code}&gid=${cg.gid}`;
          if(!location.href.includes(`gid=${cg.gid}`)){
            location.href = url;
          }
        }
      });
          }
          const tc = $('titleCode'); if(tc) tc.textContent = `#${code}`;
        }catch(_){}
      });

      $('btnDP').addEventListener('click', ()=> startGameWithLeader('dame_de_pique'));
      $('btnCH').addEventListener('click', ()=> startGameWithLeader('chialeux'));
      $('btnJ9').addEventListener('click', ()=> startGameWithLeader('jeu_du_9'));
      $('resetDealerBtn').addEventListener('click', resetDealer);
    });
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card grid">
      <h1>Sélectionner le brasseur <span class="muted" id="titleCode"></span></h1>
      <div id="playersBtns" class="row"></div>
      <button id="resetDealerBtn" class="btn green" type="button">Changer de brasseur</button>
      <div id="error" class="err" role="alert"></div>
    </section>

    <section class="card grid">
      <h1>Sélectionner le type de jeu</h1>
      <button id="btnDP" class="btn" disabled>Dame de pique</button>
      <button id="btnCH" class="btn" disabled>Le chialeux</button>
      <button id="btnJ9" class="btn" disabled>Jeu du 9</button>
    </section>

    <div class="footer">v4.3.5 • Jeux actifs sur l’appareil du joueur sélectionné (leader) + badge visuel • selectDealer lit deviceId depuis Firestore</div>
  </main>
</body>
</html>
