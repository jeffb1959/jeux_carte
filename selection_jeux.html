<!-- Version: v4.4 (2025-11-03) -->
<!-- v4.4 Sandbox: fallback localStorage quand Firebase indisponible (démo/offline) -->
<!-- v4.3.1 Fix: sanitizeCode regex + tests -->
<!-- v4.3    Démarrage d'une partie: crée un doc de score par jeu avec leader + redirection avec gid -->
<!-- v4.2    Sélection du premier brasseur + boutons joueurs + désactivation initiale des jeux -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Sélection du jeu</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; --ok:#22c55e; --line:#243252; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:color-mix(in srgb, var(--card) 92%, white 8%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:4px 0 8px;font-size:1.8rem}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:64px;padding:18px;border-radius:16px;font-size:1.1rem;font-weight:800;color:#0c111b;background:var(--accent);transition:opacity .2s ease}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.green{background:var(--ok);color:#06210f}
    .row{display:grid;gap:10px}
    .err{background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:12px;color:#ffd6db;display:none}
    .footer{color:var(--muted);text-align:center;font-size:.95rem}
  </style>
  <script type="module">
    // --- Import Firebase dynamiquement; fallback SANDBOX si indisponible ---
    let initializeApp, getAuth, signInAnonymously, getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, addDoc;
    let app, auth, db;
    let isSandbox = false;
    try{
      ({ initializeApp } = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js'));
      ({ getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js'));
      ({ getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js'));

      const firebaseConfig = { apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg", authDomain: "soireecartev2.firebaseapp.com", projectId: "soireecartev2" };
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    }catch(e){
      console.warn('Sandbox activé: Firebase indisponible', e);
      isSandbox = true;
    }

    const $ = (id)=>document.getElementById(id);
    const qs = (k)=>new URLSearchParams(location.search).get(k);
    const sanitizeCode = (x)=> String(x||'').replace(/\D/g,'').slice(0,4);

    // tests légers
    (function test_sanitizeCode(){
      try{
        console.assert(sanitizeCode('1234')==='1234','T1');
        console.assert(sanitizeCode(' 12-34 ')==='1234','T2');
        console.assert(sanitizeCode('abcd')==='', 'T3');
        console.assert(sanitizeCode('98765')==='9876','T4');
      }catch(_){/* no-op */}
    })();

    let code = sanitizeCode(qs('code') || localStorage.getItem('sc_code'));

    function disableGameButtons(disabled=true){ ['btnDP','btnCH','btnJ9'].forEach(id=>{ const b=$(id); if(b){ b.disabled = disabled; }}); }
    function setPlayersButtonsEnabled(enabled){ const c=$('playersBtns'); if(!c) return; [...c.querySelectorAll('button[data-player-index]')].forEach(b=> b.disabled = !enabled); }

    async function ensureAuth(){ if(isSandbox) return; try{ await signInAnonymously(auth);}catch(e){ console.warn('Auth failed, sandbox on',e); isSandbox=true; } }

    // --- SANDBOX helpers ---
    const SB_SOIREE = (code)=> `sandbox_soiree_${code}`;
    const SB_SCORES = (gametype)=> `sandbox_scores_${gametype}`;
    function sb_loadSoiree(code){ const raw = localStorage.getItem(SB_SOIREE(code)); return raw? JSON.parse(raw): null; }
    function sb_saveSoiree(code,obj){ localStorage.setItem(SB_SOIREE(code), JSON.stringify(obj)); }
    function sb_defaultSoiree(){ return { code, playerCount:4, players:[{name:'Joueur 1',confirmed:true},{name:'Joueur 2'},{name:'Joueur 3'},{name:'Joueur 4'}], status:'setup', createdAt: Date.now() }; }

    async function loadPlayers(){
      $('titleCode').textContent = `#${code}`;
      const zone = $('playersBtns'); zone.innerHTML='';

      if(isSandbox){
        let s = sb_loadSoiree(code) || sb_defaultSoiree();
        // si une liste sandbox spécifique existe, on l'utilise
        const override = localStorage.getItem(`sandbox_players_${code}`);
        if(override){ try{ const arr=JSON.parse(override); if(Array.isArray(arr)&&arr.length){ s.players = arr.map((n,i)=>({name:n, order:i, confirmed: !!(i===0)})); s.playerCount = s.players.length; } }catch(_){}} 
        sb_saveSoiree(code,s);
        // build buttons
        s.players.slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p,i)=>{
          const btn=document.createElement('button'); btn.className='btn'; btn.type='button'; btn.textContent=p?.name||`Joueur ${i+1}`; btn.dataset.playerIndex=String(i); btn.addEventListener('click',()=> selectDealer(i,p)); zone.appendChild(btn);
        });
        disableGameButtons(true); setPlayersButtonsEnabled(true); return;
      }

      // Firestore
      try{
        const ref = doc(db,'soirees', code);
        const snap = await getDoc(ref);
        if(!snap.exists()){ showError('Soirée introuvable.'); return; }
        const data = snap.data();
        const players = Array.isArray(data.players)? data.players : [];
        players.slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p,i)=>{
          const btn=document.createElement('button'); btn.className='btn'; btn.type='button'; btn.textContent=p?.name||`Joueur ${i+1}`; btn.dataset.playerIndex=String(i); btn.addEventListener('click',()=> selectDealer(i,p)); zone.appendChild(btn);
        });
        disableGameButtons(true); setPlayersButtonsEnabled(true);
      }catch(e){ console.warn('Lecture Firestore échouée, sandbox on',e); isSandbox=true; return loadPlayers(); }
    }

    async function selectDealer(index, player){
      setPlayersButtonsEnabled(false); disableGameButtons(false);

      if(isSandbox){
        const s = sb_loadSoiree(code) || sb_defaultSoiree();
        s.leaderIndex = index; s.leaderName = player?.name||null; s.leaderDeviceId = player?.deviceId||null; s.leaderAt = Date.now();
        sb_saveSoiree(code,s);
        return;
      }
      try{
        const ref = doc(db,'soirees', code);
        await updateDoc(ref, { leaderIndex:index, leaderName: player?.name||null, leaderDeviceId: player?.deviceId||null, leaderAt: serverTimestamp() });
      }catch(e){ console.warn('updateDoc échoué, sandbox on',e); isSandbox=true; selectDealer(index, player); }
    }

    async function startGameWithLeader(gameType){
      const target = gameType === 'dame_de_pique' ? 'dame_de_pique.html' : gameType === 'chialeux' ? 'chialeux.html' : 'jeu_du_9.html';

      if(isSandbox){
        const s = sb_loadSoiree(code) || sb_defaultSoiree();
        const gid = `${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
        const key = SB_SCORES(gameType);
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        arr.push({ id: gid, code, leaderDeviceId: s.leaderDeviceId||null, leaderName: s.leaderName||null, leaderIndex: (typeof s.leaderIndex==='number'? s.leaderIndex:null), startedAt: Date.now(), state:'in_progress' });
        localStorage.setItem(key, JSON.stringify(arr));
        location.href = `${target}?code=${code}&gid=${gid}`; return;
      }

      try{
        const soireeRef = doc(db,'soirees', code);
        const snap = await getDoc(soireeRef);
        if(!snap.exists()){ showError('Soirée introuvable'); return; }
        const s = snap.data();
        const colName = gameType === 'dame_de_pique' ? 'scores_dame_de_pique' : gameType === 'chialeux' ? 'scores_chialeux' : 'scores_jeu_du_9';
        const scoreRef = await addDoc(collection(db, colName), { code, leaderDeviceId: s.leaderDeviceId||null, leaderName: s.leaderName||null, leaderIndex: (typeof s.leaderIndex==='number')? s.leaderIndex : null, startedAt: serverTimestamp(), state:'in_progress' });
        location.href = `${target}?code=${code}&gid=${scoreRef.id}`;
      }catch(e){ console.warn('Création score échouée, sandbox on',e); isSandbox=true; startGameWithLeader(gameType); }
    }

    function resetDealer(){ setPlayersButtonsEnabled(true); disableGameButtons(true); if(isSandbox){ const s=sb_loadSoiree(code)||sb_defaultSoiree(); delete s.leaderIndex; delete s.leaderName; delete s.leaderDeviceId; delete s.leaderAt; sb_saveSoiree(code,s);} }
    function showError(msg){ const e=$('error'); if(!e) return; e.style.display='block'; e.textContent=msg; }

    window.addEventListener('DOMContentLoaded', async ()=>{
      setTimeout(()=>{ try{ console.assert($("btnDP").disabled && $("btnCH").disabled && $("btnJ9").disabled, 'T5 game buttons disabled on load'); }catch(_){ } },0);
      if(!code){ const v = prompt('Entrez le code de la soirée (4 chiffres)')||''; code = sanitizeCode(v); if(code.length!==4){ alert('Code invalide. Retour index.'); location.href='index.html'; return; } localStorage.setItem('sc_code', code); }
      await ensureAuth();
      await loadPlayers();
      $('btnDP').addEventListener('click', ()=> startGameWithLeader('dame_de_pique'));
      $('btnCH').addEventListener('click', ()=> startGameWithLeader('chialeux'));
      $('btnJ9').addEventListener('click', ()=> startGameWithLeader('jeu_du_9'));
      $('resetDealerBtn').addEventListener('click', resetDealer);
    });
  </script>
</head>
<body>
  <main class="wrap">
    <!-- Sélection du brasseur -->
    <section class="card grid">
      <h1>Sélectionner le brasseur <span class="muted" id="titleCode"></span></h1>
      <div id="playersBtns" class="row"></div>
      <button id="resetDealerBtn" class="btn green" type="button">Changer de brasseur</button>
      <div id="error" class="err" role="alert"></div>
    </section>

    <!-- Sélection du jeu (inactive tant que brasseur non choisi) -->
    <section class="card grid">
      <h1>Sélectionner le type de jeu</h1>
      <button id="btnDP" class="btn" disabled>Dame de pique</button>
      <button id="btnCH" class="btn" disabled>Le chialeux</button>
      <button id="btnJ9" class="btn" disabled>Jeu du 9</button>
    </section>

    <div class="footer">v4.4 • Choix du brasseur & jeux • Sandbox prêt</div>
  </main>
</body>
</html>
