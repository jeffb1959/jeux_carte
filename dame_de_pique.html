<!-- Version v7.1.2 ‚Äî 2025-11-11 ‚Äî Zone TEST : activation lecture Firestore (soirees/{code}) en read-only -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique ‚Äî v7.1.2 (zone test)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger-pale:#fecaca; --danger-text:#7f1d1d; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:420px; margin:0 auto; padding:18px; display:grid; gap:16px }
    .card{ background:color-mix(in srgb, var(--card) 92%, white 8%); border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    h1{ margin:0 0 4px; font-size:clamp(22px,5vw,28px) } .subhead{ margin:0; font-size:clamp(14px,3.5vw,16px); color:var(--muted) } .muted{ color:var(--muted) }
    .line{ display:flex; align-items:center; justify-content:space-between; background:#0f1a30; border:1px solid #243252; border-radius:12px; padding:10px 12px; }
    .badge{ display:inline-block; margin-left:10px; padding:4px 8px; border-radius:999px; font-size:.85rem; font-weight:700; background:#fecaca; color:#7f1d1d; vertical-align:middle }
    .btn{ appearance:none; border:none; cursor:pointer; width:65%; min-height:54px; padding:14px; border-radius:14px; font-size:1.2rem; font-weight:800; color:#0c111b; background:#22c55e; display:block; margin:0 auto; transition:opacity .2s ease, transform .02s ease-in-out; will-change: transform; }
    .btn:active{ transform:translateY(1px) } .btn[disabled]{ opacity:.55; cursor:not-allowed }
    .btn-pale-danger{ color:var(--danger-text); background:var(--danger-pale); font-size:.6rem; padding:6px 10px; min-height:30px; }
    .hold2s{ position:relative; overflow:hidden } .hold2s .fill{ position:absolute; inset:0; width:0%; background:rgba(0,0,0,.08); pointer-events:none; transition:width 2s linear }
    .footer{ text-align:center; color:var(--muted); font-size:.95rem } @media (min-width:640px){ .wrap{ max-width:520px } }
  </style>
</head>
<body>
  <main class="wrap">
    <header class="card"><h1 id="title">Dame de Pique</h1><h2 id="passRule" class="subhead">R√®gle : ‚Äî</h2><div class="muted" id="meta" style="margin-top:4px">Code soir√©e: <strong id="code">‚Äî</strong> ‚Ä¢ Tour <span id="round">1</span> ‚Ä¢ Brasseur: <strong id="dealerName">‚Äî</strong></div></header>
    <section class="card"><h2 style="margin:0 0 8px;font-size:1.2rem">Joueurs</h2><div id="playersList" style="display:grid;gap:10px"></div></section>
    <section class="card"><h2 style="margin:0 0 8px;font-size:1.2rem">Scores</h2><button id="btnOpenScore" class="btn" type="button">Inscrire mon pointage</button><div id="totals" style="display:grid;gap:10px;margin-top:10px"></div><div id="roundStatus" class="muted" aria-live="polite">0/0 soumis</div><div id="roundError" class="muted" aria-live="assertive"></div></section>
    <details class="card" id="diag" style="font-size:.95rem"><summary>Diagnostics</summary><pre id="diagOutput" style="white-space:pre-wrap"></pre></details>
    <section class="card" id="finishSection"><button id="btnFinish" class="btn btn-pale-danger hold2s" type="button"><span>Fin de partie (maintenir)</span><div class="fill" aria-hidden="true"></div></button></section>
    <div class="footer">v7.1.2 ‚Äî zone test (lecture read-only soirees/{code})</div>
  </main>
  <!-- Configuration Firebase (inchang√©) -->
  <script>
    window.__FIREBASE_CONFIG = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>
  <!-- === init/app === -->
  <script type="module" id="mod-init-app">
    const $ = (id)=>document.getElementById(id);
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    export const state = { soireeCode:"", gameId:"", players:[], dealerIndex:0, round:1, totals:{}, roundScores:{}, isHost:false, gameOver:false, lastRound:null, authUid:null, _db:null };
    function readUrl(){ const qs=new URLSearchParams(location.search); state.soireeCode=String(qs.get("code")||"").replace(/\\D/g,"").slice(0,4); state.gameId=String(qs.get("gid")||""); if(state.soireeCode) $("code").textContent=state.soireeCode; }
    function bootUi(){ $("round").textContent=String(state.round); $("dealerName").textContent="‚Äî"; }
    export async function ensureAuth(){
      if(!window.firebaseConfig){ console.warn("[ensureAuth] firebaseConfig manquant"); return null; }
      const app = getApps().length ? getApps()[0] : initializeApp(window.firebaseConfig);
      const auth = getAuth(app); const db = getFirestore(app); state._db = db;
      try{ await signInAnonymously(auth); }catch(e){ if(!auth.currentUser) throw e; }
      return new Promise((resolve)=> onAuthStateChanged(auth, (user)=>{ state.authUid=user?.uid||null; resolve({app,auth,db,uid:state.authUid}); }));
    }
    export function getDb(){ return state._db; }
    export async function boot(){ readUrl(); bootUi(); }
    export default { state, boot, ensureAuth, getDb };
  </script>

  <!-- === data/soiree === -->
  <script type="module" id="mod-data-soiree">
    import init, { state } from '#mod-init-app';
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    let unsubscribeSoiree=null;
    export function listenSoiree(db, code, onData){
      if(!db||!code){ console.warn("[listenSoiree] db/code manquant"); return ()=>{}; }
      if(unsubscribeSoiree){ try{unsubscribeSoiree();}catch(_){} unsubscribeSoiree=null; }
      const ref = doc(db,"soirees",code);
      unsubscribeSoiree = onSnapshot(ref,(snap)=>{
        if(!snap.exists()){ onData?.(null); return; }
        onData?.(snap.data()||{});
      },(err)=> console.error("[listenSoiree] erreur snapshot:",err));
      return ()=>{ if(unsubscribeSoiree) unsubscribeSoiree(); };
    }
    export default { listenSoiree };
  </script>

  <!-- === data/scores === -->
  <script type="module" id="mod-data-scores">
    export function listenScores(){ console.debug('[listenScores] (placeholder)'); return ()=>{}; }
    export async function seedScoresIfNeeded(){ console.debug('[seedScoresIfNeeded] (placeholder)'); }
    export async function submitScore(){ console.debug('[submitScore] (placeholder)'); }
    export default { listenScores, seedScoresIfNeeded, submitScore };
  </script>

  <!-- === logic/rounds === -->
  <script type="module" id="mod-logic-rounds">
    import { state } from '#mod-init-app';
    export function computePassRule(round){ const rules=['√Ä droite','√Ä gauche','Au centre','Garde tes cartes']; return rules[(Math.max(1,round)-1)%4]; }
    export function applyRoundScore(){ console.debug('[applyRoundScore] (placeholder)'); }
    export function checkGameOver(){ return false; }
    export default { computePassRule, applyRoundScore, checkGameOver };
  </script>

  <!-- === ui/render === -->
  <script type="module" id="mod-ui-render">
    import { state } from '#mod-init-app'; import { computePassRule } from '#mod-logic-rounds';
    const $ = (id)=>document.getElementById(id);
    export function renderPlayers(){
      const host=$('playersList'); if(!host) return; host.innerHTML='';
      (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p,idx)=>{
        const row=document.createElement('div'); row.className='line';
        const name=document.createElement('div'); name.textContent=p?.name||`Joueur ${idx+1}`;
        if(idx===state.dealerIndex){ const badge=document.createElement('span'); badge.className='badge'; badge.textContent='Brasseur'; name.appendChild(badge); }
        const val=document.createElement('div'); val.className='muted';
        const total=typeof state.totals?.[p.id]==='number'?state.totals[p.id]:(p.total||0)||0;
        val.textContent=`Total: ${total}`;
        row.appendChild(name); row.appendChild(val); host.appendChild(row);
      });
      const pass=computePassRule(state.round);
      const dealerName=(state.players?.[state.dealerIndex]?.name)||'‚Äî';
      $('dealerName').textContent=dealerName; $('round').textContent=String(state.round);
      const meta=document.getElementById('meta');
      if(meta){ meta.innerHTML=`Code soir√©e: <strong id="code">${state.soireeCode||'‚Äî'}</strong> ‚Ä¢ Tour <span id="round">${state.round}</span> ‚Ä¢ Brasseur: <strong id="dealerName">${dealerName}</strong>`; }
      const passEl=document.getElementById('passRule'); if(passEl) passEl.textContent=`R√®gle : ${pass}`;
    }
    export function renderTotals(){
      const host=document.getElementById('totals'); if(!host) return; host.innerHTML='';
      (state.players||[]).forEach((p,idx)=>{
        const line=document.createElement('div'); line.className='line';
        const n=document.createElement('div'); n.textContent=p?.name||`Joueur ${idx+1}`;
        const v=document.createElement('div');
        const total=typeof state.totals?.[p.id]==='number'?state.totals[p.id]:(p.total||0)||0;
        v.textContent=String(total);
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });
      const submitted=Object.keys(state.roundScores||{}).length;
      const expected=(state.players||[]).length;
      const rs=document.getElementById('roundStatus'); if(rs) rs.textContent=`${submitted}/${expected} soumis`;
    }
    export function renderAll(){ renderPlayers(); renderTotals(); document.body.style.background = (state.myIndex===state.dealerIndex)?'#0f2e16':'var(--bg)'; }
    export default { renderPlayers, renderTotals, renderAll };
  </script>

  <!-- === actions/ui === -->
  <script type="module" id="mod-actions-ui">
    import init, { state, boot, ensureAuth, getDb } from '#mod-init-app';
    import { renderAll } from '#mod-ui-render';
    import { listenSoiree } from '#mod-data-soiree';
    const $=(id)=>document.getElementById(id);

    function wireOpenScore(){ const btn=$('btnOpenScore'); if(!btn||btn.__wired) return; btn.__wired=true; btn.addEventListener('click',(e)=>{ e.preventDefault(); alert('Saisie de score (modale) ‚Äî √† impl√©menter v7.4.0'); },{capture:true}); }
    function wireFinishHold2s(){
      const btn=$('btnFinish'); if(!btn||btn.__wired) return; btn.__wired=true;
      let timer=null; const fill=btn.querySelector('.fill');
      const start=(ev)=>{ ev.preventDefault?.(); if(fill){ fill.style.transition='none'; fill.style.width='0%'; void fill.offsetWidth; fill.style.transition='width 2s linear'; fill.style.width='100%'; } timer=setTimeout(()=>{ clearTimeout(timer); timer=null; alert('Fin de partie (placeholder) ‚Äî √©criture Firestore √† venir v7.6.0'); },2000); };
      const cancel=()=>{ clearTimeout(timer); timer=null; if(fill){ fill.style.transition='none'; fill.style.width='0%'; } };
      ['mousedown','touchstart'].forEach(ev=> btn.addEventListener(ev,start,{passive:false}));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev,cancel));
    }
    function ensureFinishIsLast(){ const main=document.querySelector('main.wrap'); const finish=document.getElementById('finishSection'); if(main&&finish&&main.lastElementChild!==finish){ main.appendChild(finish); } }
    function diagnostics(lines){ const d=document.getElementById('diagOutput'); if(d) d.textContent = lines.join('\n'); }

    function onReady(fn){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); } else { fn(); } }

    onReady(async ()=>{
      await boot(); renderAll(); wireOpenScore(); wireFinishHold2s(); ensureFinishIsLast();
      const notes=[];
      if(!window.firebaseConfig){ notes.push('‚ÑπÔ∏è firebaseConfig manquant ‚Üí lecture d√©sactiv√©e.'); diagnostics(notes); return; }
      notes.push('‚è≥ Auth anonyme‚Ä¶');
      const { db, uid } = await ensureAuth() || {};
      if(!db){ notes.push('‚ùå Auth/DB indisponible.'); diagnostics(notes); return; }
      notes.push('‚úÖ Auth OK. UID: '+(uid||'(anonyme)'));
      if(!state.soireeCode){ notes.push('‚ÑπÔ∏è Param√®tre ?code=XXXX manquant ‚Üí pas d\\'√©coute.'); diagnostics(notes); return; }
      notes.push('üëÇ √âcoute soirees/'+state.soireeCode+' ‚Ä¶');
      listenSoiree(db, state.soireeCode, (data)=>{
        if(!data){ notes.push('‚ö†Ô∏è Doc inexistant'); diagnostics(notes); return; }
        state.players = Array.isArray(data.players)? data.players : (data.players?.list||[]);
        state.dealerIndex = Number.isInteger(data.leaderIndex)? data.leaderIndex : (data.dealerIndex ?? 0);
        state.round = Number.isInteger(data.round)? data.round : (state.round||1);
        let dlName = data.leaderName; if(!dlName && Array.isArray(state.players) && state.players[state.dealerIndex]) dlName = state.players[state.dealerIndex]?.name || '‚Äî';
        document.getElementById('dealerName').textContent = dlName || '‚Äî';
        renderAll();
        diagnostics([ ...notes, 'üì¶ Maj re√ßue: players='+(state.players?.length||0)+', dealerIndex='+state.dealerIndex+', round='+state.round ]);
      });
    });
  </script>

  <script type="importmap">
    { "imports": {
      "#mod-init-app": "#mod-init-app",
      "#mod-data-soiree": "#mod-data-soiree",
      "#mod-data-scores": "#mod-data-scores",
      "#mod-logic-rounds": "#mod-logic-rounds",
      "#mod-ui-render": "#mod-ui-render",
      "#mod-actions-ui": "#mod-actions-ui"
    } }
  </script>
</body>
</html>
