<!-- Dame de Pique ‚Äî v6.1.0 (√âtape 2: √©tat + rendu, correctifs null refs + diagnostics) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique ‚Äî √âtape 3 (Firestore)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:390px;margin:0 auto;padding:18px;display:grid;gap:18px}
    .titleRow{display:block;margin-bottom:8px}
    .titleRow h1{display:block;margin:0 0 8px 0;font-size:clamp(22px,5vw,28px)}
    h1{margin:0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(14px,4vw,16px)}
    .card{background:#111a2e;border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    /* Modale */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(92vw,390px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--ok);font-size:0.9rem;text-align:center}
    .danger{color:var(--danger)}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .passTag{margin-left:auto;background:#14223f;border:1px solid #2b3e69;border-radius:10px;padding:6px 10px;font-size:.9rem}
    details.diag{border:1px dashed #2b3e69;border-radius:12px;padding:8px}
    details.diag>summary{cursor:pointer;color:#9bb3d1}
    .ok{color:var(--ok)}
  .dealerBadge{background:#14532d !important;border-color:#1a7f3a !important}
    .isDealer body{background:#0f2e16}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="meta metaRow">
        <div class="lbl">Brasseur : <strong id="dealerName">‚Äî</strong></div>
        <div class="lbl">Tour n¬∞ <span id="round">1</span></div>
        <div id="passInfo" class="passTag" title="R√®gle d'√©change du tour">‚Äî</div>
      </div>
    </header>

    <!-- Section saisie du score -->
    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn" type="button" aria-haspopup="dialog" aria-controls="modal">Inscrire le pointage</button>
      <div id="msg" class="msg" aria-live="polite"></div>
    </section>

    <!-- Totaux -->
    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl" id="roundStatus">0/0 soumis</div>
    </section>

    <div class="footer">
      <a class="back" href="#">‚Üê Retour</a>
    </div>

    <!-- Modale -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="sheet">
        <h3 id="modalTitle">Saisir mon score</h3>
        <div id="modalMsg" class="msg" aria-live="polite"></div>
        <div class="row">
          <input id="scoreInput" class="inp" type="number" inputmode="numeric" min="0" max="25" step="1" placeholder="0‚Äì25" />
          <button id="btnSaveScore" class="btn" type="button">Valider</button>
        </div>
      </div>
    </div>

    <!-- Diagnostics (repliable) : utile pendant le dev, non intrusif pour les a√Æn√©s -->
    <details class="diag" id="diag" open>
      <summary>Diagnostics / tests (peut √™tre referm√©)</summary>
      <div id="diagOutput" class="lbl"></div>
    </details>
  </main>

  <!-- Configuration Firebase inject√©e depuis index.html -->
  <script>
    window.__FIREBASE_CONFIG = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>

  <!-- ===== √âtape 3: Firestore (SDK v10, module) ===== -->
  <script type="module">
    /*
      Int√©gration Firestore ‚Äî lecture/seed
      Attentes:
        - URL contient ?code=SOIREE_CODE&gid=PARTIE_ID&my=INDEX_OPTIONNEL
        - Collection soirees/{code}: doit exposer une liste de joueurs
          Formes support√©es automatiquement (adapteur):
            A) { players: [ {id, name}, ... ], dealerIndexStart?, soireeNo? }
            B) { joueurs: [ 'Nom 1', 'Nom 2', ... ], soireeNo? }
            C) { playersMap: { playerId: { name } }, soireeNo? }
        - Document scores_dame_de_pique/{gid} pour les totaux et l'√©tat de partie.

      ‚ö†Ô∏è Remplacez window.__FIREBASE_CONFIG par votre config si non fournie globalement.
    */

    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const soireeCode = qs.get('code') || localStorage.getItem('dame_code') || '';
    const gameId     = qs.get('gid')  || localStorage.getItem('dame_gid')  || '';
    const myIndexURL = qs.get('my');

    // Garde-fous HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      console.warn('[S√©curit√©] Cette page devrait √™tre servie en HTTPS.');
    }

    // Config Firebase
    const cfg = (window.__FIREBASE_CONFIG || {}).apiKey ? window.__FIREBASE_CONFIG : {
      // üëâ Option 1: fourni globalement (pr√©f√©r√©)
      // window.__FIREBASE_CONFIG = { apiKey: '...', authDomain: '...', projectId: '...', appId: '...' };
      // üëâ Option 2: fallback localStorage (si vous stockez votre cfg c√¥t√© client)
      ...(JSON.parse(localStorage.getItem('FIREBASE_CONFIG') || '{}')),
    };

    if (!cfg || !cfg.projectId) {
      console.warn('[Firebase] Configuration absente ou incompl√®te. Placez __FIREBASE_CONFIG ou FIREBASE_CONFIG dans localStorage.');
    }

    const app = getApps().length ? getApps()[0] : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persistance l√©gere
    if (soireeCode) localStorage.setItem('dame_code', soireeCode);
    if (gameId)     localStorage.setItem('dame_gid', gameId);

    // Synchronise myIndex si fourni
    if (myIndexURL !== null) localStorage.setItem('dame_myIndex', String(myIndexURL));

    // ---- Adapteur de structure de joueurs
    function normalizePlayers(soireeData){
      if (!soireeData) return [];
      if (Array.isArray(soireeData.players)) {
        return soireeData.players.map((p,i)=>({ id: p.id || `p${i+1}`, name: p.name || String(p) }));
      }
      if (Array.isArray(soireeData.joueurs)) {
        return soireeData.joueurs.map((name,i)=>({ id: `p${i+1}`, name }));
      }
      if (soireeData.playersMap && typeof soireeData.playersMap === 'object') {
        return Object.entries(soireeData.playersMap).map(([id, obj])=>({ id, name: obj?.name || id }));
      }
      return [];
    }

    // ---- State (reutilise celui d√©fini plus bas si pr√©sent)
    const state = window.__STATE || {
      players: [],
      round: 1,
      dealerIndex: 0,
      roundScores: {},
      submitted: 0,
      expected(){ return this.players.length; },
      get passInfo(){ return passRuleForRound(this.round); },
      myIndex: parseInt(localStorage.getItem('dame_myIndex') || '-1', 10),
      soireeId: soireeCode,
      soireeNo: null,
      totals: {},
    };
    window.__STATE = state;

    // ---- UI helpers d√©j√† d√©finis dans le script principal
    function passRuleForRound(round){
      const rules = ['A droite', 'A gauche', 'Au centre', 'Garde tes cartes'];
      return rules[(round-1)%4];
    }
    function setText(id, text){ const el = $(id); if(el) el.textContent = text; }
    function renderAll(){
      setText('round', String(state.round));
      const dealerName = state.players[state.dealerIndex]?.name || '‚Äî';
      setText('dealerName', dealerName);
      setText('passInfo', state.passInfo);

      const host = $('totalsList');
      if (host) {
        host.innerHTML = '';
        state.players.forEach((p, idx)=>{
          const line = document.createElement('div');
          line.className = 'line' + (idx===state.dealerIndex ? ' dealerBadge' : '');
          const name = document.createElement('div'); name.textContent = p.name + (idx===state.dealerIndex ? ' ‚òÖ' : '');
          const total = typeof state.totals[p.id] === 'number' ? state.totals[p.id] : (p.total||0);
          const val = document.createElement('div'); val.textContent = String(total);
          line.appendChild(name); line.appendChild(val); host.appendChild(line);
        });
      }
      setText('roundStatus', `${state.submitted}/${state.expected()} soumis`);

      // Fond vert uniquement pour l'appareil du brasseur
      if (state.myIndex === state.dealerIndex) {
        document.body.style.background = '#0f2e16';
      } else {
        document.body.style.background = 'var(--bg)';
      }
    }

    async function ensureAuth(){
      return new Promise((resolve)=>{
        onAuthStateChanged(auth, async (user)=>{
          if (user) return resolve(user);
          try { const cred = await signInAnonymously(auth); resolve(cred.user); }
          catch(err){ console.error('[Auth] Anonyme √©chou√©e', err); resolve(null); }
        });
      });
    }

    async function seedScoresIfNeeded(players){
      if (!gameId) return;
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      const snap = await getDoc(ref);
      if (snap.exists()) return;
      const totals = Object.fromEntries(players.map(p=>[p.id, 0]));
      await setDoc(ref, {
        createdAt: serverTimestamp(),
        soireeCode: soireeCode || null,
        round: 1,
        dealerIndex: 0,
        totals,
        // roundState pourra contenir les saisies du tour courant √† l'√©tape 4
      });
      console.log('[Seed] scores_dame_de_pique cr√©√©');
    }

    function listenSoiree(){
      if (!soireeCode) return;
      const sref = doc(db, 'soirees', soireeCode);
      return onSnapshot(sref, async (snap)=>{
        if (!snap.exists()) { console.warn('soiree introuvable:', soireeCode); return; }
        const data = snap.data()||{};
        const players = normalizePlayers(data);
        if (players.length) state.players = players;
        state.soireeNo = data.soireeNo ?? data.numero ?? null;
        // dealerIndex peut provenir de la soiree si d√©j√† g√©r√©e c√¥t√© hub
        if (typeof data.dealerIndex === 'number') state.dealerIndex = data.dealerIndex;
        else if (typeof data.dealerIndexStart === 'number') state.dealerIndex = data.dealerIndexStart;

        await seedScoresIfNeeded(state.players);
        renderAll();
      });
    }

    function listenScores(){
      if (!gameId) return;
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      return onSnapshot(ref, (snap)=>{
        if (!snap.exists()) return;
        const d = snap.data();
        state.round       = d.round || 1;
        state.dealerIndex = typeof d.dealerIndex === 'number' ? d.dealerIndex : state.dealerIndex;
        state.totals      = d.totals || state.totals || {};
        // submitted sera proprement g√©r√© √† l'√©tape 4 (par roundState)
        renderAll();
      });
    }

    // Lancement
    try {
      await ensureAuth();
      const off1 = listenSoiree();
      const off2 = listenScores();
      console.log('[Firestore] Listeners actifs', { soireeCode, gameId });

      // Diagnostics
      const d = document.getElementById('diagOutput');
      if (d) d.textContent += `
Firebase OK ‚Äî soiree:${soireeCode||'‚Äî'} gid:${gameId||'‚Äî'}`;
    } catch(err){
      console.error('[Firestore] √âchec initialisation', err);
      const d = document.getElementById('diagOutput');
      if (d) d.textContent += `
‚ùå Firestore: ${err?.message||err}`;
    }
  </script>

  <script>
    // ===== √âtape 2: Mod√®le d'√©tat en m√©moire + rendu (avec garde-fous DOM) =====
    const $ = (id)=>document.getElementById(id);
    const onReady = (fn)=>{
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn, { once: true });
      } else { fn(); }
    };

    // Petit helper robuste pour √©viter les "null.textContent" et logguer clairement
    function setText(id, text){
      const el = $(id);
      if (!el) { console.warn(`[render] √âl√©ment manquant: #${id}`); return false; }
      el.textContent = text;
      return true;
    }

    // √âtat minimal ‚Äî remplac√© √† l'√©tape 3 par Firestore
    const state = {
      players: [
        { id: 'p1', name: 'Joueur 1', total: 0 },
        { id: 'p2', name: 'Joueur 2', total: 0 },
        { id: 'p3', name: 'Joueur 3', total: 0 },
        { id: 'p4', name: 'Joueur 4', total: 0 },
      ],
      round: 1,                 // commence √† 1
      dealerIndex: 0,           // index dans players
      roundScores: {},          // { [index]: number }
      submitted: 0,             // nb de joueurs ayant valid√© ce tour
      expected(){ return this.players.length; },
      get passInfo(){ return passRuleForRound(this.round); },
      myIndex: null,            // d√©tect√© plus tard (URL/localStorage/Firestore)
      soireeId: null,           // inject√© √† l'√©tape 3
    };

    function passRuleForRound(round){
      // 1: droite, 2: gauche, 3: centre, 4: garde ‚Äî puis cycle
      const rules = ['A droite', 'A gauche', 'Au centre', 'Garde tes cartes'];
      const idx = ((round - 1) % 4);
      return rules[idx];
    }

    // Rendu des totaux + m√©ta
    function renderAll(){
      setText('round', String(state.round));
      const d = state.players[state.dealerIndex]?.name ?? '‚Äî';
      setText('dealerName', d);
      setText('passInfo', state.passInfo);

      // Liste des totaux
      const host = $('totalsList');
      if (!host) { console.warn('[render] #totalsList introuvable'); }
      else {
        host.innerHTML = '';
        state.players.forEach((p)=>{
          const line = document.createElement('div');
          line.className = 'line';
          const name = document.createElement('div'); name.textContent = p.name;
          const val  = document.createElement('div'); val.textContent = String(p.total ?? 0);
          line.appendChild(name); line.appendChild(val); host.appendChild(line);
        });
      }

      setText('roundStatus', `${state.submitted}/${state.expected()} soumis`);
    }

    // Ouverture/fermeture modale
    window.__openScoreModal = ()=>{
      const modal = $('modal');
      if (!modal) return;
      modal.classList.add('show');

      const saveBtn = $('btnSaveScore');
      if (saveBtn && !saveBtn.__wired) {
        saveBtn.__wired = true;
        saveBtn.addEventListener('click', (ev)=>{
          ev.preventDefault();
          // √âtape 2: simulation soumission
          const raw = String($('scoreInput')?.value ?? '').trim();
          const val = parseInt(raw,10);
          if (!Number.isFinite(val)) { setText('modalMsg', 'Entrez un nombre (simulation √âtape 2).'); return; }
          setText('modalMsg', 'Score saisi (simulation).');
          state.submitted = Math.min(state.expected(), state.submitted + 1);
          renderAll();
          setTimeout(()=>{
            $('modal')?.classList.remove('show');
            setText('modalMsg','');
            if ($('scoreInput')) $('scoreInput').value='';
          }, 500);
        }, { capture:true });
      }

      const inp = $('scoreInput');
      if (inp && !inp.__wired) {
        inp.__wired = true;
        inp.setAttribute('inputmode','numeric');
        inp.setAttribute('pattern','[0-9]*');
        inp.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); $('btnSaveScore')?.click(); }
        }, { capture:true });
      }
    };

    window.__closeScoreModal = ()=>{ $('modal')?.classList.remove('show'); };

    // Bouton principal
    function wireOpenButton(){
      const btnOpen = $('btnOpen');
      if (btnOpen && !btnOpen.__wired) {
        btnOpen.__wired = true;
        btnOpen.disabled = false;
        btnOpen.onclick = null;
        btnOpen.addEventListener('click', (e)=>{ e.preventDefault(); window.__openScoreModal(); }, { capture:true });
        btnOpen.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); window.__openScoreModal(); } }, { capture:true });
      }
    }

    // Click hors feuille pour fermer + Esc
    function wireDismiss(){
      document.addEventListener('click', (e)=>{
        const m = $('modal');
        if (!m || !m.classList.contains('show')) return;
        const sheet = m.querySelector('.sheet');
        if (e.target === m && !sheet.contains(e.target)) { window.__closeScoreModal(); }
      }, { capture:true });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') window.__closeScoreModal(); }, { capture:true });
    }

    // ===== Tests & diagnostics (non intrusifs) =====
    function runDiagnostics(){
      const checks = [
        ['dealerName existe', !!$('dealerName')],
        ['round existe', !!$('round')],
        ['passInfo existe', !!$('passInfo')],
        ['totalsList existe', !!$('totalsList')],
        ['roundStatus existe', !!$('roundStatus')],
        ['btnOpen existe', !!$('btnOpen')],
        ['modal existe', !!$('modal')],
        ['btnSaveScore existe', !!$('btnSaveScore')],
        ['scoreInput existe', !!$('scoreInput')],
      ];
      const passMap = checks.map(([label, ok])=> `${ok ? '‚úÖ' : '‚ùå'} ${label}`).join('\n');
      const diag = $('diagOutput');
      if (diag) { diag.textContent = passMap; }
      console.log('[Diagnostics]', '\n' + passMap);

      // Tests fonctionnels sur passRuleForRound
      const expectedCycle = ['A droite','A gauche','Au centre','Garde tes cartes','A droite','A gauche','Au centre','Garde tes cartes'];
      const actualCycle = Array.from({length:8}, (_,i)=>passRuleForRound(i+1));
      const okCycle = JSON.stringify(expectedCycle) === JSON.stringify(actualCycle);
      console.log('Test passRuleForRound x8:', okCycle ? 'OK' : 'FAIL', {expectedCycle, actualCycle});
      if (diag) diag.textContent += `\n${okCycle ? '‚úÖ' : '‚ùå'} cycle passRuleForRound (8 tours)`;

      // Test de rendu ne doit pas lever d'exception
      try { renderAll(); console.log('renderAll(): OK'); if (diag) diag.textContent += '\n‚úÖ renderAll()'; }
      catch(err){ console.error('renderAll(): FAIL', err); if (diag) diag.textContent += `\n‚ùå renderAll(): ${err}`; }
    }

    onReady(()=>{
      wireOpenButton();
      wireDismiss();
      renderAll();
      runDiagnostics();
      console.log('‚úÖ √âtape 2 pr√™te : mod√®le d\'√©tat + rendu (totaux, soumis, brasseur, passInfo) ‚Äî v6.1.0');
    });
  </script>
</body>
</html>
