<!-- Version v7.1.5 ‚Äî 2025-11-12 ‚Äî Zone TEST : Lecteur scores *adaptatif* (sch√©mas multiples) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique ‚Äî v7.2.0 (zone test)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger-pale:#fecaca; --danger-text:#7f1d1d; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:420px; margin:0 auto; padding:18px; display:grid; gap:16px }
    .card{ background:color-mix(in srgb, var(--card) 92%, white 8%); border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    h1{ margin:0 0 4px; font-size:clamp(22px,5vw,28px) } .subhead{ margin:0; font-size:clamp(14px,3.5vw,16px); color:var(--muted) } .muted{ color:var(--muted) }
    .line{ display:flex; align-items:center; justify-content:space-between; background:#0f1a30; border:1px solid #243252; border-radius:12px; padding:10px 12px; }
    .badge{ display:inline-block; margin-left:10px; padding:4px 8px; border-radius:999px; font-size:.85rem; font-weight:700; background:#fecaca; color:#7f1d1d; vertical-align:middle }
    .btn{ appearance:none; border:none; cursor:pointer; width:65%; min-height:54px; padding:14px; border-radius:14px; font-size:1.2rem; font-weight:800; color:#0c111b; background:#22c55e; display:block; margin:0 auto; transition:opacity .2s ease, transform .02s ease-in-out; will-change: transform; text-align:center; }
    .btn:active{ transform:translateY(1px) } .btn[disabled]{ opacity:.55; cursor:not-allowed }
    .btn-pale-danger{ color:var(--danger-text); background:var(--danger-pale); font-size:.9rem; padding:8px 14px; min-height:36px; }
    .hold2s{ position:relative; overflow:hidden } .hold2s .fill{ position:absolute; inset:0; width:0%; background:rgba(0,0,0,.08); pointer-events:none; transition:width 2s linear }
    .footer{ text-align:center; color:var(--muted); font-size:.95rem } @media (min-width:640px){ .wrap{ max-width:520px } }
  
    /* Modal simple */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(3,6,15,.6); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(520px, 92vw); background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 16px 40px rgba(0,0,0,.5) }
    .modal h3{ margin:0 0 8px; font-size:1.2rem }
    .grid2{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center }
    .field{ display:flex; align-items:center; gap:8px }
    .field input[type=number]{ width:90px; padding:8px; border-radius:10px; border:1px solid #35476d; background:#0f1a30; color:var(--text) }
    .toolbar{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .btn-secondary{ background:#334155; color:#e5e7eb }
    .warn{ color:#fbbf24 }

  </style>
</head>
<body>
  <main class="wrap">
    <header class="card" aria-labelledby="title">
      <h1 id="title">Dame de Pique</h1>
      <h2 id="passRule" class="subhead">R√®gle : ‚Äî</h2>
      <div class="muted" id="meta" style="margin-top:4px">
        Code soir√©e: <strong id="code">‚Äî</strong> ‚Ä¢ Tour <span id="round">1</span> ‚Ä¢ Brasseur: <strong id="dealerName">‚Äî</strong>
      </div>
    </header>

    <section class="card" aria-labelledby="playersTitle">
      <h2 id="playersTitle" style="margin:0 0 8px;font-size:1.2rem">Joueurs</h2>
      <div id="playersList" class="grid" style="display:grid;gap:10px"></div>
    </section>

    <section class="card" aria-labelledby="scoresTitle">
      <h2 id="scoresTitle" style="margin:0 0 8px;font-size:1.2rem">Scores</h2>
      <button id="btnOpenScore" class="btn" type="button" aria-haspopup="dialog" aria-controls="modalScore">
        Inscrire mon pointage
      </button>
      <div id="totals" class="grid" style="display:grid;gap:10px;margin-top:10px"></div>
      <div id="roundStatus" class="muted" aria-live="polite">0/0 soumis</div>
      <div id="roundError" class="muted" aria-live="assertive"></div>
    </section>
      <!-- Modal de saisie de score (local) -->
      <div id="modalScoreBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalScoreTitle">
        <div class="modal">
          <h3 id="modalScoreTitle">Saisie des scores ‚Äî Ronde <span id="modalRound">1</span></h3>
          <div class="muted" id="modalHint">Entrez les points par joueur. Somme attendue : <span id="expectedSum">‚Äî</span></div>
          <div id="scoreForm" class="grid2" style="margin-top:10px"></div>
          <div class="muted" style="margin-top:8px">Somme actuelle : <strong id="currentSum">0</strong> <span id="sumWarn" class="warn"></span></div>
          <div class="toolbar">
            <button id="btnCancelScore" class="btn btn-secondary" type="button">Annuler</button>
            <button id="btnSaveScore" class="btn" type="button">Enregistrer (local)</button>
          </div>
        </div>
      </div>


    <details class="card" id="diag" style="font-size:.95rem">
      <summary>Diagnostics</summary>
      <pre id="diagOutput" style="white-space:pre-wrap"></pre>
    </details>

    <section class="card" id="finishSection">
      <button id="btnFinish" class="btn btn-pale-danger hold2s" type="button" aria-label="Fin de partie (maintenir 2 secondes)">
        <span>Fin de partie (maintenir)</span>
        <div class="fill" aria-hidden="true"></div>
      </button>
    </section>

    <div class="footer">v7.2.0 ‚Äî zone test (saisie des scores ‚Äî local, sans √©criture)</div>
  </main>
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>
  
  <!-- === init/app === -->
  <script type="module">
    const $ = (id)=>document.getElementById(id);
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    const state = { soireeCode:"", gameId:"", players:[], dealerIndex:0, round:1, totals:{}, roundScores:{}, isHost:false, gameOver:false, lastRound:null, lastRoundPer:null, authUid:null, _db:null };
    function readUrl(){ const qs=new URLSearchParams(location.search); state.soireeCode=String(qs.get("code")||"").replace(/\D/g,"").slice(0,4); state.gameId=String(qs.get("gid")||""); if(state.soireeCode) $("code").textContent=state.soireeCode; }
    function bootUi(){ $("round").textContent=String(state.round); $("dealerName").textContent="‚Äî"; }
    async function ensureAuth(){
      if(!window.firebaseConfig){ console.warn("[ensureAuth] firebaseConfig manquant ‚Äî lecture d√©sactiv√©e."); return null; }
      const app = getApps().length ? getApps()[0] : initializeApp(window.firebaseConfig);
      const auth = getAuth(app); const db = getFirestore(app); state._db = db;
      try{ await signInAnonymously(auth); }catch(e){ if(!auth.currentUser) throw e; }
      return new Promise((resolve)=> onAuthStateChanged(auth, (user)=>{ state.authUid=user?.uid||null; resolve({ app, auth, db, uid: state.authUid }); }));
    }
    function getDb(){ return state._db; }
    async function boot(){ readUrl(); bootUi(); }
    window.ModInit = { state, boot, ensureAuth, getDb };
  </script>

  <!-- === data/soiree === -->
  <script type="module">
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    let unsubscribeSoiree=null;
    function listenSoiree(db, code, onData){
      if(!db||!code){ console.warn("[listenSoiree] db/code manquant"); return ()=>{}; }
      if(unsubscribeSoiree){ try{unsubscribeSoiree();}catch(_){} unsubscribeSoiree=null; }
      const ref = doc(db,"soirees",code);
      unsubscribeSoiree = onSnapshot(ref,(snap)=>{ if(!snap.exists()){ onData?.(null); return; } onData?.(snap.data()||{}); },(err)=> console.error("[listenSoiree] erreur snapshot:",err));
      return ()=>{ if(unsubscribeSoiree) unsubscribeSoiree(); };
    }
    window.ModSoiree = { listenSoiree };
  </script>

  <!-- === data/scores === (adaptatif) -->
  <script type="module">
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    let unsubscribeScores=null;

function extractTotals(data){
  // 1) totals direct (objet)
  if (data && typeof data.totals === 'object' && !Array.isArray(data.totals)) {
    const t = data.totals;

    // üëâ Cas sp√©cial : cl√©s "p1","p2",... ‚Üí remapper vers "0","1",...
    const keys = Object.keys(t);
    const looksLikePN = keys.length && keys.every(k => /^p\d+$/i.test(k));
    if (looksLikePN) {
      const out = {};
      for (const k of keys) {
        const n = parseInt(k.slice(1), 10); // "p3" -> 3
        const idx = Number.isFinite(n) ? n-1 : null;
        if (idx != null && idx >= 0) out[String(idx)] = Number(t[k]) || 0;
      }
      return out;
    }
    // sinon, on renvoie tel quel (ex: d√©j√† index√© par "0","1" ou par id joueur)
    return t;
  }

  // 2) standings.totals (si jamais tu l‚Äôutilises plus tard)
  if (data && data.standings && typeof data.standings.totals === 'object') {
    return data.standings.totals;
  }

  // 3) standings objet ‚Üí totaux directs
  if (data && data.standings && typeof data.standings === 'object' && !Array.isArray(data.standings)) {
    return data.standings;
  }

  // 4) lastRound.perRound comme fallback (dernier tour uniquement, non cumulatif)
  if (data && data.lastRound && Array.isArray(data.lastRound.perRound)) {
    const o = {}; data.lastRound.perRound.forEach((v,i)=> o[String(i)] = Number(v)||0);
    return o;
  }

  return null;
}

function extractRound(data){
  if (data && Number.isInteger(data.round)) return data.round; // ‚Üê prioritaire chez toi
  if (data && data.roundState && Number.isInteger(data.roundState.round)) return data.roundState.round;
  if (data && data.lastRound && Number.isInteger(data.lastRound.round)) return data.lastRound.round;
  return null;
}

    function listenScores(db, gid, onData){
      if(!db||!gid){ console.warn("[listenScores] db/gid manquant"); return ()=>{}; }
      if(unsubscribeScores){ try{unsubscribeScores();}catch(_){} unsubscribeScores=null; }
      const ref = doc(db, "scores_dame_de_pique", gid);
      unsubscribeScores = onSnapshot(ref, (snap)=>{
        if(!snap.exists()){ onData?.(null); return; }
        const raw = snap.data()||{};
        const totals = extractTotals(raw);
        const round  = extractRound(raw);
        const extra  = { lastRoundPer: (raw.lastRound && Array.isArray(raw.lastRound.perRound)) ? raw.lastRound.perRound : null };
        onData?.({ totals, round, extra, raw });
      }, (err)=> console.error("[listenScores] erreur snapshot:", err));
      return ()=>{ if(unsubscribeScores) unsubscribeScores(); };
    }

    window.ModScores = { listenScores };
  </script>

  <!-- === logic/rounds === -->
  <script type="module">
    function computePassRule(round){ const rules=['√Ä droite','√Ä gauche','Au centre','Garde tes cartes']; return rules[(Math.max(1,round)-1)%4]; }
    function applyRoundScore(){ console.debug('[applyRoundScore] (placeholder)'); }
    function checkGameOver(){ return false; }
    window.ModRounds = { computePassRule, applyRoundScore, checkGameOver };
  </script>

  <!-- === ui/render === -->
  <script type="module">
    const $=(id)=>document.getElementById(id);
    function renderPlayers(){
      const { state } = window.ModInit; const { computePassRule } = window.ModRounds;
      const host=$('playersList'); if(!host) return; host.innerHTML='';
      (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p,idx)=>{
        const row=document.createElement('div'); row.className='line';
        const name=document.createElement('div'); name.textContent=p?.name||`Joueur ${idx+1}`;
        if(idx===state.dealerIndex){ const badge=document.createElement('span'); badge.className='badge'; badge.textContent='Brasseur'; name.appendChild(badge); }
        const val=document.createElement('div'); val.className='muted';
        const key = (p.id!=null)? String(p.id): String(idx);
        const total = Number.isFinite(window.ModInit.state.totals?.[key]) ? window.ModInit.state.totals[key] : 0;
        val.textContent=`Total: ${total}`;
        row.appendChild(name); row.appendChild(val); host.appendChild(row);
      });
      const pass=computePassRule(window.ModInit.state.round);
      const dealerName=(window.ModInit.state.players?.[window.ModInit.state.dealerIndex]?.name)||'‚Äî';
      $('dealerName').textContent=dealerName; $('round').textContent=String(window.ModInit.state.round);
      const meta=document.getElementById('meta');
      if(meta){ meta.innerHTML=`Code soir√©e: <strong id="code">${window.ModInit.state.soireeCode||'‚Äî'}</strong> ‚Ä¢ Tour <span id="round">${window.ModInit.state.round}</span> ‚Ä¢ Brasseur: <strong id="dealerName">${dealerName}</strong>`; }
      const passEl=document.getElementById('passRule'); if(passEl) passEl.textContent=`R√®gle : ${pass}`;
    }
    function renderTotals(){
      const { state } = window.ModInit;
      const host=document.getElementById('totals'); if(!host) return; host.innerHTML='';
      (state.players||[]).forEach((p,idx)=>{
        const line=document.createElement('div'); line.className='line';
        const n=document.createElement('div'); n.textContent=p?.name||`Joueur ${idx+1}`;
        const v=document.createElement('div');
        const key = (p.id!=null)? String(p.id): String(idx);
        const total = Number.isFinite(state.totals?.[key]) ? state.totals[key] : 0;
        v.textContent=String(total);
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });
      const submitted=Object.keys(window.ModInit.state.roundScores||{}).length;
      const expected=(window.ModInit.state.players||[]).length;
      const rs=document.getElementById('roundStatus'); if(rs) rs.textContent=`${submitted}/${expected} soumis`;
    }
    function renderAll(){
      renderPlayers(); renderTotals();
      const { state } = window.ModInit;
      document.body.style.background = (state.myIndex===state.dealerIndex)?'#0f2e16':'var(--bg)';
    }
    window.ModUI = { renderPlayers, renderTotals, renderAll };
  </script>

  <!-- === actions/ui === -->
  <script type="module">
    const $=(id)=>document.getElementById(id);
    function diagnosticsPush(lines){ const d=document.getElementById('diagOutput'); if(d) d.textContent=lines.join('\n'); }
    function wireOpenScore(){ const btn=$('btnOpenScore'); if(!btn||btn.__wired) return; btn.__wired=true; btn.addEventListener('click',(e)=>{ e.preventDefault(); openScoreModal(); },{capture:true}); }
    function wireFinishHold2s(){
      const btn=$('btnFinish'); if(!btn||btn.__wired) return; btn.__wired=true; let timer=null; const fill=btn.querySelector('.fill');
      const start=(ev)=>{ ev.preventDefault?.(); if(fill){ fill.style.transition='none'; fill.style.width='0%'; void fill.offsetWidth; fill.style.transition='width 2s linear'; fill.style.width='100%'; } timer=setTimeout(()=>{ clearTimeout(timer); timer=null; alert('Fin de partie (placeholder) ‚Äî √©criture Firestore v7.6.0'); },2000); };
      const cancel=()=>{ clearTimeout(timer); timer=null; if(fill){ fill.style.transition='none'; fill.style.width='0%'; } };
      ['mousedown','touchstart'].forEach(ev=> btn.addEventListener(ev,start,{passive:false}));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev,cancel));
    }
    function ensureFinishIsLast(){ const main=document.querySelector('main.wrap'); const finish=document.getElementById('finishSection'); if(main&&finish&&main.lastElementChild!==finish){ main.appendChild(finish); } }
    
    // ----- Modal saisie de score (local) -----
    function openScoreModal(){
      const { state } = window.ModInit;
      const backdrop = document.getElementById('modalScoreBackdrop');
      const host = document.getElementById('scoreForm');
      const modalRound = document.getElementById('modalRound');
      const expectedSumEl = document.getElementById('expectedSum');
      const currentSumEl = document.getElementById('currentSum');
      const sumWarn = document.getElementById('sumWarn');

      if(!backdrop || !host) return;
      host.innerHTML = '';
      modalRound.textContent = String(state.round || 1);

      // Somme attendue : si on a une info c√¥t√© scores (lastRound.sum sur le doc), on la r√©utilisera √† la prochaine version.
      // Ici, on estime 26 par d√©faut mais on tol√®re tout (warning seulement).
      const expected = (typeof state.expectedRoundSum === 'number' && state.expectedRoundSum >= 0) ? state.expectedRoundSum : 26;
      expectedSumEl.textContent = String(expected);

      (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p, idx)=>{
        const rowLbl = document.createElement('div'); rowLbl.className='field'; rowLbl.textContent = p?.name || `Joueur ${idx+1}`;
        const rowInp = document.createElement('div'); rowInp.className='field';
        const input = document.createElement('input'); input.type='number'; input.min='0'; input.step='1'; input.value='0'; input.dataset.index=String(idx);
        input.addEventListener('input', updateSum);
        rowInp.appendChild(input);
        host.appendChild(rowLbl); host.appendChild(rowInp);
      });

      function sumInputs(){
        let s=0;
        host.querySelectorAll('input[type=number]').forEach(inp=> s += Number(inp.value)||0);
        return s;
      }
      function updateSum(){
        const s = sumInputs();
        currentSumEl.textContent = String(s);
        if (expected > 0 && s !== expected) {
          sumWarn.textContent = ` (‚â† ${expected})`;
        } else {
          sumWarn.textContent = '';
        }
      }
      updateSum();

      backdrop.style.display='flex';

      const cancel = ()=>{ backdrop.style.display='none'; };
      const save = ()=>{
        // Enregistre localement
        const roundIdx = state.round || 1;
        const arr = [];
        host.querySelectorAll('input[type=number]').forEach(inp=>{
          const v = Number(inp.value)||0; const i = Number(inp.dataset.index)||0; arr[i]=v;
        });
        state.roundScores = state.roundScores || {};
        state.roundScores[String(roundIdx)] = arr;

        // Met √† jour les totaux locaux (additifs) si on veut un feedback visuel imm√©diat
        state.totals = state.totals || {};
        arr.forEach((v,i)=>{
          const key = (state.players?.[i]?.id != null) ? String(state.players[i].id) : String(i);
          const cur = Number(state.totals[key]||0);
          state.totals[key] = cur + v;
        });

        backdrop.style.display='none';
        window.ModUI.renderAll();
      };

      document.getElementById('btnCancelScore')?.addEventListener('click', cancel, {once:true});
      document.getElementById('btnSaveScore')?.addEventListener('click', save, {once:true});
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) cancel(); });
    }


    function onReady(fn){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); } else { fn(); } }

    onReady(async ()=>{
      const { state, boot, ensureAuth } = window.ModInit;
      const { listenSoiree } = window.ModSoiree;
      const { listenScores } = window.ModScores;
      const { renderAll } = window.ModUI;

      await boot(); renderAll(); wireOpenScore(); wireFinishHold2s(); ensureFinishIsLast();
      const notes=[];
      if(!window.firebaseConfig){ notes.push('‚ÑπÔ∏è firebaseConfig manquant ‚Üí lecture d√©sactiv√©e.'); diagnosticsPush(notes); return; }
      notes.push('‚è≥ Auth anonyme‚Ä¶');
      const ctx = await ensureAuth(); const db=ctx?.db, uid=ctx?.uid;
      if(!db){ notes.push('‚ùå Auth/DB indisponible.'); diagnosticsPush(notes); return; }
      notes.push('‚úÖ Auth OK. UID: '+(uid||'(anonyme)'));

      // √âcoute soir√©e
      if(!state.soireeCode){ notes.push('‚ÑπÔ∏è ?code=XXXX manquant ‚Üí pas d\'√©coute soirees.'); diagnosticsPush(notes); return; }
      notes.push('üëÇ √âcoute soirees/'+state.soireeCode+' ‚Ä¶');
      listenSoiree(db, state.soireeCode, (data)=>{
        if(!data){ notes.push('‚ö†Ô∏è Doc soirees inexistant'); diagnosticsPush(notes); return; }
        state.players = Array.isArray(data.players)? data.players : (data.players?.list||[]);
        state.dealerIndex = Number.isInteger(data.leaderIndex)? data.leaderIndex : (data.dealerIndex ?? 0);
        if(Number.isInteger(data.round)) state.round = data.round;
        let dlName = data.leaderName; if(!dlName && Array.isArray(state.players) && state.players[state.dealerIndex]) dlName = state.players[state.dealerIndex]?.name || '‚Äî';
        document.getElementById('dealerName').textContent = dlName || '‚Äî';
        renderAll();
        diagnosticsPush([...notes, 'üì¶ Maj soirees: players='+(state.players?.length||0)+', dealerIndex='+state.dealerIndex+', round='+state.round ]);
      });

      // √âcoute scores (totaux) si gid pr√©sent
      if(state.gameId){
        notes.push('üëÇ √âcoute scores_dame_de_pique/'+state.gameId+' ‚Ä¶');
        listenScores(db, state.gameId, ({ totals, round, extra, raw })=>{
          if(!totals && !round){ notes.push('‚ö†Ô∏è Doc scores sans champs reconnus (totals/standings/lastRound).'); diagnosticsPush(notes); return; }
          if(totals) state.totals = totals;
          if(Number.isInteger(round)) state.round = round;
          if(extra && Array.isArray(extra.lastRoundPer)) state.lastRoundPer = extra.lastRoundPer;
          renderAll();
          diagnosticsPush([...notes, 'üì¶ Maj scores: totals='+(Object.keys(state.totals||{}).length)+', round='+state.round ]);
        });
      } else {
        notes.push('‚ÑπÔ∏è ?gid=... manquant ‚Üí pas d\'√©coute scores.');
        diagnosticsPush(notes);
      }
    });
  </script>
</body>
</html>
