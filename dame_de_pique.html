<!-- Version v7.4.0 ‚Äî 2025-11-13 ‚Äî Zone TEST : √©criture des totaux + ronde + grand chelem dans Firestore -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique ‚Äî v7.4.0 (zone test)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger-pale:#fecaca; --danger-text:#7f1d1d; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:420px; margin:0 auto; padding:18px; display:grid; gap:16px }
    .card{ background:color-mix(in srgb, var(--card) 92%, white 8%); border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    h1{ margin:0 0 4px; font-size:clamp(22px,5vw,28px) }
    .subhead{ margin:0; font-size:clamp(14px,3.5vw,16px); color:var(--muted) }
    .muted{ color:var(--muted) }
    .line{ display:flex; align-items:center; justify-content:space-between; background:#0f1a30; border:1px solid #243252; border-radius:12px; padding:10px 12px; }
    .badge{ display:inline-block; margin-left:10px; padding:4px 8px; border-radius:999px; font-size:.85rem; font-weight:700; background:#fecaca; color:#7f1d1d; vertical-align:middle }
    .btn{ appearance:none; border:none; cursor:pointer; width:65%; min-height:54px; padding:14px; border-radius:14px; font-size:1.2rem; font-weight:800; color:#0c111b; background:#22c55e; display:block; margin:0 auto; transition:opacity .2s ease, transform .02s ease-in-out; will-change: transform; text-align:center; }
    .btn:active{ transform:translateY(1px) } .btn[disabled]{ opacity:.55; cursor:not-allowed }
    .btn-pale-danger{ color:var(--danger-text); background:var(--danger-pale); font-size:.9rem; padding:8px 14px; min-height:36px; }
    .hold2s{ position:relative; overflow:hidden } .hold2s .fill{ position:absolute; inset:0; width:0%; background:rgba(0,0,0,.08); pointer-events:none; transition:width 2s linear }
    .footer{ text-align:center; color:var(--muted); font-size:.95rem }
    @media (min-width:640px){ .wrap{ max-width:520px } }

    /* Fen√™tre modale de saisie de score */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      width:min(520px, 92vw);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    .modal h3{ margin:0 0 6px; font-size:1.15rem; }
    .modal .list-line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
      font-size:.95rem;
    }
    .modal input[type=number]{
      width:90px;
      padding:8px;
      border-radius:10px;
      border:1px solid #35476d;
      background:#0f1a30;
      color:var(--text);
    }
    .modal .toolbar{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:12px;
    }
    .btn-secondary{
      background:#334155;
      color:#e5e7eb;
    }
    .modal .msg{
      margin-top:6px;
      font-size:.9rem;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <header class="card" aria-labelledby="title">
      <h1 id="title">Dame de Pique</h1>
      <h2 id="passRule" class="subhead">R√®gle : ‚Äî</h2>
      <div class="muted" id="meta" style="margin-top:4px">
        Code soir√©e: <strong id="code">‚Äî</strong> ‚Ä¢ Tour <span id="round">1</span> ‚Ä¢ Brasseur: <strong id="dealerName">‚Äî</strong>
      </div>
    </header>

    <section class="card" aria-labelledby="playersTitle">
      <h2 id="playersTitle" style="margin:0 0 8px;font-size:1.2rem">Joueurs</h2>
      <div id="playersList" class="grid" style="display:grid;gap:10px"></div>
    </section>

    <section class="card" aria-labelledby="scoresTitle">
      <h2 id="scoresTitle" style="margin:0 0 8px;font-size:1.2rem">Scores</h2>
      <button id="btnOpenScore" class="btn" type="button" aria-haspopup="dialog" aria-controls="modalScore">
        Inscrire mon pointage
      </button>
      <div id="totals" class="grid" style="display:grid;gap:10px;margin-top:10px"></div>
      <div id="roundStatus" class="muted" aria-live="polite">0/0 soumis</div>
      <div id="roundError" class="muted" aria-live="assertive"></div>
    </section>

    <!-- Fen√™tre modale de saisie de score (m√™me pour tous les joueurs) -->
    <div id="modalScoreBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalScoreTitle">
      <div class="modal">
        <h3 id="modalScoreTitle">Saisie du pointage ‚Äî Ronde <span id="modalRound">1</span></h3>
        <div class="muted" id="modalInfo">
          Chaque joueur ouvre cette fen√™tre depuis le bouton ¬´ Inscrire mon pointage ¬ª.
        </div>

        <div id="modalPlayers" style="margin-top:8px;"></div>

        <div style="margin-top:10px;">
          Mon score pour cette ronde :
          <input id="myScoreInput" type="number" min="0" max="25" step="1" value="0" />
        </div>

        <div id="modalMsg" class="msg muted"></div>

        <div class="toolbar">
          <button id="btnCancelScore" class="btn btn-secondary" type="button">Annuler</button>
          <button id="btnAcceptScore" class="btn" type="button">Accepter</button>
        </div>
      </div>
    </div>

    <details class="card" id="diag" style="font-size:.95rem">
      <summary>Diagnostics</summary>
      <pre id="diagOutput" style="white-space:pre-wrap"></pre>
    </details>

    <section class="card" id="finishSection">
      <button id="btnFinish" class="btn btn-pale-danger hold2s" type="button" aria-label="Fin de partie (maintenir 2 secondes)">
        <span>Fin de partie (maintenir)</span>
        <div class="fill" aria-hidden="true"></div>
      </button>
    </section>

    <div class="footer">v7.4.0 ‚Äî zone test (totaux + ronde + grand chelem dans Firestore)</div>
  </main>

  <!-- Config Firebase -->
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>

  <!-- === init/app === -->
  <script type="module">
    const $ = (id)=>document.getElementById(id);

    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const state = {
      soireeCode: "",
      gameId: "",
      players: [],
      dealerIndex: 0,
      round: 1,
      totals: {},
      roundScores: {},
      isHost: false,
      gameOver: false,
      lastRound: null,
      lastRoundPer: null,
      authUid: null,
      deviceId: null,
      currentInputs: {},
      scoresRaw: null,
      _db: null
    };

    function readUrl(){
      const qs = new URLSearchParams(location.search);
      state.soireeCode = String(qs.get("code")||"").replace(/\D/g,"").slice(0,4);
      state.gameId     = String(qs.get("gid")||"");
      if(state.soireeCode) $("code").textContent = state.soireeCode;
    }

    // R√©solution du deviceId au d√©marrage (URL ?did=... ou localStorage)
    function resolveDeviceIdAtBoot() {
      try {
        const qs = new URLSearchParams(location.search);
        const fromUrl = qs.get("did");
        if (fromUrl) {
          state.deviceId = fromUrl;
          try { localStorage.setItem("deviceId", fromUrl); } catch(_) {}
          return;
        }

        const stored =
          localStorage.getItem("deviceId") ||
          localStorage.getItem("dame_de_pique_deviceId");

        if (stored) {
          state.deviceId = stored;
          return;
        }

        console.warn("[boot] Aucun deviceId trouv√© dans l'URL ni le localStorage.");
      } catch (e) {
        console.warn("[boot] Erreur lors de la r√©solution du deviceId :", e);
      }
    }

    function bootUi(){
      $("round").textContent = String(state.round);
      $("dealerName").textContent = "‚Äî";
    }

    async function ensureAuth(){
      if(!window.firebaseConfig){
        console.warn("[ensureAuth] firebaseConfig manquant ‚Äî lecture d√©sactiv√©e.");
        return null;
      }
      const app = getApps().length ? getApps()[0] : initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);
      state._db  = db;
      try{
        await signInAnonymously(auth);
      }catch(e){
        if(!auth.currentUser) throw e;
      }
      return new Promise((resolve)=>
        onAuthStateChanged(auth, (user)=>{
          state.authUid = user?.uid || null;
          resolve({ app, auth, db, uid: state.authUid });
        })
      );
    }

    function getDb(){ return state._db; }

    async function boot(){
      readUrl();
      resolveDeviceIdAtBoot();
      bootUi();
    }

    window.ModInit = { state, boot, ensureAuth, getDb };
  </script>

  <!-- === data/soiree === -->
  <script type="module">
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    let unsubscribeSoiree=null;
    function listenSoiree(db, code, onData){
      if(!db||!code){ console.warn("[listenSoiree] db/code manquant"); return ()=>{}; }
      if(unsubscribeSoiree){ try{unsubscribeSoiree();}catch(_){} unsubscribeSoiree=null; }
      const ref = doc(db,"soirees",code);
      unsubscribeSoiree = onSnapshot(
        ref,
        (snap)=>{
          if(!snap.exists()){ onData?.(null); return; }
          onData?.(snap.data()||{});
        },
        (err)=> console.error("[listenSoiree] erreur snapshot:",err)
      );
      return ()=>{ if(unsubscribeSoiree) unsubscribeSoiree(); };
    }
    window.ModSoiree = { listenSoiree };
  </script>

  <!-- === data/scores === (adaptatif) -->
  <script type="module">
    import { doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    let unsubscribeScores=null;

    function extractTotals(data){
      // 1) totals direct (objet)
      if (data && typeof data.totals === 'object' && !Array.isArray(data.totals)) {
        const t = data.totals;
        const keys = Object.keys(t);
        const looksLikePN = keys.length && keys.every(k => /^p\d+$/i.test(k));
        if (looksLikePN) {
          const out = {};
          for (const k of keys) {
            const n = parseInt(k.slice(1), 10);
            const idx = Number.isFinite(n) ? n-1 : null;
            if (idx != null && idx >= 0) out[String(idx)] = Number(t[k]) || 0;
          }
          return out;
        }
        return t;
      }

      // 2) standings.totals (si jamais utilis√© plus tard)
      if (data && data.standings && typeof data.standings.totals === 'object') {
        return data.standings.totals;
      }

      // 3) standings objet simple
      if (data && data.standings && typeof data.standings === 'object' && !Array.isArray(data.standings)) {
        return data.standings;
      }

      // 4) lastRound.perRound comme fallback (dernier tour uniquement)
      if (data && data.lastRound && Array.isArray(data.lastRound.perRound)) {
        const o = {}; data.lastRound.perRound.forEach((v,i)=> o[String(i)] = Number(v)||0);
        return o;
      }

      return null;
    }

    function extractRound(data){
      if (data && Number.isInteger(data.round)) return data.round;
      if (data && data.roundState && Number.isInteger(data.roundState.round)) return data.roundState.round;
      if (data && data.lastRound && Number.isInteger(data.lastRound.round)) return data.lastRound.round;
      return null;
    }

    function listenScores(db, gid, onData){
      if(!db||!gid){ console.warn("[listenScores] db/gid manquant"); return ()=>{}; }
      if(unsubscribeScores){ try{unsubscribeScores();}catch(_){} unsubscribeScores=null; }
      const ref = doc(db, "scores_dame_de_pique", gid);
      unsubscribeScores = onSnapshot(
        ref,
        (snap)=>{
          if(!snap.exists()){ onData?.(null); return; }
          const raw = snap.data()||{};
          const inputs = (raw.inputs && typeof raw.inputs === "object" && !Array.isArray(raw.inputs))
            ? raw.inputs
            : {};
          try{
            if (window.ModInit && window.ModInit.state) {
              window.ModInit.state.currentInputs = inputs;
              window.ModInit.state.scoresRaw = raw;
            }
          }catch(_){}

          const totals = extractTotals(raw);
          const round  = extractRound(raw);
          const extra  = { lastRoundPer: (raw.lastRound && Array.isArray(raw.lastRound.perRound)) ? raw.lastRound.perRound : null };
          onData?.({ totals, round, extra, raw });
        },
        (err)=> console.error("[listenScores] erreur snapshot:", err)
      );
      return ()=>{ if(unsubscribeScores) unsubscribeScores(); };
    }

    async function submitScoreForCurrentDevice(score){
      const mod = window.ModInit || {};
      const state = mod.state || {};
      const getDb = mod.getDb;
      if (!getDb) {
        console.warn("[submitScore] getDb absent");
        return;
      }
      const db = getDb();
      if (!db) {
        console.warn("[submitScore] DB indisponible");
        return;
      }
      if (!state.gameId) {
        console.warn("[submitScore] gameId manquant");
        return;
      }
      if (!state.deviceId) {
        console.warn("[submitScore] deviceId non initialis√© (v√©rifier resolveDeviceIdAtBoot).");
        return;
      }
      const s = Number(score);
      if (!Number.isFinite(s)) {
        console.warn("[submitScore] score invalide");
        return;
      }

      const ref = doc(db, "scores_dame_de_pique", state.gameId);
      try{
        await updateDoc(ref, { ["inputs."+state.deviceId]: s });
      }catch(e){
        console.error("[submitScore] erreur updateDoc:", e);
      }
    }

    window.ModScores = { listenScores, submitScoreForCurrentDevice };
  </script>

  <!-- === logic/rounds === -->
  <script type="module">
    import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    function computePassRule(round){
      const rules=['√Ä droite','√Ä gauche','Au centre','Garde tes cartes'];
      return rules[(Math.max(1,round)-1)%4];
    }

    // Calcule un r√©sum√© de ronde √† partir des inputs Firestore (local, sans √©criture)
    function computeRoundSummary(players, inputs){
      const ordered = (players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
      const perRound = [];
      let sum = 0;
      let filledCount = 0;

      ordered.forEach((p, idx) => {
        const did = p && p.deviceId;
        let v = null;
        if (did && inputs && Object.prototype.hasOwnProperty.call(inputs, did)) {
          v = Number(inputs[did]);
          if (!Number.isFinite(v)) v = 0;
          filledCount++;
        }
        perRound[idx] = v;
        if (v != null) sum += v;
      });

      const expected = ordered.length;
      const isComplete = expected > 0 && filledCount === expected;
      const isValid25 = isComplete && sum === 25;

      // Grand Chelem : un seul joueur √† 25, tous les autres √† 0
      let grandIndex = -1;
      let isGrand = false;
      if (isComplete && isValid25) {
        const nonZero = [];
        perRound.forEach((v,i)=>{
          if (v && v > 0) nonZero.push({v,i});
        });
        if (nonZero.length === 1 && nonZero[0].v === 25) {
          isGrand = true;
          grandIndex = nonZero[0].i;
        }
      }

      return {
        perRound,
        sum,
        isComplete,
        isValid25,
        isGrandChelem: isGrand,
        grandChelemIndex: grandIndex
      };
    }

    // √âcrit la ronde et les totaux dans Firestore quand la somme vaut 25
    async function applyRoundScore(summary){
      const mod = window.ModInit || {};
      const state = mod.state || {};
      const getDb = mod.getDb;

      if (!getDb) {
        console.warn('[applyRoundScore] getDb absent');
        return;
      }
      const db = getDb();
      if (!db) {
        console.warn('[applyRoundScore] DB indisponible');
        return;
      }
      if (!state.gameId) {
        console.warn('[applyRoundScore] gameId manquant');
        return;
      }
      if (!summary || !summary.isComplete || !summary.isValid25) {
        return; // rien √† faire si la ronde n'est pas compl√®te ou invalide
      }

      const playersOrdered = (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
      const n = playersOrdered.length;
      if (!n) return;

      // Totaux de base (normalis√©s "0","1",...)
      const baseTotals = [];
      for (let i=0;i<n;i++){
        const key = String(i);
        baseTotals[i] = Number(state.totals?.[key] || 0);
      }

      // Points de la ronde (apr√®s √©ventuel Grand Chelem)
      let roundVals = summary.perRound.slice();
      if (summary.isGrandChelem && summary.grandChelemIndex >= 0) {
        roundVals = roundVals.map((v,idx)=> idx===summary.grandChelemIndex ? 0 : 25);
      }

      const newTotalsArr = baseTotals.map((t,i)=> t + (Number(roundVals[i])||0));

      // D√©termination de fin de partie
      let gameOver = false;
      let winnerId = null;
      let maxTotal = -Infinity;
      newTotalsArr.forEach(v => { if (v>maxTotal) maxTotal = v; });
      if (Number.isFinite(maxTotal) && maxTotal >= 100) {
        gameOver = true;
        let minTotal = Infinity;
        let winIndex = -1;
        newTotalsArr.forEach((v,i)=>{
          if (v < minTotal) {
            minTotal = v;
            winIndex = i;
          }
        });
        if (winIndex >= 0 && playersOrdered[winIndex] && playersOrdered[winIndex].deviceId) {
          winnerId = playersOrdered[winIndex].deviceId;
        }
      }

      // Map "p1","p2",... pour compatibilit√© avec ton schema existant
      const totalsMap = {};
      newTotalsArr.forEach((v,i)=>{
        totalsMap['p'+(i+1)] = v;
      });

      const roundNumber = state.round || 1;

      const ref = doc(db, 'scores_dame_de_pique', state.gameId);
      const payload = {
        lastRound: {
          appliedGrandChelem: !!summary.isGrandChelem,
          controleIndex: -1,
          perRound: roundVals,
          round: roundNumber,
          sum: roundVals.reduce((a,b)=> a + (Number(b)||0), 0),
          values: roundVals
        },
        totals: totalsMap,
        round: roundNumber + 1,
        gameOver: gameOver,
        winnerId: gameOver ? (winnerId || null) : null,
        roundError: "",
        // on vide les inputs pour forcer une nouvelle saisie √† la ronde suivante
        inputs: {}
      };

      try{
        await updateDoc(ref, payload);
        console.debug('[applyRoundScore] Ronde appliqu√©e et totaux mis √† jour.');
      }catch(e){
        console.error('[applyRoundScore] erreur updateDoc:', e);
      }
    }

    function checkGameOver(){ return false; } // pas utilis√© directement ici

    window.ModRounds = { computePassRule, computeRoundSummary, applyRoundScore, checkGameOver };
  </script>

  <!-- === ui/render === -->
  <script type="module">
    const $=(id)=>document.getElementById(id);

    function renderPlayers(){
      const { state } = window.ModInit;
      const { computePassRule } = window.ModRounds;
      const host=$('playersList'); if(!host) return; host.innerHTML='';
      (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0)).forEach((p,idx)=>{
        const row=document.createElement('div'); row.className='line';
        const name=document.createElement('div'); name.textContent=p?.name||`Joueur ${idx+1}`;
        if(idx===state.dealerIndex){
          const badge=document.createElement('span'); badge.className='badge'; badge.textContent='Brasseur'; name.appendChild(badge);
        }
        const val=document.createElement('div'); val.className='muted';
        const key = (p.id!=null)? String(p.id): String(idx);
        const total = Number.isFinite(window.ModInit.state.totals?.[key]) ? window.ModInit.state.totals[key] : 0;
        val.textContent=`Total: ${total}`;
        row.appendChild(name); row.appendChild(val); host.appendChild(row);
      });
      const pass=computePassRule(window.ModInit.state.round);
      const dealerName=(window.ModInit.state.players?.[window.ModInit.state.dealerIndex]?.name)||'‚Äî';
      $('dealerName').textContent=dealerName; $('round').textContent=String(window.ModInit.state.round);
      const meta=document.getElementById('meta');
      if(meta){
        meta.innerHTML=`Code soir√©e: <strong id="code">${window.ModInit.state.soireeCode||'‚Äî'}</strong> ‚Ä¢ Tour <span id="round">${window.ModInit.state.round}</span> ‚Ä¢ Brasseur: <strong id="dealerName">${dealerName}</strong>`;
      }
      const passEl=document.getElementById('passRule'); if(passEl) passEl.textContent=`R√®gle : ${pass}`;
    }

    function renderTotals(){
      const { state } = window.ModInit;
      const host=document.getElementById('totals'); if(!host) return; host.innerHTML='';

      (state.players||[]).forEach((p,idx)=>{
        const line=document.createElement('div'); line.className='line';
        const n=document.createElement('div'); n.textContent=p?.name||`Joueur ${idx+1}`;
        const v=document.createElement('div');
        const key = (p.id!=null)? String(p.id): String(idx);
        const total = Number.isFinite(state.totals?.[key]) ? state.totals[key] : 0;
        v.textContent=String(total);
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });

      // Statut de la ronde bas√© sur les inputs Firestore
      const inputs = state.currentInputs || {};
      const submitted = Object.keys(inputs).length;
      const expected = (state.players||[]).length;
      const rs = document.getElementById('roundStatus');
      if (rs) rs.textContent = `${submitted}/${expected} soumis`;

      const re = document.getElementById('roundError');
      if (re) {
        const { computeRoundSummary, applyRoundScore } = window.ModRounds;
        const summary = computeRoundSummary(state.players, inputs);

        if (!summary.isComplete) {
          re.textContent = "";
        } else if (!summary.isValid25) {
          re.textContent = `Erreur: la somme des scores est ${summary.sum}, elle doit √™tre exactement 25.`;
        } else if (summary.isGrandChelem) {
          const ordered = (state.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
          const winnerPlayer = ordered[summary.grandChelemIndex];
          const nm = winnerPlayer?.name || `Joueur ${summary.grandChelemIndex+1}`;
          re.textContent = `Grand chelem d√©tect√© pour ${nm} (25). Les totaux seront ajust√©s (0 pour ${nm}, 25 pour les autres).`;
          applyRoundScore(summary);
        } else {
          re.textContent = `OK : tous les scores sont saisis et la somme est 25. Les totaux sont mis √† jour pour la prochaine ronde.`;
          applyRoundScore(summary);
        }
      }
    }

    function renderAll(){
      renderPlayers();
      renderTotals();
      const { state } = window.ModInit;
      document.body.style.background = (state.myIndex===state.dealerIndex)?'#0f2e16':'var(--bg)';
    }

    window.ModUI = { renderPlayers, renderTotals, renderAll };
  </script>

  <!-- === actions/ui === -->
  <script type="module">
    const $=(id)=>document.getElementById(id);

    function diagnosticsPush(lines){
      const d=document.getElementById('diagOutput');
      if(d) d.textContent=lines.join('\n');
    }

    function wireOpenScore(){
      const btn=$('btnOpenScore'); if(!btn||btn.__wired) return; btn.__wired=true;
      btn.addEventListener('click',(e)=>{ e.preventDefault(); openScoreModal(); },{capture:true});
    }

    function wireFinishHold2s(){
      const btn=$('btnFinish'); if(!btn||btn.__wired) return; btn.__wired=true; let timer=null; const fill=btn.querySelector('.fill');
      const start=(ev)=>{
        ev.preventDefault?.();
        if(fill){
          fill.style.transition='none';
          fill.style.width='0%';
          void fill.offsetWidth;
          fill.style.transition='width 2s linear';
          fill.style.width='100%';
        }
        timer=setTimeout(()=>{
          clearTimeout(timer); timer=null;
          alert('Fin de partie (placeholder) ‚Äî √©criture Firestore v7.6.0');
        },2000);
      };
      const cancel=()=>{
        clearTimeout(timer); timer=null;
        if(fill){ fill.style.transition='none'; fill.style.width='0%'; }
      };
      ['mousedown','touchstart'].forEach(ev=> btn.addEventListener(ev,start,{passive:false}));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev,cancel));
    }

    function ensureFinishIsLast(){
      const main=document.querySelector('main.wrap');
      const finish=document.getElementById('finishSection');
      if(main&&finish&&main.lastElementChild!==finish){
        main.appendChild(finish);
      }
    }

    // Fen√™tre modale de saisie de score (synchro Firestore)
    function openScoreModal(){
      const { state } = window.ModInit;
      const backdrop = document.getElementById('modalScoreBackdrop');
      const listEl   = document.getElementById('modalPlayers');
      const roundEl  = document.getElementById('modalRound');
      const inputEl  = document.getElementById('myScoreInput');
      const msgEl    = document.getElementById('modalMsg');

      if(!backdrop || !listEl || !roundEl || !inputEl || !msgEl){
        console.warn('[openScoreModal] √©l√©ments manquants dans le DOM.');
        return;
      }

      msgEl.textContent = '';
      roundEl.textContent = String(state.round || 1);

      const players = state.players || [];
      const inputs = state.currentInputs || {};

      // Liste des joueurs avec leur score de ronde courant
      listEl.innerHTML = '';
      players.forEach((p, idx) => {
        const line = document.createElement('div');
        line.className = 'list-line';
        const left = document.createElement('div');
        left.textContent = (p && p.name) ? p.name : `Joueur ${idx+1}`;
        const right = document.createElement('div');
        const did = p && p.deviceId;
        const v = (did && Object.prototype.hasOwnProperty.call(inputs, did)) ? inputs[did] : null;
        right.textContent = (v != null) ? `${v} pts` : '‚Äî';
        line.appendChild(left);
        line.appendChild(right);
        listEl.appendChild(line);
      });

      // Pr√©-remplir mon score si d√©j√† saisi
      let myVal = "";
      if (state.deviceId && inputs && Object.prototype.hasOwnProperty.call(inputs, state.deviceId)) {
        myVal = String(inputs[state.deviceId]);
      }
      inputEl.value = myVal;
      inputEl.focus();
      backdrop.style.display = 'flex';

      const close = () => {
        backdrop.style.display = 'none';
        msgEl.textContent = '';
      };

      const onCancel = () => {
        close();
      };

      const onAccept = async () => {
        const raw = inputEl.value.trim();
        const val = Number(raw);
        if (!Number.isFinite(val) || val < 0 || val > 25) {
          msgEl.textContent = "Le score doit √™tre un nombre entre 0 et 25.";
          return;
        }
        msgEl.textContent = "Enregistrement...";
        try{
          if (window.ModScores && window.ModScores.submitScoreForCurrentDevice) {
            await window.ModScores.submitScoreForCurrentDevice(val);
            msgEl.textContent = "Score envoy√©.";
          }else{
            msgEl.textContent = "Module scores indisponible (aucune √©criture).";
          }
        }catch(e){
          console.error("[openScoreModal] erreur lors de submitScore:", e);
          msgEl.textContent = "Erreur lors de l'enregistrement du score.";
        }
        setTimeout(close, 600);
      };

      // ENTER d√©clenche ¬´ Accepter ¬ª
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          onAccept();
        }
      });

      document.getElementById('btnCancelScore')?.addEventListener('click', onCancel, { once:true });
      document.getElementById('btnAcceptScore')?.addEventListener('click', onAccept, { once:true });

      // Fermer si clic en dehors de la bo√Æte
      backdrop.addEventListener('click', function onBackdrop(e){
        if(e.target === backdrop){
          backdrop.removeEventListener('click', onBackdrop);
          close();
        }
      });
    }

    function onReady(fn){
      if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', fn, {once:true});
      } else {
        fn();
      }
    }

    onReady(async ()=>{
      const { state, boot, ensureAuth } = window.ModInit;
      const { listenSoiree } = window.ModSoiree;
      const { listenScores } = window.ModScores;
      const { renderAll } = window.ModUI;

      await boot();
      renderAll();
      wireOpenScore();
      wireFinishHold2s();
      ensureFinishIsLast();

      const notes=[];
      if(!window.firebaseConfig){
        notes.push('‚ÑπÔ∏è firebaseConfig manquant ‚Üí lecture d√©sactiv√©e.');
        diagnosticsPush(notes);
        return;
      }
      notes.push('‚è≥ Auth anonyme‚Ä¶');
      const ctx = await ensureAuth();
      const db=ctx?.db, uid=ctx?.uid;
      if(!db){
        notes.push('‚ùå Auth/DB indisponible.');
        diagnosticsPush(notes);
        return;
      }
      notes.push('‚úÖ Auth OK. UID: '+(uid||'(anonyme)'));

      // √âcoute soir√©e
      if(!state.soireeCode){
        notes.push('‚ÑπÔ∏è ?code=XXXX manquant ‚Üí pas d\'√©coute soirees.');
        diagnosticsPush(notes);
        return;
      }
      notes.push('üëÇ √âcoute soirees/'+state.soireeCode+' ‚Ä¶');
      listenSoiree(db, state.soireeCode, (data)=>{
        if(!data){
          notes.push('‚ö†Ô∏è Doc soirees inexistant');
          diagnosticsPush(notes);
          return;
        }
        state.players = Array.isArray(data.players)? data.players : (data.players?.list||[]);
        state.dealerIndex = Number.isInteger(data.leaderIndex)? data.leaderIndex : (data.dealerIndex ?? 0);
        if(Number.isInteger(data.round)) state.round = data.round;
        let dlName = data.leaderName;
        if(!dlName && Array.isArray(state.players) && state.players[state.dealerIndex]){
          dlName = state.players[state.dealerIndex]?.name || '‚Äî';
        }
        document.getElementById('dealerName').textContent = dlName || '‚Äî';
        renderAll();
        diagnosticsPush([
          ...notes,
          'üì¶ Maj soirees: players='+(state.players?.length||0)+', dealerIndex='+state.dealerIndex+', round='+state.round
        ]);
      });

      // √âcoute scores (totaux + inputs) si gid pr√©sent
      if(state.gameId){
        notes.push('üëÇ √âcoute scores_dame_de_pique/'+state.gameId+' ‚Ä¶');
        listenScores(db, state.gameId, ({ totals, round, extra, raw })=>{
          const inputs = window.ModInit.state.currentInputs || {};
          const inputsCount = Object.keys(inputs).length;

          // M√™me sans totals/round, on veut rafra√Æchir l'affichage
          if(!totals && !round){
            diagnosticsPush([
              ...notes,
              `‚ÑπÔ∏è Doc scores sans champs totals/round (inputs=${inputsCount}).`
            ]);
            renderAll();   // relance la validation 25 / grand chelem
            return;
          }

          if(totals) state.totals = totals;
          if(Number.isInteger(round)) state.round = round;
          if(extra && Array.isArray(extra.lastRoundPer)) state.lastRoundPer = extra.lastRoundPer;

          renderAll();
          diagnosticsPush([
            ...notes,
            'üì¶ Maj scores: totals='+(Object.keys(state.totals||{}).length)+', round='+state.round+`, inputs=${inputsCount}`
          ]);
        });
      } else {
        notes.push('‚ÑπÔ∏è ?gid=... manquant ‚Üí pas d\'√©coute scores.');
        diagnosticsPush(notes);
      }
    });
  </script>
</body>
</html>
