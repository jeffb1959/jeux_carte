<!-- Version: v4.9.1 (2025-11-05) -->
<!-- Dame de Pique — Ajout logique nbScr et validation du tour -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — Saisie du score</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#243252; --dealer:#0b5a29; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    body.dealer{ background: linear-gradient(180deg, var(--dealer), #062612 60%); }
    .wrap{max-width:390px;margin:0 auto;padding:16px;display:grid;gap:16px;place-items:center}
    .titleRow{display:flex;align-items:baseline;justify-content:space-between;gap:12px;width:100%}
    h1{margin:0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(15px,4vw,18px)}
    .brasseur{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brName{font-size:clamp(18px,5vw,22px);font-weight:700;color:var(--accent)}
    .swap{font-size:clamp(14px,4vw,16px);color:var(--muted)}
    .card{width:100%;background:color-mix(in srgb, var(--card) 90%, white 10%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .name{font-size:clamp(15px,4vw,18px)}
    .pts{font-size:clamp(22px,6vw,30px);font-variant-numeric:tabular-nums}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
    .modal.show{display:grid}
    .sheet{width:min(92vw,390px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--warn);font-size:0.9rem;text-align:center}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="lbl">Tour n° <span id="round">1</span></div>
    </header>

    <div class="brasseur">
      <div>Brasseur : <span id="dealerName" class="brName">—</span></div>
      <div class="swap" id="swapInfo">—</div>
    </div>

    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn">Inscrire le pointage</button>
      <div id="msg" class="msg"></div>
    </section>

    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl">Soirée #<span id="code">----</span></div>
    </section>

    <div class="footer">
      <a class="back" href="selection_jeux.html">← Retour</a>
    </div>

    <div class="modal" id="modal">
      <div class="sheet">
        <h3>Saisir mon score</h3>
        <div class="row">
          <input id="scoreInput" class="inp" type="number" min="0" max="25" step="1" placeholder="0–25" />
          <button id="btnSaveScore" class="btn">Valider</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const firebaseConfig = { apiKey:'AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg', authDomain:'soireecartev2.firebaseapp.com', projectId:'soireecartev2' };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const CODE = (qs.get('code')||'').replace(/\D/g,'').slice(0,4);
    const GID  = qs.get('gid');

    const DEVICE_ID = localStorage.getItem('deviceId') || (Date.now()+ '_' + Math.random().toString(36).slice(2));
    localStorage.setItem('deviceId', DEVICE_ID);

    const $ = (id)=>document.getElementById(id);
    const setText = (id, text)=>{ const el=$(id); if(el) el.textContent = text; };

    function ensureTotalsBox(){
      let box=document.getElementById('totalsList');
      if(!box){
        const host=document.getElementById('totalsCard');
        box=document.createElement('div');
        box.id='totalsList';
        box.className='grid';
        host.appendChild(box);
      }
      return box;
    }

    function renderTotals(players, totals){
      const box = ensureTotalsBox();
      box.innerHTML='';
      (players||[]).forEach((p,i)=>{
        const line=document.createElement('div');
        line.className='line';
        line.innerHTML=`<div>${p?.name||'—'}</div><div>${Number((totals||[])[i]||0)}</div>`;
        box.appendChild(line);
      });
    }

    async function ensureAuth(){ try{ await signInAnonymously(auth); }catch(e){ console.warn('Auth error',e); } }

    const state={ players:[], totals:[], round:1, nbScr:0 };

    function tryRender(){ setText('round', state.round); renderTotals(state.players, state.totals); }

    function showMsg(t){ $('#msg').textContent=t; setTimeout(()=>$('#msg').textContent='',4000); }

    async function saveScore(){
      const val=Number($('#scoreInput').value||0);
      if(isNaN(val)) return;
      const snap=await getDoc(doc(db,'scores_dame_de_pique',GID));
      if(!snap.exists()) return;
      const g=snap.data();
      const nbScr=(g.nbScr||0)+1;
      const scores=g.scores||[];
      scores.push(val);
      await updateDoc(doc(db,'scores_dame_de_pique',GID),{scores,nbScr});
      $('#modal').classList.remove('show');
      $('#btnOpen').disabled=true;
      showMsg('Score enregistré.');
    }

    async function validateIfComplete(){
      const gSnap=await getDoc(doc(db,'scores_dame_de_pique',GID));
      if(!gSnap.exists()) return;
      const g=gSnap.data();
      if((g.nbScr||0)>=(state.players.length||0)){
        let total=(g.scores||[]).reduce((a,b)=>a+Number(b||0),0);
        if(total!==25){
          await updateDoc(doc(db,'scores_dame_de_pique',GID),{nbScr:0,scores:[]});
          showMsg('Erreur : total ≠ 25, recommencez la saisie.');
          return;
        }
        const newTotals=(state.totals||[]).map((t,i)=>t+Number(g.scores[i]||0));
        await updateDoc(doc(db,'scores_dame_de_pique',GID),{totals:newTotals,round:(state.round||1)+1,nbScr:0,scores:[]});
        showMsg('Tour validé !');
        $('#btnOpen').disabled=false;
      }
    }

    function wireModal(){
      const modal=$('#modal');
      $('#btnOpen')?.addEventListener('click',()=> modal.classList.add('show'));
      $('#btnSaveScore')?.addEventListener('click',async()=>{await saveScore();await validateIfComplete();});
    }

    async function init(){
      await ensureAuth();
      setText('code',CODE||'----');
      wireModal();

      onSnapshot(doc(db,'soirees',CODE),s=>{
        if(!s.exists())return;
        const d=s.data();
        state.players=(d.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
        setText('dealerName',d.leaderName||'—');
        setText('swapInfo',(d.currentGame?.type==='dame_de_pique')?'Échange actif':'—');
        const isDealerDevice=d?.leaderDeviceId&&d.leaderDeviceId===DEVICE_ID;
        document.body.classList.toggle('dealer',!!isDealerDevice);
        tryRender();
      });

      if(GID){
        onSnapshot(doc(db,'scores_dame_de_pique',GID),s=>{
          if(!s.exists())return;
          const g=s.data();
          state.round=g.round||1;
          state.totals=g.totals||[];
          state.nbScr=g.nbScr||0;
          tryRender();
        });
      }
    }

    window.addEventListener('DOMContentLoaded',()=>{ensureTotalsBox();init();});
  // PATCH v4.9.1 – modal activation + leader gating + nbScr
// Variables de suivi (globales)
window.nbScr = window.nbScr || 0;
window.nbPlayers = window.nbPlayers || 0;

function openModal(){ const m=document.getElementById('modal'); if(m) m.classList.add('show'); }
function closeModal(){ const m=document.getElementById('modal'); if(m) m.classList.remove('show'); }

// Active les boutons de la modale et désactive localement après validation
window.addEventListener('DOMContentLoaded', ()=>{
  const openBtn = document.getElementById('btnOpen');
  const saveBtn = document.getElementById('btnSaveScore');
  if(openBtn && !openBtn.__wired){ openBtn.__wired=true; openBtn.addEventListener('click', openModal); }
  if(saveBtn && !saveBtn.__wired){ saveBtn.__wired=true; saveBtn.addEventListener('click', ()=>{
      window.nbScr++;
      closeModal();
      const b=document.getElementById('btnOpen');
      if(b) b.disabled = true; // désactive ce joueur localement
      // Si tout le monde a validé, réinitialiser et tenter la finalisation
      if(window.nbPlayers>0 && window.nbScr>=window.nbPlayers){
        window.nbScr = 0;
        if(typeof finalizeRound==='function'){ try{ finalizeRound(window.__lastGameState||{}); }catch(_){} }
        // Réactive localement après un court délai si aucune logique distante ne s'en charge
        setTimeout(()=>{ const bb=document.getElementById('btnOpen'); if(bb) bb.disabled=false; }, 800);
      }
  }); }
});

// Écoute légère pour garder en mémoire l'état de jeu et le nombre de joueurs
try{
  import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js').then(({getFirestore, doc, onSnapshot})=>{
    // Récupération des paramètres existants dans la page
    const qs = new URLSearchParams(location.search);
    const CODE = (qs.get('code')||'').replace(/[^0-9]/g,'').slice(0,4);
    const GID  = qs.get('gid');
    // Réutilise l'instance Firestore déjà initialisée par la page
    const db = window.__firebaseDb || window.db || getFirestore();
    if(CODE){
      onSnapshot(doc(db,'soirees',CODE), s=>{
        if(!s.exists()) return;
        const d=s.data();
        window.nbPlayers = Array.isArray(d.players) ? d.players.length : 0;
        // Gating du bouton par appareil brasseur (leader)
        const DEVICE_ID = localStorage.getItem('deviceId');
        const isLeaderDevice = d?.leaderDeviceId && DEVICE_ID && d.leaderDeviceId === DEVICE_ID;
        const btn = document.getElementById('btnOpen');
        if(btn) btn.disabled = !isLeaderDevice;
        if(document && document.body && document.body.classList){ document.body.classList.toggle('dealer', !!isLeaderDevice); }
      });
    }
    if(GID){
      onSnapshot(doc(db,'scores_dame_de_pique',GID), s=>{
        if(!s.exists()) return;
        window.__lastGameState = s.data()||{};
      });
    }
  }).catch(()=>{});
}catch(_){}

</script>
</body>
</html>
