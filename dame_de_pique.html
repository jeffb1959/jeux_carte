<!-- Version: v4.7 (2025-11-04) -->
<!-- Dame de Pique — Fix: handle Firestore permission errors + sandbox fallback + clear guidance -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — Saisie du score</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#243252; --dealer:#0b5a29; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    body.dealer{ background: linear-gradient(180deg, var(--dealer), #062612 60%); }
    .wrap{max-width:390px;margin:0 auto;padding:16px;display:grid;gap:16px;place-items:center}
    .titleRow{display:flex;align-items:baseline;justify-content:space-between;gap:12px;width:100%}
    h1{margin:0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(15px,4vw,18px)}

    .brasseur{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brName{font-size:clamp(18px,5vw,22px);font-weight:700;color:var(--accent)}
    .swap{font-size:clamp(14px,4vw,16px);color:var(--muted)}

    .card{width:100%;background:color-mix(in srgb, var(--card) 90%, white 10%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}

    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn.ghost{background:transparent;color:#cfe1ff;border:1px solid #3a4a6a}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}

    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .name{font-size:clamp(15px,4vw,18px)}
    .pts{font-size:clamp(22px,6vw,30px);font-variant-numeric:tabular-nums}

    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}

    .testBanner{width:100%;background:#facc15;color:#111;font-weight:700;text-align:center;padding:8px;border-radius:10px;border:1px solid #854d0e}
    .errBox{display:none;background:#2b0e12;border:1px solid #6b1f28;color:#ffd6db;padding:12px;border-radius:12px}
    .errBox pre{white-space:pre-wrap;margin:8px 0 0 0}
  </style>
</head>
<body>
  <main class="wrap">
    <div id="testBanner" class="testBanner" style="display:none;">⚠️ Mode test — non enregistré pour les statistiques finales</div>

    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="lbl">Tour n° <span id="round">1</span></div>
    </header>

    <div class="brasseur">
      <div>Brasseur : <span id="dealerName" class="brName">—</span></div>
      <div class="swap" id="swapInfo">—</div>
    </div>

    <section class="card grid" aria-labelledby="lblSaisie">
      <div id="lblSaisie" class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn">Inscrire le pointage</button>
    </section>

    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl">Soirée #<span id="code">----</span></div>
    </section>

    <section id="testSection" class="card grid" style="display:none;background:#facc15;color:#111;">
      <div><strong>Mode test</strong> : aucune donnée finale enregistrée</div>
      <button id="btnCreateTest" class="btn" style="background:#4f46e5;color:#fff;">Créer une partie de test</button>
    </section>

    <section id="permHelp" class="errBox">
      <strong>Problème d'accès Firestore</strong> — Permissions insuffisantes.<br/>
      <ul style="margin:8px 0 0 18px;line-height:1.4">
        <li>Active <em>Auth → Sign-in method → Anonymous</em> dans Firebase.</li>
        <li>Règles Firestore pendant le développement :
          <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</pre>
        </li>
        <li>Recharge ensuite cette page.</li>
      </ul>
      <div style="margin-top:8px">Astuce : utilisez le bouton « Créer une partie de test » (sandbox local) pour continuer vos essais.</div>
    </section>

    <div class="footer">
      <a class="back" href="selection_jeux.html">← Retour</a>
    </div>
  </main>

  <!-- Scripts essentiels + mode test -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, addDoc, collection, getDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const firebaseConfig = { apiKey:'AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg', authDomain:'soireecartev2.firebaseapp.com', projectId:'soireecartev2', storageBucket:'soireecartev2.firebasestorage.app', messagingSenderId:'784781686361', appId:'1:784781686361:web:033693cb22fb1a55af2348' };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const CODE = (qs.get('code')||'').replace(/\D/g,'').slice(0,4);
    const GID  = qs.get('gid')||null;

    const DEVICE_ID = localStorage.getItem('deviceId') || (Date.now()+'_'+Math.random().toString(36).slice(2));
    localStorage.setItem('deviceId', DEVICE_ID);

    const $ = (id)=>document.getElementById(id);

    let USE_SANDBOX = false; // bascule auto si permission-denied

    async function ensureAuth(){
      try{ await signInAnonymously(auth); }
      catch(e){ console.warn('Auth error', e); showPermsHelp(e); }
    }

    function showPermsHelp(err){
      const box = $('#permHelp');
      if(!box) return;
      box.style.display='block';
      if(err) {
        const pre = document.createElement('pre');
        pre.textContent = String(err.message||err);
        box.appendChild(pre);
      }
    }

    function enableSandboxBanner(){
      USE_SANDBOX = true;
      $('#testBanner').style.display='block';
      $('#testSection').style.display='block';
    }

    async function createTestGame(){
      await ensureAuth();
      try{
        const ref = await addDoc(collection(db,'scores_dame_de_pique'),{
          round:1, totals:[], currentInputs:{}, confirmedInputs:{}, createdAt:serverTimestamp(), state:'active', test:true
        });
        const gid = ref.id;
        location.href = `dame_de_pique.html?code=${CODE||'0000'}&gid=${gid}`;
      }catch(e){
        console.warn('createTestGame permission issue', e);
        showPermsHelp(e);
        enableSandboxBanner();
        const gid = 'local-'+Date.now().toString(36);
        const key = `sandbox_dp_${gid}`;
        localStorage.setItem(key, JSON.stringify({ round:1, totals:[], currentInputs:{}, confirmedInputs:{}, test:true }));
        location.href = `dame_de_pique.html?code=${CODE||'0000'}&gid=${gid}&mode=sandbox`;
      }
    }

    // --- Ajouts pour rétablir la connexion temps réel ---
    const swapCycle = ['À droite','À gauche','Au centre','Garde tes cartes'];

    function renderTotals(totals=[], players=[]) {
      const box = $('#totalsList'); if(!box) return;
      box.innerHTML = '';
      players.forEach((p,i)=>{
        const line = document.createElement('div');
        line.className = 'line';
        line.innerHTML = `<div class=\"name\">${p?.name||('Joueur '+(i+1))}</div><div class=\"pts\">${Number(totals[i]||0)}</div>`;
        box.appendChild(line);
      });
    }
    function dealerIndexFor(round, leaderIndex, n){
      if(typeof leaderIndex!=='number'||leaderIndex<0||!n) return 0;
      return (leaderIndex + (round-1)) % n;
    }
    function renderDealer(round, leaderIndex, players){
      const idx = dealerIndexFor(round, leaderIndex, players.length);
      const dealer = players[idx];
      const nameNode = $('#dealerName'); if(nameNode) nameNode.textContent = dealer?.name || '—';
      const swapNode = $('#swapInfo'); if(swapNode) swapNode.textContent = swapCycle[(round-1)%4];
      const isDealerHere = dealer?.deviceId && dealer.deviceId === DEVICE_ID;
      document.body.classList.toggle('dealer', !!isDealerHere);
    }

    // Diagnostics légers
    function runSelfTests(){
      try{
        console.groupCollapsed('[DP v4.7.1] Self-tests');
        console.assert(typeof CODE === 'string', 'CODE doit être une string');
        console.assert(DEVICE_ID && DEVICE_ID.length>0, 'DEVICE_ID doit exister');
        console.assert(document.querySelector('.wrap')!=null, 'Container présent');
        console.groupEnd();
      }catch(_){/* no-op */}
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      runSelfTests();

      const codeNode = $('#code'); if(codeNode) codeNode.textContent = CODE || '----';

      if(!GID){
        // Pas de gid → proposer la création de test
        $('#testBanner').style.display='block';
        $('#testSection').style.display='block';
        $('#btnCreateTest').addEventListener('click', createTestGame);
        return; // rien d'autre à faire sans GID
      }

      await ensureAuth();

      const soireeRef = doc(db,'soirees', CODE);
      const gameRef   = doc(db,'scores_dame_de_pique', GID);

      let players = [];

      // Abonnement à la soirée : noms + deviceId + leaderIndex
      onSnapshot(soireeRef, (snap)=>{
        if(!snap.exists()) return;
        const s = snap.data();
        players = (Array.isArray(s.players)? s.players: []).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
        const round = Number($('#round')?.textContent||'1') || 1;
        renderDealer(round, s.leaderIndex, players);
      }, (err)=>{ showPermsHelp(err); });

      // Abonnement au document de jeu : round + totaux
      onSnapshot(gameRef, (snap)=>{
        if(!snap.exists()) return;
        const g = snap.data();
        const round = Number(g.round||1);
        const roundNode = $('#round'); if(roundNode) roundNode.textContent = round;
        renderDealer(round, (g.leaderIndex ?? undefined), players);
        renderTotals(g.totals||[], players);
      }, (err)=>{ showPermsHelp(err); });
    });
  </script>
</body>
</html>
