<!-- Version: v4.9.6 (2025-11-05) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — Saisie du score</title>
  <style>
    body {background:#0b1220;color:#f5f7fb;font-family:system-ui;margin:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:100vh;padding:1rem;}
    h1 {margin:0.5rem 0;}
    .card {background:#111a2e;border-radius:16px;padding:1rem;margin:0.5rem;width:100%;max-width:380px;box-shadow:0 0 10px rgba(0,0,0,.4)}
    .btn {background:#4fd1c5;border:none;color:#0c111b;font-weight:700;border-radius:12px;padding:0.8rem;width:100%;cursor:pointer}
    .grid {display:grid;gap:8px}
    .line {display:flex;justify-content:space-between;background:#0f1a30;border-radius:8px;padding:8px 12px}
    .modal {position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;place-items:center}
    .modal.show {display:grid}
    .sheet {background:#0d1527;border-radius:16px;padding:1rem;width:min(90vw,380px)}
    .inp {width:100%;padding:10px;border-radius:8px;border:1px solid #334567;background:#0b1324;color:#f5f7fb;margin-bottom:8px}
  </style>
</head>
<body>
  <h1>Dame De Pique</h1>
  <div>Brasseur : <span id="dealerName">—</span></div>
  <div class="card">
    <div>Saisissez votre score</div>
    <button id="btnOpen" class="btn">Inscrire le pointage</button>
  </div>
  <div class="card">
    <div>Scores totaux</div>
    <div id="totalsList" class="grid"></div>
    <div>Soirée #<span id="code">----</span></div>
  </div>
  <a href="selection_jeux.html" style="color:#9bb3d1">← Retour</a>

  <div class="modal" id="modal">
    <div class="sheet">
      <h3>Saisir mon score</h3>
      <input id="scoreInput" class="inp" type="number" placeholder="0–25" />
      <button id="btnSaveScore" class="btn">Valider</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const firebaseConfig = { apiKey:'AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg', authDomain:'soireecartev2.firebaseapp.com', projectId:'soireecartev2' };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const CODE = (qs.get('code')||'').replace(/\D/g,'').slice(0,4);
    const GID  = qs.get('gid');

    const DEVICE_ID = localStorage.getItem('deviceId') || (Date.now()+ '_' + Math.random().toString(36).slice(2));
    localStorage.setItem('deviceId', DEVICE_ID);

    const $ = (id)=>document.getElementById(id);
    const setText = (id, txt)=>{ const el=$(id); if(el) el.textContent=txt; };

    async function ensureAuth(){ try{ await signInAnonymously(auth); }catch(e){ console.warn('auth',e); } }

    function renderTotals(players, totals){
      const box = $('#totalsList');
      if(!box) return;
      box.innerHTML='';
      (players||[]).forEach((p,i)=>{
        const line=document.createElement('div');
        line.className='line';
        line.innerHTML=`<div>${p?.name||'—'}</div><div>${Number((totals||[])[i]||0)}</div>`;
        box.appendChild(line);
      });
    }

    async function init(){
      await ensureAuth();
      setText('code', CODE||'----');

      const modal=$('modal');
      const btnOpen=$('btnOpen');
      const btnSave=$('btnSaveScore');
      const scoreInput=$('scoreInput');
      let nbScr=0, players=[], lastTotals=[];

      btnOpen.onclick=()=>modal.classList.add('show');
      btnSave.onclick=()=>{
        modal.classList.remove('show');
        nbScr++;
        btnOpen.disabled=true;
        if(nbScr >= players.length){
          nbScr=0;
          console.log('Tous les joueurs ont validé leur score. Validation du tour...');
          // Placeholder validation logic
          btnOpen.disabled=false;
        }
      };

      onSnapshot(doc(db,'soirees',CODE), s=>{
        if(!s.exists()) return;
        const d=s.data();
        players=d.players||[];
        setText('dealerName', d.leaderName||'—');
      });

      onSnapshot(doc(db,'scores_dame_de_pique',GID), s=>{
        if(!s.exists()) return;
        const g=s.data();
        lastTotals=g.totals||[];
        renderTotals(players,lastTotals);
      });
    }

    window.addEventListener('DOMContentLoaded',()=>{init();});
  // == Hotfix v4.9.6: re-render totals on both snapshots ==
try {
  if (typeof window.__dpHotfixApplied === 'undefined') {
    window.__dpHotfixApplied = true;
    let __players = [];
    let __lastTotals = [];
    const safeRender = ()=>{ try { if (typeof renderTotals==='function') renderTotals(__players, __lastTotals); } catch(e){ console.warn('[hotfix render]', e); } };
    // réécoutes légères (ne cassent pas les écoutes existantes)
    onSnapshot(doc(db,'soirees',CODE), s=>{
      if(!s.exists()) return;
      const d = s.data();
      __players = (d.players||[]).slice().sort((a,b)=>(a?.order??0)-(b?.order??0));
      safeRender();
    });
    onSnapshot(doc(db,'scores_dame_de_pique',GID), s=>{
      if(!s.exists()) return;
      const g = s.data();
      __lastTotals = g.totals||[];
      if (typeof setText==='function') setText('round', String(g.round||1));
      safeRender();
    });
  }
} catch(e){ console.warn('[hotfix wires] failed', e); }
</script>
</body>
</html>
