<!-- Version: v6.7.1 (2025-11-08) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — App (v6.7.1)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:390px;margin:0 auto;padding:18px;display:grid;gap:18px}
    .titleRow{display:block;margin-bottom:8px}
    .titleRow h1{display:block;margin:0 0 8px 0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(14px,4vw,16px)}
    .card{background:#111a2e;border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    /* Modale */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(92vw,390px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--ok);font-size:0.9rem;text-align:center}
    .danger{color:var(--danger)}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .passTag{margin-left:auto;background:#14223f;border:1px solid #2b3e69;border-radius:10px;padding:6px 10px;font-size:.9rem}
    .ok{color:var(--ok)}
    .dealerBadge{background:#14532d !important;border-color:#1a7f3a !important}
    .whoBtn{display:block;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3e69;background:#14223f;color:var(--text);font-weight:700;cursor:pointer}
    .whoBtn:hover{filter:brightness(1.05)}
    .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .dot{inline-size:10px;block-size:10px;border-radius:999px;display:inline-block}
    .dot.ok{background:#22c55e}
    .dot.wait{background:#f59e0b}
    .dot.off{background:#ef4444}
    .muted{color:#9bb3d1;font-size:.9rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d1527;border:1px solid #2b3857;color:var(--text);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:60;display:none}
    .toast.show{display:block}
    .toast.err{border-color:#7f1d1d}
    #statusBar, #whoCard, details.diag { display:none !important; }
    .banner{display:none;position:sticky;bottom:0;left:0;right:0;margin-top:4px;background:#064e3b;border:1px solid #10b981;color:#e7f9f0;border-radius:14px;padding:10px 12px;font-weight:800;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .banner.show{ display:block }
    #btnReturnContainer{display:block;text-align:center;position:sticky;bottom:12px;}
    #btnReturn{background:#14532d;color:#e7f9f0;border:none;border-radius:12px;padding:12px 14px;font-size:16px;opacity:0.9;transition:opacity 0.3s;}
    #btnReturn .fill{position:absolute;left:0;top:0;height:100%;width:0;background:rgba(255,255,255,.2);transition:width 2s linear;pointer-events:none;}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="meta metaRow">
        <div class="lbl">Brasseur : <strong id="dealerName">—</strong></div>
        <div class="lbl">Tour n° <span id="round">1</span></div>
        <div id="passInfo" class="passTag" title="Règle d'échange du tour">—</div>
      </div>
    </header>

    <section class="card status" id="statusBar" aria-live="polite">
      <span class="muted">Synchro:</span> <span id="syncDot" class="dot wait" title="État de synchronisation"></span>
      <span id="syncText" class="muted">En attente…</span>
      <span class="muted" style="margin-left:auto">Soumis: <span id="statusSubmitted">0/0</span></span>
      <span class="muted">Réseau:</span> <span id="netDot" class="dot off" title="État réseau"></span>
    </section>

    <section class="card grid" id="whoCard">
      <div class="lbl">Associer cet appareil à votre nom</div>
      <div id="whoList" class="grid"></div>
      <div class="lbl" id="whoMsg"></div>
    </section>

    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn" type="button" aria-haspopup="dialog" aria-controls="modal">Inscrire le pointage</button>
      <div id="msg" class="msg" aria-live="polite"></div>
    </section>

    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl" id="roundStatus">0/0 soumis</div>
      <div class="lbl danger" id="roundError" aria-live="assertive"></div>
    </section>

    <div id="bannerControle" class="banner" role="status" aria-live="polite">
      Contrôle par <span id="controleName">—</span> !
    </div>

    <div id="btnReturnContainer">
      <button id="btnReturn"><div class="fill"></div><span>Terminer la partie</span></button>
    </div>

    <div class="footer">
      <a class="back" href="#">← Retour</a>
    </div>
  </main>

  <script>
    window.__FIREBASE_CONFIG = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const onReady=(fn)=>{if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});}else{fn();}};
    const setText=(id,txt)=>{const e=$(id);if(e)e.textContent=txt;};

    const state=window.__STATE||{players:[{id:'p1',name:'Joueur 1',total:0},{id:'p2',name:'Joueur 2',total:0},{id:'p3',name:'Joueur 3',total:0},{id:'p4',name:'Joueur 4',total:0}],round:1,dealerIndex:0,roundScores:{},expected(){return this.players.length;},get passInfo(){return ['A droite','A gauche','Au centre','Garde tes cartes'][(this.round-1)%4];},totals:{},roundError:'',gameOver:false};
    window.__STATE=state;

    function renderAll(){
      setText('round',String(state.round));
      setText('dealerName',state.players[state.dealerIndex]?.name||'—');
      setText('passInfo',state.passInfo);
    }

    function wireReturnButton(){
      const btnRet=$('btnReturn');
      if(btnRet&&!btnRet.__wired){btnRet.__wired=true;let holdTimer=null;const fill=btnRet.querySelector('.fill');
        const start=(ev)=>{ev.preventDefault?.();btnRet.style.opacity='1';if(fill){fill.style.transition='none';fill.style.width='0%';void fill.offsetWidth;fill.style.transition='width 2s linear';fill.style.width='100%';}
          holdTimer=setTimeout(()=>{if(typeof window.__finishGame==='function'){window.__finishGame();}},2000);};
        const cancel=()=>{btnRet.style.opacity='0.9';clearTimeout(holdTimer);if(fill){fill.style.transition='none';fill.style.width='0%';}};
        btnRet.addEventListener('mousedown',start);
        btnRet.addEventListener('mouseup',cancel);
        btnRet.addEventListener('mouseleave',cancel);
        btnRet.addEventListener('touchstart',start,{passive:false});
        btnRet.addEventListener('touchend',cancel);
        btnRet.addEventListener('touchcancel',cancel);
      }
    }

    onReady(()=>{renderAll();wireReturnButton();});
  </script>

  <script type="module">
    import {initializeApp,getApps} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import {getAuth,onAuthStateChanged,signInAnonymously} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import {getFirestore,doc,getDoc,setDoc,onSnapshot,runTransaction,serverTimestamp,updateDoc} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const qs=new URLSearchParams(location.search);
    const soireeCode=qs.get('code')||localStorage.getItem('dame_code')||'';
    const gameId=qs.get('gid')||localStorage.getItem('dame_gid')||'';

    const cfg=(window.__FIREBASE_CONFIG||{}).apiKey?window.__FIREBASE_CONFIG:JSON.parse(localStorage.getItem('FIREBASE_CONFIG')||'{}');
    const app=getApps().length?getApps()[0]:initializeApp(cfg);
    const auth=getAuth(app);
    const db=getFirestore(app);

    const finishedKey=(gid)=>`dame_finished_gid_${gid}`;

    window.__finishGame=async function(){
      try{
        if(!gameId){localStorage.removeItem('dame_gid');window.location.href='selection_jeux.html';return;}
        const ref=doc(db,'scores_dame_de_pique',gameId);
        const snap=await getDoc(ref);
        const data=snap.exists()?snap.data():{};
        const totals=data?.totals||{};
        await updateDoc(ref,{status:'done',archivedTotals:totals,finishedAt:serverTimestamp()});
        localStorage.setItem(finishedKey(gameId),'1');
        localStorage.removeItem('dame_gid');
        localStorage.removeItem('dame_myIndex');
        window.location.href='selection_jeux.html';
      }catch(e){console.error(e);}
    };
  </script>
</body>
</html>
