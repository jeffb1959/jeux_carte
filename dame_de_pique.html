<!-- Dame de Pique — v6.4.1 (Masquage des cartes status/who/diag) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — App</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:390px;margin:0 auto;padding:18px;display:grid;gap:18px}
    .titleRow{display:block;margin-bottom:8px}
    .titleRow h1{display:block;margin:0 0 8px 0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(14px,4vw,16px)}
    .card{background:#111a2e;border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    /* Modale */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(92vw,390px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--ok);font-size:0.9rem;text-align:center}
    .danger{color:var(--danger)}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .passTag{margin-left:auto;background:#14223f;border:1px solid #2b3e69;border-radius:10px;padding:6px 10px;font-size:.9rem}
    details.diag{border:1px dashed #2b3e69;border-radius:12px;padding:8px}
    details.diag>summary{cursor:pointer;color:#9bb3d1}
    .ok{color:var(--ok)}
    .dealerBadge{background:#14532d !important;border-color:#1a7f3a !important}
    .whoBtn{display:block;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3e69;background:#14223f;color:var(--text);font-weight:700;cursor:pointer}
    .whoBtn:hover{filter:brightness(1.05)}
    /* util */
    .hidden{display:none !important}
      /* Finir la partie — styles isolés */
    #btnEndGame{position:relative;background:#22c55e;color:#0b1220;width:60%;min-height:40px;font-size:16px;border-radius:10px;font-weight:700;overflow:hidden;margin:0 auto}
    #btnEndGame .progress{position:absolute;left:0;top:0;bottom:0;width:0%;background:rgba(255,255,255,.35);pointer-events:none}
    #btnEndGame.holding .progress{animation:endHold 2s linear forwards}
    @keyframes endHold{from{width:0%}to{width:100%}}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="meta metaRow">
        <div class="lbl">Brasseur : <strong id="dealerName">—</strong></div>
        <div class="lbl">Tour n° <span id="round">1</span></div>
        <div id="passInfo" class="passTag" title="Règle d'échange du tour">—</div>
      </div>
    </header>

    <!-- Barre de statut (sera masquée) -->
    <section class="card grid" id="statusBar">
      <div class="lbl">Statut</div>
      <div class="grid">
        <div class="line"><div>Synchro</div><div id="statusSync">—</div></div>
        <div class="line"><div>Réseau</div><div id="statusNet">—</div></div>
      </div>
    </section>

    <!-- Association appareil ↔ joueur (sera masquée) -->
    <section class="card grid" id="whoCard">
      <div class="lbl">Associer cet appareil à votre nom</div>
      <div id="whoList" class="grid"></div>
      <div class="lbl" id="whoMsg"></div>
    </section>

    <!-- Saisie du score -->
    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn" type="button" aria-haspopup="dialog" aria-controls="modal">Inscrire le pointage</button>
      <div id="msg" class="msg" aria-live="polite"></div>
    </section>

    <!-- Totaux -->
    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl" id="roundStatus">0/0 soumis</div>
      <div class="lbl danger" id="roundError" aria-live="assertive"></div>
    </section>

    <!-- Diagnostics (sera masqué) -->
    <details class="diag" id="diag">
      <summary>Diagnostics / tests</summary>
      <div id="diagOutput" class="lbl"></div>
    </details>
      <!-- Bouton Fin de partie (maintien 2s avec barre de défilement) -->
    <div class="footer">
      <button id="btnEndGame" class="btn" type="button" aria-label="Finir la partie"><span class="progress"></span>Finir la partie</button>
    </div>
  </main>

  <!-- Modale de score -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="sheet">
      <h3 id="modalTitle">Score du tour</h3>
      <div id="modalList" class="grid" style="margin-bottom:8px;"></div>
      <div class="row">
        <input id="scoreInput" class="inp" inputmode="numeric" pattern="[0-9]*" placeholder="Votre score (0–25)" />
        <button id="btnSaveScore" class="btn" type="button">Valider</button>
        <div id="modalMsg" class="msg"></div>
      </div>
    </div>
  </div>

  <!-- UI (non-module) : état + rendu + modale + helpers -->
  <script>
    const $ = (id)=>document.getElementById(id);
    const onReady = (fn)=>{ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); } else { fn(); } };
    const setText = (id, text)=>{ const el=$(id); if(el) el.textContent = text; };

    // Masquer les cartes demandées
    function hideDebugCards(){
      const sb = $('statusBar'); if (sb){ sb.hidden = true; sb.style.display = 'none'; }
      const who = $('whoCard'); if (who){ who.hidden = true; who.style.display = 'none'; }
      const diag = $('diag'); if (diag){ try{ diag.open=false; }catch{} diag.style.display='none'; }
    }

    // Toast minimal
    let __toastTimer=null; function showToast(msg, isErr=false){
      let t = document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d1527;border:1px solid #2b3857;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:60;display:none'; document.body.appendChild(t);} 
      t.textContent = msg; t.style.borderColor = isErr? '#7f1d1d' : '#2b3857'; t.style.display='block';
      clearTimeout(__toastTimer); __toastTimer=setTimeout(()=> t.style.display='none', 2400);
    }

    const state = window.__STATE || {
      players: [ { id:'p1', name:'Joueur 1', total:0 }, { id:'p2', name:'Joueur 2', total:0 }, { id:'p3', name:'Joueur 3', total:0 }, { id:'p4', name:'Joueur 4', total:0 } ],
      round: 1,
      dealerIndex: 0,
      roundScores: {},
      expected(){ return this.players.length; },
      get passInfo(){ return passRuleForRound(this.round); },
      myIndex: parseInt(localStorage.getItem('dame_myIndex') || '-1', 10),
      soireeId: null,
      totals: {},
      roundError: '',
      gameOver: false,
      standings: [],
      deviceId: localStorage.getItem('deviceId') || localStorage.getItem('device_id') || null,
      pendingScore: null,
    };
    window.__STATE = state;

    function passRuleForRound(round){
      const rules = ['A droite', 'A gauche', 'Au centre', 'Garde tes cartes'];
      return rules[(round-1)%4];
    }

    function renderModalList(){
      const host = $('modalList'); if(!host) return;
      host.innerHTML = '';
      state.players.forEach((p, idx)=>{
        const line = document.createElement('div'); line.className='line';
        const n = document.createElement('div'); n.textContent = p.name + (idx===state.dealerIndex ? ' ★' : '');
        const v = document.createElement('div');
        const val = state.roundScores[idx];
        v.textContent = (typeof val==='number' && Number.isFinite(val)) ? String(val) : '—';
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });
    }

    function renderAll(){
      setText('round', String(state.round));
      setText('dealerName', state.players[state.dealerIndex]?.name || '—');
      setText('passInfo', state.passInfo);

      const who = $('whoCard');
      const whoList = $('whoList');
      const whoMsg = $('whoMsg');
      const needBind = !(Number.isFinite(state.myIndex) && state.myIndex >= 0 && state.myIndex < state.players.length);
      if (who){
        who.hidden = !needBind; // restera masqué par hideDebugCards()
        if (needBind && whoList){
          whoList.innerHTML = '';
          state.players.forEach((p,idx)=>{
            const b = document.createElement('button');
            b.className = 'whoBtn';
            b.textContent = p.name + (idx===state.dealerIndex?' (Brasseur)':'');
            b.addEventListener('click', ()=>{
              try{
                localStorage.setItem('dame_myIndex', String(idx));
                state.myIndex = idx;
                if (whoMsg) whoMsg.textContent = `Appareil associé à ${p.name}.`;
                renderAll();
                if (state.pendingScore != null && typeof window.__submitScore === 'function'){
                  const pending = state.pendingScore; state.pendingScore = null;
                  window.__submitScore(pending).catch(()=>{});
                }
              }catch(e){ if (whoMsg) whoMsg.textContent = "Impossible de sauvegarder l'association (localStorage)."; }
            });
            whoList.appendChild(b);
          });
        } else if (whoMsg) {
          whoMsg.textContent = '';
        }
      }

      const tl = $('totalsList'); if (tl){
        tl.innerHTML = '';
        state.players.forEach((p,idx)=>{
          const line = document.createElement('div'); line.className = 'line' + (idx===state.dealerIndex?' dealerBadge':'');
          const name = document.createElement('div'); name.textContent = p.name + (idx===state.dealerIndex?' ★':'');
          const totalVal = typeof state.totals[p.id] === 'number' ? state.totals[p.id] : (p.total||0);
          const val = document.createElement('div'); val.textContent = String(totalVal);
          line.appendChild(name); line.appendChild(val); tl.appendChild(line);
        });
      }
      const submitted = Object.keys(state.roundScores||{}).length;
      setText('roundStatus', `${submitted}/${state.expected()} soumis`);
      setText('roundError', state.roundError||'');
      renderModalList();

      // Toujours re-cacher les cartes demandées
      hideDebugCards();

      if (state.myIndex === state.dealerIndex) {
        document.body.style.background = '#0f2e16';
      } else {
        document.body.style.background = 'var(--bg)';
      }
    }

    window.__openScoreModal = ()=>{
      const modal = $('modal'); if(!modal) return; modal.classList.add('show');
      const inp = $('scoreInput'); if(inp && !inp.__wired){ inp.__wired=true; inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('btnSaveScore')?.click(); } }, {capture:true}); }
      const save = $('btnSaveScore'); if(save && !save.__wired){
        save.__wired = true;
        save.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const raw = String($('scoreInput')?.value ?? '').trim();
          const val = parseInt(raw,10);
          if (!Number.isFinite(val) || val<0 || val>25){ setText('modalMsg','Entrez un nombre entre 0 et 25.'); return; }
          setText('modalMsg','Envoi…');
          try{
            if (typeof window.__submitScore !== 'function') { setText('modalMsg','Erreur: soumission indisponible (fonction manquante).'); return; }
            await window.__submitScore(val);
            setText('modalMsg','Score enregistré.');
            setTimeout(()=>{ $('modal')?.classList.remove('show'); setText('modalMsg',''); const i=$('scoreInput'); if(i) i.value=''; }, 350);
          }catch(err){ setText('modalMsg', 'Erreur: '+(err?.message||err)); }
        }, {capture:true});
      }
    };
    window.__closeScoreModal = ()=>{ $('modal')?.classList.remove('show'); };

    function wireOpenButton(){
      const btnOpen = $('btnOpen');
      if (btnOpen && !btnOpen.__wired) {
        btnOpen.__wired = true;
        btnOpen.disabled = false;
        btnOpen.onclick = null;
        btnOpen.addEventListener('click', (e) => {
          e.preventDefault();
          window.__openScoreModal();
        }, { capture: true });
      }

      document.addEventListener('click', (e) => {
        const m = $('modal');
        if (!m || !m.classList.contains('show')) return;
        const sheet = m.querySelector('.sheet');
        if (e.target === m && sheet && !sheet.contains(e.target)) {
          window.__closeScoreModal();
        }
      }, { capture: true });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.__closeScoreModal();
        }
      }, { capture: true });
    }

    function runUiTests(){
      const checks = [
        ['dealerName existe', !!$('dealerName')],
        ['round existe', !!$('round')],
        ['passInfo existe', !!$('passInfo')],
        ['totalsList existe', !!$('totalsList')],
        ['roundStatus existe', !!$('roundStatus')],
        ['roundError existe', !!$('roundError')],
        ['btnOpen existe', !!$('btnOpen')],
        ['modal existe', !!$('modal')],
        ['btnSaveScore existe', !!$('btnSaveScore')],
        ['scoreInput existe', !!$('scoreInput')],
      ];
      const diag = $('diagOutput');
      const text = checks.map(([label, ok])=> `${ok ? '✅' : '❌'} ${label}`).join('\n');
      if (diag) diag.textContent = text;
      const expectedCycle = ['A droite','A gauche','Au centre','Garde tes cartes','A droite','A gauche','Au centre','Garde tes cartes'];
      const actualCycle = Array.from({length:8}, (_,i)=>passRuleForRound(i+1));
      const okCycle = JSON.stringify(expectedCycle) === JSON.stringify(actualCycle);
      if (diag) diag.textContent += `\n${okCycle ? '✅' : '❌'} cycle passRuleForRound (8 tours)`;
      if (diag) diag.textContent += `\n${typeof window.__submitScore==='function' ? '✅' : '❌'} __submitScore disponible`;
      if (diag) diag.textContent += `\n${typeof window.__listenScores==='function' ? '✅' : '❌'} listenScores (unique)`;
    }

    onReady(()=>{ wireOpenButton(); renderAll(); runUiTests(); hideDebugCards(); });
    window.renderAll = renderAll;
  </script>

  <!-- Bouton Finir la partie (JS dédié, non intrusif) -->
  <script>
    onReady(()=>{
      const btn = document.getElementById('btnEndGame');
      if(!btn) return;
      const progress = btn.querySelector('.progress') || (function(){ const s=document.createElement('span'); s.className='progress'; btn.prepend(s); return s; })();
      let holdTs=0;
      const start=()=>{ holdTs=Date.now(); btn.classList.add('holding'); };
      const end=()=>{ const dt=Date.now()-holdTs; btn.classList.remove('holding'); progress.style.width='0%'; if(dt>=2000){ location.href='selection_jeux.html'; } };
      ['mousedown','touchstart'].forEach(ev=> btn.addEventListener(ev, start, {passive:true}));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev, end, {passive:true}));
    });
  </script>

  <!-- Firebase config loader (auto-récupération: window → <script#firebase-config> → localStorage) -->
  <script>
    // 1) Fenêtre (injectée par index.html)
    const cfgWin = (window.__FIREBASE_CONFIG && typeof window.__FIREBASE_CONFIG.apiKey==='string') ? window.__FIREBASE_CONFIG : null;
    // 2) Balise JSON optionnelle
    let cfgTag=null; try{ const t=document.getElementById('firebase-config'); if(t){ cfgTag=JSON.parse(t.textContent||'{}'); } }catch{}
    // 3) localStorage
    let cfgLS=null;  try{ cfgLS=JSON.parse(localStorage.getItem('FIREBASE_CONFIG')||'null'); }catch{}

    const picked = cfgWin || cfgTag || cfgLS || null;
    if (!picked || !picked.apiKey){
      console.warn('[Config] Firebase absente — essayez d\'ouvrir index.html d\'abord ou de stocker localStorage.FIREBASE_CONFIG');
      // Affichage discret
      (function(){
        let t = document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d1527;border:1px solid #2b3857;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:60;display:block'; document.body.appendChild(t);} 
        t.textContent='⚠️ Config Firebase absente. Ouvrez index.html ou mettez FIREBASE_CONFIG dans localStorage.';
        setTimeout(()=>{ try{t.remove();}catch{} }, 3000);
      })();
      window.__FIREBASE_CONFIG = null;
    } else {
      window.__FIREBASE_CONFIG = picked;
      try{ localStorage.setItem('FIREBASE_CONFIG', JSON.stringify(picked)); }catch{}
      const d=document.getElementById('diagOutput'); if(d) d.textContent += '
✅ Firebase config chargée';
    }
  </script>

  <!-- Firestore (module) : auth anonyme + listeners + transaction de score -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const cfg = window.__FIREBASE_CONFIG;
    if (!cfg) {
      console.warn('[Init] Config Firebase absente — synchro inactive.');
    } else {
      const app = getApps().length ? getApps()[0] : initializeApp(cfg);
      const auth = getAuth(app);
      const db   = getFirestore(app);

      const qs = new URLSearchParams(location.search);
      const soireeCode = qs.get('code') || localStorage.getItem('dame_code') || '';
      const gameId     = qs.get('gid')  || localStorage.getItem('dame_gid')  || '';
      const myIndexURL = qs.get('my');

      if (soireeCode) localStorage.setItem('dame_code', soireeCode);
      if (gameId)     localStorage.setItem('dame_gid', gameId);
      if (myIndexURL !== null) localStorage.setItem('dame_myIndex', String(myIndexURL));

      function normalizePlayers(soireeData){
        if (!soireeData) return [];
        if (Array.isArray(soireeData.players)) return soireeData.players.map((p,i)=>({ id: p.id || `p${i+1}`, name: (p.name ?? p.nom ?? String(p)), deviceId: p.deviceId || p.device_id || p.devId || p.deviceid || null }));
        if (Array.isArray(soireeData.joueurs)) return soireeData.joueurs.map((name,i)=>({ id: `p${i+1}`, name }));
        if (soireeData.playersMap && typeof soireeData.playersMap === 'object') return Object.entries(soireeData.playersMap).map(([id, obj])=>({ id, name: obj?.name || id, deviceId: obj?.deviceId || obj?.device_id || obj?.deviceid || null }));
        return [];
      }

      async function ensureAuth(){
        return new Promise((resolve)=>{
          onAuthStateChanged(auth, async (user)=>{
            if (!localStorage.getItem('deviceId')){
              const devIdCandidate = user?.uid || String(Date.now());
              try{ localStorage.setItem('deviceId', devIdCandidate); }catch{}
            }
            window.__STATE.deviceId = localStorage.getItem('deviceId');
            if (user) { resolve(user); return; }
            try {
              const cred = await signInAnonymously(auth);
              if (!localStorage.getItem('deviceId')){
                try{ localStorage.setItem('deviceId', cred.user?.uid || String(Date.now())); }catch{}
              }
              window.__STATE.deviceId = localStorage.getItem('deviceId');
              resolve(cred.user);
            } catch(err){
              console.error('[Auth] Anonyme échouée', err);
              resolve(null);
            }
          });
        });
      }

      async function seedScoresIfNeeded(players){
        const gid = gameId;
        if (!gid) return;
        const ref = doc(db, 'scores_dame_de_pique', gid);
        const snap = await getDoc(ref);
        if (snap.exists()) return;
        const totals = Object.fromEntries((players||[]).map(p=>[p.id, 0]));
        await setDoc(ref, { createdAt: serverTimestamp(), soireeCode: soireeCode || null, round: 1, dealerIndex: 0, totals });
        console.log('[Seed] scores_dame_de_pique créé');
      }

      function listenSoiree(){
        if (!soireeCode) return () => {};
        const sref = doc(db, 'soirees', soireeCode);
        return onSnapshot(sref, async (snap)=>{
          if (!snap.exists()) { console.warn('soiree introuvable:', soireeCode); return; }
          const data = snap.data()||{};
          const players = normalizePlayers(data);
          if (players.length) window.__STATE.players = players;
          window.__STATE.soireeNo = data.soireeNo ?? data.numero ?? null;
          if (typeof data.dealerIndex === 'number') window.__STATE.dealerIndex = data.dealerIndex;
          else if (typeof data.dealerIndexStart === 'number') window.__STATE.dealerIndex = data.dealerIndexStart;
          await seedScoresIfNeeded(window.__STATE.players);
          // Auto-bind par deviceId si possible
          const needBind = !(Number.isFinite(window.__STATE.myIndex) && window.__STATE.myIndex>=0 && window.__STATE.myIndex<window.__STATE.players.length);
          const devId = window.__STATE.deviceId || localStorage.getItem('deviceId');
          if (needBind && devId){
            const norm = v=> (v==null?'':String(v)).trim().toLowerCase();
            const idx = window.__STATE.players.findIndex(p=> norm(p.deviceId)===norm(devId));
            if (idx>=0){
              try{ localStorage.setItem('dame_myIndex', String(idx)); }catch{}
              window.__STATE.myIndex = idx;
            }
          }
          window.renderAll?.();
        });
      }

      function listenScores(){
        if (!gameId) return () => {};
        const ref = doc(db, 'scores_dame_de_pique', gameId);
        return onSnapshot(ref, (snap)=>{
          if (!snap.exists()) return;
          const d = snap.data();
          window.__STATE.round       = d.round || 1;
          window.__STATE.dealerIndex = typeof d.dealerIndex === 'number' ? d.dealerIndex : window.__STATE.dealerIndex;
          window.__STATE.totals      = d.totals || window.__STATE.totals || {};
          window.__STATE.roundScores = d.roundState || {};
          window.__STATE.roundError  = d.roundError || '';
          window.__STATE.gameOver    = !!d.gameOver;
          window.__STATE.standings   = d.standings || [];
          window.renderAll?.();
          renderGameOver();
        });
      }
      window.__listenScores = listenScores;

      window.__submitScore = async function submitScore(val){
        if (!Number.isFinite(val) || val<0 || val>25) throw new Error('Score invalide (0–25)');
        const s = window.__STATE || {};
        const pIndex = s.myIndex;
        if (!Number.isFinite(pIndex) || pIndex<0 || pIndex>=s.players.length) {
          s.pendingScore = val;
          const who = document.getElementById('whoCard'); if (who) { who.hidden = false; try{ who.scrollIntoView({behavior:'smooth', block:'start'}); }catch{} }
          throw new Error('Index joueur inconnu (my). Choisissez votre nom ci-dessus.');
        }
        if (!gameId) throw new Error('Partie (gid) inconnue');
        const n = (s.players||[]).length || 0;
        if (!n) throw new Error('Aucun joueur configuré');

        const ref = doc(db, 'scores_dame_de_pique', gameId);
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error('Document partie introuvable');
          const d = snap.data();
          if (d.gameOver) throw new Error('Partie terminée');

          const round = typeof d.round==='number' ? d.round : 1;
          const dealerIndex = typeof d.dealerIndex==='number' ? d.dealerIndex : 0;
          const totals = d.totals || {};
          const roundState = {...(d.roundState||{})};

          roundState[pIndex] = val;

          const submittedCount = Object.keys(roundState).length;
          const values = Array.from({length:n}, (_,i)=> Number(roundState[i]||0));
          const sum = values.reduce((a,b)=>a+b, 0);

          if (submittedCount < n){
            tx.set(ref, { roundState, roundError: null }, { merge:true });
            return;
          }

          if (sum !== 25){
            tx.set(ref, { roundState, roundError: "Le total n'est pas 25. Vérifiez et revalidez." }, { merge:true });
            return;
          }

          let perRound = values.slice();
          const count25 = values.filter(v=>v===25).length;
          const count0  = values.filter(v=>v===0).length;
          if (count25===1 && count0===n-1){
            const idx25 = values.findIndex(v=>v===25);
            perRound = values.map((v,i)=> i===idx25 ? 0 : 25);
          }

          const ids = (s.players||[]).map((p,i)=> p.id || `p${i+1}`);
          const newTotals = { ...totals };
          for (let i=0;i<n;i++){
            const pid = ids[i] || `p${i+1}`;
            const cur = typeof newTotals[pid]==='number' ? newTotals[pid] : 0;
            newTotals[pid] = cur + (perRound[i]||0);
          }

          const over = Object.values(newTotals).some(x=> (typeof x==='number') && x>=100);
          let payload = { totals: newTotals, round: round + 1, dealerIndex: (dealerIndex + 1) % n, roundState: {}, roundError: null };
          if (over){
            const standings = ids.map((pid,i)=>({ id: pid, name: (s.players[i]?.name||pid), total: newTotals[pid]||0 }))
                                 .sort((a,b)=> a.total - b.total);
            payload = { ...payload, gameOver: true, finishedAt: serverTimestamp(), standings, winnerId: standings[0]?.id || null };
          }
          tx.set(ref, payload, { merge:true });
        });
      };

      function renderGameOver(){
        let host = document.getElementById('gameOverCard');
        if (!window.__STATE.gameOver){ if(host) host.remove(); return; }
        if (!host){
          host = document.createElement('section');
          host.className = 'card grid';
          host.id = 'gameOverCard';
          document.querySelector('.wrap')?.appendChild(host);
        }
        host.innerHTML = '';
        const h = document.createElement('div'); h.className='lbl'; h.textContent = 'Tableau des honneurs'; host.appendChild(h);
        const list = document.createElement('div'); list.className='grid'; host.appendChild(list);
        (window.__STATE.standings||[]).forEach((s,idx)=>{
          const line = document.createElement('div'); line.className='line';
          const n = document.createElement('div'); n.textContent = s.name; if(idx===0) n.style.color = '#22c55e';
          const v = document.createElement('div'); v.textContent = String(s.total);
          line.appendChild(n); line.appendChild(v); list.appendChild(line);
        });
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Fin de la partie';
        btn.addEventListener('mousedown', ()=>{ btn.__holdTs = Date.now(); });
        btn.addEventListener('mouseup', ()=>{
          if (Date.now() - (btn.__holdTs||0) >= 2000){ location.href = 'selection_jeux.html'; }
        });
        host.appendChild(btn);
      }

      async function main(){
        try{
          await ensureAuth();
          listenSoiree();
          listenScores();
          console.log('[Firestore] Listeners actifs', { soireeCode, gameId });
          const d = document.getElementById('diagOutput');
          if (d) d.textContent += `\nFirebase OK — soiree:${soireeCode||'—'} gid:${gameId||'—'}`;
        }catch(err){
          console.error('[Firestore] Échec initialisation', err);
          const d = document.getElementById('diagOutput');
          if (d) d.textContent += `\n❌ Firestore: ${err?.message||err}`;
          showToast('❌ Firebase: ' + (err?.message||err), true);
        }
      }

      main();
    }
  </script>
</body>
</html>
