<!-- Version: v6.8.8 (2025 11 09)
Modifs: + Bouton h√¥te "Fin de la Partie (maintenir 2s)" toujours visible en bas. Long-press 2s, clic court neutralis√©. Visibilit√© (myIndex===0). -->
<!-- Version: v6.8.3.1 (2025-11-09)
Modifications:
- Ajout d‚Äôun listener Firestore sur soirees/{code} pour rediriger tous les joueurs quand currentGame dispara√Æt.
- Version stable mais bouton 2 sec non fonctionnel tout les joueur changes et pas yo-yo
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique ‚Äî App (v6.8.8)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:390px;margin:0 auto;padding:18px;display:grid;gap:18px}
    .titleRow{display:block;margin-bottom:8px}
    .titleRow h1{display:block;margin:0 0 8px 0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(14px,4vw,16px)}
    .card{background:#111a2e;border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    /* Modale */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(92vw,390px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--ok);font-size:0.9rem;text-align:center}
    .danger{color:var(--danger)}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .passTag{margin-left:auto;background:#14223f;border:1px solid #2b3e69;border-radius:10px;padding:6px 10px;font-size:.9rem}
    .ok{color:var(--ok)}
    .dealerBadge{background:#14532d !important;border-color:#1a7f3a !important}
    .whoBtn{display:block;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3e69;background:#14223f;color:var(--text);font-weight:700;cursor:pointer}
    .whoBtn:hover{filter:brightness(1.05)}
    /* Status bar + toasts */
    .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .dot{inline-size:10px;block-size:10px;border-radius:999px;display:inline-block}
    .dot.ok{background:#22c55e}
    .dot.wait{background:#f59e0b}
    .dot.off{background:#ef4444}
    .muted{color:#9bb3d1;font-size:.9rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d1527;border:1px solid #2b3857;color:var(--text);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:60;display:none}
    .toast.show{display:block}
    .toast.err{border-color:#7f1d1d}

    /* üîí Masquage impos√© (v6.5.x): statusBar, whoCard, diag */
    #statusBar, #whoCard, details.diag { display:none !important; }

    /* Bandeau Contr√¥le */
    .banner{
      display:none; position:sticky; bottom:0; left:0; right:0; margin-top:4px;
      background:#064e3b; border:1px solid #10b981; color:#e7f9f0;
      border-radius:14px; padding:10px 12px; font-weight:800; text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,.25)
    }
    .banner.show{ display:block }
    .banner small{ display:block; font-weight:600; opacity:.9 }

    /* Bouton retour ‚Äì animation de maintien (2s) */
    #btnReturn{ position:relative; overflow:hidden; }
    #btnReturn .fill{ position:absolute; left:0; top:0; height:100%; width:0; background:rgba(255,255,255,.2); transition: width 2s linear; pointer-events:none; }
    #btnReturn span{ position:relative; z-index:1; }
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="meta metaRow">
        <div class="lbl">Brasseur : <strong id="dealerName">‚Äî</strong></div>
        <div class="lbl">Tour n¬∞ <span id="round">1</span></div>
        <div id="passInfo" class="passTag" title="R√®gle d'√©change du tour">‚Äî</div>
      </div>
    </header>

    <!-- Barre de statut (synchro, en ligne, x/y)  ‚ûú masqu√©e en v6.5.x via CSS -->
    <section class="card status" id="statusBar" aria-live="polite">
      <span class="muted">Synchro:</span> <span id="syncDot" class="dot wait" title="√âtat de synchronisation"></span>
      <span id="syncText" class="muted">En attente‚Ä¶</span>
      <span class="muted" style="margin-left:auto">Soumis: <span id="statusSubmitted">0/0</span></span>
      <span class="muted">R√©seau:</span> <span id="netDot" class="dot off" title="√âtat r√©seau"></span>
    </section>

    <!-- Association appareil ‚Üî joueur (masqu√© en v6.5.x via CSS) -->
    <section class="card grid" id="whoCard">
      <div class="lbl">Associer cet appareil √† votre nom</div>
      <div id="whoList" class="grid"></div>
      <div class="lbl" id="whoMsg"></div>
    </section>

    <!-- Saisie du score -->
    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn" type="button" aria-haspopup="dialog" aria-controls="modal">Inscrire le pointage</button>
      <div id="msg" class="msg" aria-live="polite"></div>
    </section>

    <!-- Totaux -->
    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl" id="roundStatus">0/0 soumis</div>
      <div class="lbl danger" id="roundError" aria-live="assertive"></div>
    </section>

    <div id="bannerControle" class="banner" role="status" aria-live="polite">
      Contr√¥le par <span id="controleName">‚Äî</span> !
      <small>(25 ‚Ä¢ 0 ‚Ä¢ 0 ‚Ä¢ 0)</small>
    </div>

    <div id="btnReturnContainer" style="display:none; text-align:center;">
      <button id="btnReturn" style="background:#14532d;color:#e7f9f0;border:none;border-radius:12px;padding:6px 12px;font-size:14px;opacity:0.85;transition:opacity 0.3s;">
        <div class="fill"></div>
        <span>Fin de la Partie (maintenir 2s)</span>
      </button>
    </div>

    <div class="footer">
      <a class="back" href="#">‚Üê Retour</a>
    </div>

    <!-- Modale -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="sheet">
        <h3 id="modalTitle">Saisir mon score</h3>
        <div id="modalMsg" class="msg" aria-live="polite"></div>
        <div class="row">
          <div id="modalList" class="grid" aria-live="polite"></div>
          <input id="scoreInput" class="inp" type="number" inputmode="numeric" min="0" max="25" step="1" placeholder="0‚Äì25" />
          <button id="btnSaveScore" class="btn" type="button">Valider</button>
        </div>
      </div>
    </div>

    <!-- Diagnostics (masqu√© en v6.5.x via CSS) -->
    <details class="diag" id="diag" open>
      <summary>Diagnostics / tests</summary>
      <div id="diagOutput" class="lbl"></div>
    </details>
  </main>

  <!-- Configuration Firebase (inchang√©) -->
  <script>
    window.__FIREBASE_CONFIG = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };
  </script>

  <!-- UI (non-module) : √©tat + rendu + modale -->
  <script>
    const $ = (id)=>document.getElementById(id);
    const onReady = (fn)=>{ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); } else { fn(); } };
    const setText = (id, text)=>{ const el=$(id); if(el) el.textContent = text; };

    // Toast + Synchro + R√©seau (internes, m√™me si statusBar est masqu√©)
    let __toastTimer=null; function showToast(msg, isErr=false){
      let t = document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t);} 
      t.textContent = msg; t.classList.toggle('err', !!isErr); t.classList.add('show');
      clearTimeout(__toastTimer); __toastTimer=setTimeout(()=> t.classList.remove('show'), 2200);
    }
    function setSync(state){ const dot=$('syncDot'); const txt=$('syncText'); if(!dot||!txt) return; if(state==='ok'){ dot.className='dot ok'; txt.textContent='Synchronis√©'; } else if(state==='wait'){ dot.className='dot wait'; txt.textContent='En attente‚Ä¶'; } else { dot.className='dot off'; txt.textContent='Hors ligne'; } }
    function setNet(){ const d=$('netDot'); if(!d) return; d.className = 'dot ' + (navigator.onLine?'ok':'off'); }
    window.addEventListener('online', setNet); window.addEventListener('offline', ()=>{ setNet(); setSync('off'); }); setNet();

    const state = window.__STATE || {
      players: [ { id:'p1', name:'Joueur 1', total:0 }, { id:'p2', name:'Joueur 2', total:0 }, { id:'p3', name:'Joueur 3', total:0 }, { id:'p4', name:'Joueur 4', total:0 } ],
      round: 1,
      dealerIndex: 0,
      roundScores: {},
      expected(){ return this.players.length; },
      get passInfo(){ return passRuleForRound(this.round); },
      myIndex: parseInt(localStorage.getItem('dame_myIndex') || '-1', 10),
      soireeId: null,
      totals: {},
      roundError: '',
      gameOver: false,
      standings: [],
      deviceId: localStorage.getItem('deviceId') || localStorage.getItem('device_id') || null,
      pendingScore: null,
    };
    window.__STATE = state;
    state.lastRound = state.lastRound ?? null;

    function passRuleForRound(round){
      const rules = ['A droite', 'A gauche', 'Au centre', 'Garde tes cartes'];
      return rules[(round-1)%4];
    }

    function renderModalList(){
      const host = $('modalList'); if(!host) return;
      host.innerHTML = '';
      state.players.forEach((p, idx)=>{
        const line = document.createElement('div'); line.className='line';
        const n = document.createElement('div'); n.textContent = p.name + (idx===state.dealerIndex ? ' ‚òÖ' : '');
        const v = document.createElement('div');
        const val = state.roundScores[idx];
        v.textContent = (typeof val==='number' && Number.isFinite(val)) ? String(val) : '‚Äî';
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });
    }

    function wireReturnButton(){
      const ctn = $('btnReturnContainer');
      if (state.gameOver) { if (ctn) ctn.style.display = 'block'; } else { if (ctn) ctn.style.display = 'none'; }
      const btnRet = $('btnReturn');
      if(btnRet && !btnRet.__wired){
        btnRet.__wired=true;
        let holdTimer=null;
        const fill = btnRet.querySelector('.fill');
        const start = (ev)=>{ ev.preventDefault?.(); btnRet.style.opacity='1'; if(fill){ fill.style.transition='none'; fill.style.width='0%'; void fill.offsetWidth; fill.style.transition='width 2s linear'; fill.style.width='100%'; }
          holdTimer=setTimeout(()=>{ try { (window.finishHostFlow || window.finishCleanPlus)?.(); } catch(e) { console.warn('finish (long-press) error', e); } },2000);
        };
        const cancel=()=>{ btnRet.style.opacity='0.85'; clearTimeout(holdTimer); if(fill){ fill.style.transition='none'; fill.style.width='0%'; } };
        btnRet.addEventListener('mousedown',start);
        btnRet.addEventListener('mouseup',cancel);
        btnRet.addEventListener('mouseleave',cancel);
        btnRet.addEventListener('touchstart',start,{passive:false});
        btnRet.addEventListener('touchend',cancel);
        btnRet.addEventListener('touchcancel',cancel);
      }
    }

    function renderAll(){
      setText('round', String(state.round));
      setText('dealerName', state.players[state.dealerIndex]?.name || '‚Äî');
      setText('passInfo', state.passInfo);

      // whoCard est masqu√© en CSS; on garde la logique interne mais sans affichage
      const who = $('whoCard');
      const whoList = $('whoList');
      const whoMsg = $('whoMsg');
      const needBind = !(Number.isFinite(state.myIndex) && state.myIndex >= 0 && state.myIndex < state.players.length);
      if (who){
        if (needBind && whoList){
          whoList.innerHTML = '';
          state.players.forEach((p,idx)=>{
            const b = document.createElement('button');
            b.className = 'whoBtn';
            b.textContent = p.name + (idx===state.dealerIndex?' (Brasseur)':'');
            b.addEventListener('click', ()=>{
              try{
                localStorage.setItem('dame_myIndex', String(idx));
                state.myIndex = idx;
                if (whoMsg) whoMsg.textContent = `Appareil associ√© √† ${p.name}.`;
                renderAll();
                if (state.pendingScore != null && typeof window.__submitScore === 'function'){
                  const pending = state.pendingScore; state.pendingScore = null;
                  window.__submitScore(pending).catch(()=>{});
                }
              }catch(e){ if (whoMsg) whoMsg.textContent = "Impossible de sauvegarder l'association (localStorage)."; }
            });
            whoList.appendChild(b);
          });
        } else if (whoMsg) {
          whoMsg.textContent = '';
        }
      }

      const tl = $('totalsList'); if (tl){
        tl.innerHTML = '';
        state.players.forEach((p,idx)=>{
          const line = document.createElement('div'); line.className = 'line' + (idx===state.dealerIndex?' dealerBadge':'');
          const name = document.createElement('div'); name.textContent = p.name + (idx===state.dealerIndex?' ‚òÖ':'');
          const totalVal = typeof state.totals[p.id] === 'number' ? state.totals[p.id] : (p.total||0);
          const val = document.createElement('div'); val.textContent = String(totalVal);
          line.appendChild(name); line.appendChild(val); tl.appendChild(line);
        });
      }
      const submitted = Object.keys(state.roundScores||{}).length;
      setText('roundStatus', `${submitted}/${state.expected()} soumis`);
      setText('roundError', state.roundError||'');
      setText('statusSubmitted', `${submitted}/${state.expected()}`);
      renderModalList();

      // Banni√®re Contr√¥le (affich√©e si grand chelem, nomm√© "Contr√¥le")
      const banner = document.getElementById('bannerControle');
      const idxCtrl = state.lastRound?.controleIndex;
      if (banner){
        if (state.lastRound?.appliedGrandChelem === true && Number.isInteger(idxCtrl) && idxCtrl>=0 && idxCtrl<state.players.length){
          const name = state.players[idxCtrl]?.name || '‚Äî';
          const elName = document.getElementById('controleName');
          if (elName) elName.textContent = name;
          banner.classList.add('show');
        } else {
          banner.classList.remove('show');
        }
      }

      wireReturnButton();

      if (state.myIndex === state.dealerIndex) {
        document.body.style.background = '#0f2e16';
      } else {
        document.body.style.background = 'var(--bg)';
      }
    }

    window.__openScoreModal = ()=>{
      const modal = $('modal'); if(!modal) return; modal.classList.add('show');
      const inp = $('scoreInput'); if(inp && !inp.__wired){ inp.__wired=true; inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('btnSaveScore')?.click(); } }, {capture:true}); }
      const save = $('btnSaveScore'); if(save && !save.__wired){
        save.__wired = true;
        save.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const raw = String($('scoreInput')?.value ?? '').trim();
          const val = parseInt(raw,10);
          if (!Number.isFinite(val) || val<0 || val>25){ setText('modalMsg','Entrez un nombre entre 0 et 25.'); return; }
          setText('modalMsg','Envoi‚Ä¶'); setSync('wait'); save.setAttribute('disabled','');
          try{
            if (typeof window.__submitScore !== 'function') { setText('modalMsg','Erreur: soumission indisponible (fonction manquante).'); save.removeAttribute('disabled'); return; }
            await window.__submitScore(val);
            setText('modalMsg','Score enregistr√©.'); showToast('Score enregistr√©');
            setTimeout(()=>{ $('modal')?.classList.remove('show'); setText('modalMsg',''); const i=$('scoreInput'); if(i) i.value=''; save.removeAttribute('disabled'); }, 350);
          }catch(err){ setText('modalMsg', 'Erreur: '+(err?.message||err)); showToast(String(err?.message||err), true); save.removeAttribute('disabled'); }
        }, {capture:true});
      }
    };
    window.__closeScoreModal = ()=>{ $('modal')?.classList.remove('show'); };

    function wireOpenButton(){
      const btnOpen = $('btnOpen');
      if (btnOpen && !btnOpen.__wired) {
        btnOpen.__wired = true;
        btnOpen.disabled = false;
        btnOpen.onclick = null;
        btnOpen.addEventListener('click', (e) => {
          e.preventDefault();
          window.__openScoreModal();
        }, { capture: true });
      }

      document.addEventListener('click', (e) => {
        const m = $('modal');
        if (!m || !m.classList.contains('show')) return;
        const sheet = m.querySelector('.sheet');
        if (e.target === m && sheet && !sheet.contains(e.target)) {
          window.__closeScoreModal();
        }
      }, { capture: true });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.__closeScoreModal();
        }
      }, { capture: true });
    }

    function runUiTests(){
      const checks = [
        ['dealerName existe', !!$('dealerName')],
        ['round existe', !!$('round')],
        ['passInfo existe', !!$('passInfo')],
        ['totalsList existe', !!$('totalsList')],
        ['roundStatus existe', !!$('roundStatus')],
        ['roundError existe', !!$('roundError')],
        ['btnOpen existe', !!$('btnOpen')],
        ['modal existe', !!$('modal')],
        ['btnSaveScore existe', !!$('btnSaveScore')],
        ['scoreInput existe', !!$('scoreInput')],
        ['bannerControle existe', !!$('bannerControle')],
        ['btnReturn existe', !!$('btnReturn')],
      ];
      const diag = $('diagOutput');
      const text = checks.map(([label, ok])=> `${ok ? '‚úÖ' : '‚ùå'} ${label}`).join('\n');
      if (diag) diag.textContent = text + '\n(v6.5.5: hotfix braces + imports + UI wiring)';

      const expectedCycle = ['A droite','A gauche','Au centre','Garde tes cartes','A droite','A gauche','Au centre','Garde tes cartes'];
      const actualCycle = Array.from({length:8}, (_,i)=>passRuleForRound(i+1));
      const okCycle = JSON.stringify(expectedCycle) === JSON.stringify(actualCycle);
      if (diag) diag.textContent += `\n${okCycle ? '‚úÖ' : '‚ùå'} cycle passRuleForRound (8 tours)`;

      if (diag) diag.textContent += `\n${typeof window.__submitScore==='function' ? '‚úÖ' : '‚ùå'} __submitScore disponible`;
      if (diag) diag.textContent += `\n${typeof window.__listenScores==='function' ? '‚úÖ' : '‚ùå'} listenScores (unique)`;
    }

    onReady(()=>{ wireOpenButton(); renderAll(); runUiTests(); setSync(navigator.onLine?'ok':'off'); });
    window.renderAll = renderAll;
  </script>

  <!-- Firestore (module) : auth + listeners + transactions (ajout validations) -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const qs = new URLSearchParams(location.search);
    const soireeCode = qs.get('code') || localStorage.getItem('dame_code') || '';
    const gameId     = qs.get('gid')  || localStorage.getItem('dame_gid')  || '';
    const myIndexURL = qs.get('my');

    const cfg = (window.__FIREBASE_CONFIG || {}).apiKey ? window.__FIREBASE_CONFIG : {
      ...(JSON.parse(localStorage.getItem('FIREBASE_CONFIG') || '{}')),
    };
    const app = getApps().length ? getApps()[0] : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    if (soireeCode) localStorage.setItem('dame_code', soireeCode);
    if (gameId)     localStorage.setItem('dame_gid', gameId);
    if (myIndexURL !== null) localStorage.setItem('dame_myIndex', String(myIndexURL));

    function normalizePlayers(soireeData){
      if (!soireeData) return [];
      if (Array.isArray(soireeData.players)) return soireeData.players.map((p,i)=>({ id: p.id || `p${i+1}`, name: (p.name ?? p.nom ?? String(p)), deviceId: p.deviceId || p.device_id || p.devId || null }));
      if (Array.isArray(soireeData.joueurs)) return soireeData.joueurs.map((name,i)=>({ id: `p${i+1}`, name }));
      if (soireeData.playersMap && typeof soireeData.playersMap === 'object') return Object.entries(soireeData.playersMap).map(([id, obj])=>({ id, name: obj?.name || id, deviceId: obj?.deviceId || null }));
      return [];
    }

    async function ensureAuth(){
      return new Promise((resolve)=>{
        const a = getAuth();
        onAuthStateChanged(a, async (user)=>{
          if (!localStorage.getItem('deviceId')){
            const devIdCandidate = user?.uid || String(Date.now());
            try{ localStorage.setItem('deviceId', devIdCandidate); }catch{}
          }
          window.__STATE.deviceId = localStorage.getItem('deviceId');
          if (user) { resolve(user); return; }
          try {
            const cred = await signInAnonymously(a);
            if (!localStorage.getItem('deviceId')){
              try{ localStorage.setItem('deviceId', cred.user?.uid || String(Date.now())); }catch{}
            }
            window.__STATE.deviceId = localStorage.getItem('deviceId');
            resolve(cred.user);
          } catch(err){
            console.error('[Auth] Anonyme √©chou√©e', err);
            resolve(null);
          }
        });
      });
    }

    async function seedScoresIfNeeded(players){
      if (!gameId) return;
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      const snap = await getDoc(ref);
      if (snap.exists()) return;
      const totals = Object.fromEntries(players.map(p=>[p.id, 0]));
      const dealerSeed = (typeof window.__STATE.dealerIndexFromSoiree === 'number' && window.__STATE.dealerIndexFromSoiree >= 0)
        ? window.__STATE.dealerIndexFromSoiree
        : (typeof window.__STATE.dealerIndex === 'number' ? window.__STATE.dealerIndex : 0);
      await setDoc(ref, { createdAt: serverTimestamp(), soireeCode: soireeCode || null, round: 1, dealerIndex: dealerSeed, totals, autoDealerSeeded: true });
      console.log('[Seed] scores_dame_de_pique cr√©√© (dealerIndex seed:', dealerSeed, ')');
    }

    function listenSoiree(){
      if (!soireeCode) return () => {};
      const sref = doc(db, 'soirees', soireeCode);
      return onSnapshot(sref, async (snap)=>{
        if (!snap.exists()) { console.warn('soiree introuvable:', soireeCode); return; }
        const data = snap.data()||{};
        const players = normalizePlayers(data);
        if (players.length) window.__STATE.players = players;
        window.__STATE.soireeNo = data.soireeNo ?? data.numero ?? null;
        // ‚úÖ Dealer provenant de selection_jeux
       // Dans listenSoiree(), juste apr√®s: const data = snap.data()||{};
const fromSoiree =
  (typeof data.leaderIndex === 'number')      ? data.leaderIndex :
  (typeof data.dealerIndex === 'number')      ? data.dealerIndex :
  (typeof data.dealerIndexStart === 'number') ? data.dealerIndexStart :
  -1;

window.__STATE.dealerIndex = fromSoiree;
window.__STATE.dealerIndexFromSoiree = fromSoiree;

        await seedScoresIfNeeded(window.__STATE.players);
        // Auto-bind par deviceId si possible
        const needBind = !(Number.isFinite(window.__STATE.myIndex) && window.__STATE.myIndex>=0 && window.__STATE.myIndex<window.__STATE.players.length);
        const devId = window.__STATE.deviceId || localStorage.getItem('deviceId');
        if (needBind && devId){
          const idx = window.__STATE.players.findIndex(p=> (p.deviceId && p.deviceId===devId));
          if (idx>=0){ try{ localStorage.setItem('dame_myIndex', String(idx)); }catch{} window.__STATE.myIndex = idx; }
        }
        window.renderAll?.();
      });
    }

    function listenScores(){
      if (!gameId) return () => {};
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      return onSnapshot(ref, async (snap)=>{
        setSync(navigator.onLine?'ok':'off');
        if (!snap.exists()) return;
        const d = snap.data();
        window.__STATE.round       = d.round || 1;
        window.__STATE.dealerIndex = (typeof d.dealerIndex === 'number') ? d.dealerIndex : window.__STATE.dealerIndex;
        window.__STATE.totals      = d.totals || window.__STATE.totals || {};
        window.__STATE.roundScores = d.roundState || {};
        window.__STATE.roundError  = d.roundError || '';
        window.__STATE.gameOver    = !!d.gameOver;
        window.__STATE.standings   = d.standings || [];
        window.__STATE.lastRound   = d.lastRound || null;
        // ‚úÖ Correction robuste du premier brasseur au tour 1 (une seule fois)
        const desired = window.__STATE.dealerIndexFromSoiree;
        if (typeof desired === 'number' && desired >= 0 && d.dealerIndex !== desired) {
          try {
            await updateDoc(ref, { dealerIndex: desired, autoDealerSeeded: true });
            window.__STATE.dealerIndex = desired;
          } catch(e) { console.warn('Auto seed dealer √©chou√©:', e); }
        }
        window.renderAll?.();
      });
    }
    window.__listenScores = listenScores;

    window.__submitScore = async function submitScore(val){
      // v6.5.5 ‚Äî garde-fous fin de partie + t√©l√©m√©trie debug (m√™me logique)
      if (!Number.isFinite(val) || val < 0 || val > 25) throw new Error('Score invalide (0‚Äì25)');
      if (!gameId) { window.__STATE.pendingScore = val; throw new Error('Partie non initialis√©e (gid manquant)'); }
      setSync('wait');
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error('Partie introuvable');
          const d = snap.data() || {};

          // ‚õî Emp√™cher toute saisie si la partie est d√©j√† termin√©e
          if (d.gameOver === true) throw new Error('Partie termin√©e.');

          const TOTAL_PER_ROUND = 25;   // r√®gle fixe d'origine
          const END_AT = Number.isFinite(d.endAt) ? Number(d.endAt) : 100; // permet override via doc

          const round = (typeof d.round === 'number' && d.round > 0) ? d.round : 1;
          const roundState = { ...(d.roundState || {}) };
          const totals = { ...(d.totals || {}) };

          // D√©terminer l'index local si non fix√©
          let idx = window.__STATE.myIndex;
          if (!(Number.isFinite(idx) && idx >= 0 && idx < window.__STATE.players.length)) {
            const devId = window.__STATE.deviceId || localStorage.getItem('deviceId');
            if (devId) {
              idx = window.__STATE.players.findIndex(p => (p.deviceId && p.deviceId === devId));
            }
          }
          if (!(Number.isFinite(idx) && idx >= 0 && idx < window.__STATE.players.length)) {
            throw new Error("Associez cet appareil √† votre nom.");
          }

          // Enregistrer le score du joueur courant
          roundState[idx] = Number(val);

          const expected = window.__STATE.players.length;
          const submitted = Object.keys(roundState).length;

          // Tant que tout le monde n'a pas soumis ‚Üí on sauvegarde l'√©tat courant
          if (submitted < expected) {
            tx.set(ref, { roundState, roundError: '' }, { merge: true });
            return;
          }

          // Tous ont soumis ‚Üí validations d'origine
          const values = Array.from({ length: expected }, (_, i) => Number(roundState[i] || 0));
          const sum = values.reduce((a, b) => a + b, 0);

          // 1) Somme exacte = 25
          if (sum !== TOTAL_PER_ROUND) {
            tx.set(ref, { roundState, roundError: `Le total des scores (${sum}) doit √™tre ${TOTAL_PER_ROUND}.` }, { merge: true });
            throw new Error(`Somme invalide (${sum} ‚â† ${TOTAL_PER_ROUND}).`);
          }

          // 2) Contr√¥le (Grand chelem) : 25 / 0 / 0 / 0 ‚Üí redistribution d'origine
          const count25 = values.filter(v => v === TOTAL_PER_ROUND).length;
          const count0  = values.filter(v => v === 0).length;
          let appliedGrandChelem = false;
          let perRound = [...values];
          let controleIndex = -1;
          if (count25 === 1 && count0 === (expected - 1)) {
            controleIndex = values.findIndex(v => v === TOTAL_PER_ROUND);
            perRound = values.map((v, i) => (i === controleIndex ? 0 : TOTAL_PER_ROUND));
            appliedGrandChelem = true;
          }

          // 3) Application aux totaux (coercition forte ‚Üí nombre)
          const ids = window.__STATE.players.map(p => p.id);
          ids.forEach((pid, i) => {
            const prev = Number.isFinite(Number(totals[pid])) ? Number(totals[pid]) : 0;
            totals[pid] = prev + Number(perRound[i] || 0);
          });

          // 4) Fin de partie ? (d√©fensif + t√©l√©m√©trie)
          const maxScore = Math.max(...ids.map(pid => Number(totals[pid] || 0)));
          const reached  = maxScore >= END_AT;
          let gameOver = false;
          let standings = [];
          let winnerId = null;
          if (reached) {
            gameOver = true;
            standings = ids
              .map((pid, i) => ({ pid, name: window.__STATE.players[i]?.name || pid, score: Number(totals[pid] || 0) }))
              .sort((a, b) => a.score - b.score);
            winnerId = standings[0]?.pid || null; // plus petit score gagne
          }

          const nextRound = round + 1;
          const nextDealer = (typeof d.dealerIndex === 'number')
            ? ((d.dealerIndex + 1) % expected)
            : ((window.__STATE.dealerIndex + 1) % expected);

          tx.set(ref, {
            totals,
            roundState: {},
            roundError: '',
            round: gameOver ? round : nextRound,
            dealerIndex: gameOver ? (typeof d.dealerIndex === 'number' ? d.dealerIndex : window.__STATE.dealerIndex) : nextDealer,
            gameOver,
            standings,
            winnerId,
            lastRound: { values, perRound, sum, appliedGrandChelem, controleIndex, round },
            debugLastCheck: { endAt: END_AT, max: maxScore, reached, at: new Date().toISOString() }
          }, { merge: true });
        });
        setSync('ok');
      } catch (err) {
        setSync('off');
        throw err;
      }
    };

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ try{ await signInAnonymously(auth); }catch(e){ console.error('Auth anonyme impossible', e); } return; }
      const un1 = listenSoiree();
      const un2 = listenScores();
      window.addEventListener('beforeunload', ()=>{ try{un1();un2();}catch{} });
    });
  </script>

<!-- Patch anti-yo-yo + cleanup soiree v6.8.3 (2025-11-08) -->
<script type="module">
  import { getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, deleteField } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const app = getApps()[0];
  const db  = getFirestore(app);

  const qs     = new URLSearchParams(location.search);
  const gid    = qs.get('gid')  || localStorage.getItem('dame_gid')  || '';
  const codeId = qs.get('code') || localStorage.getItem('dame_code') || '';

  const finishedKey = (g)=> `dame_finished_gid_${g}`;

  async function markScoresDone() {
    if (!gid) return;
    try {
      const ref  = doc(db, 'scores_dame_de_pique', gid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : {};
      const totals = (data && data.totals) ? data.totals : {};
      await updateDoc(ref, {
        state: 'done',
        archivedTotals: totals,
        finishedAt: serverTimestamp()
      });
    } catch (e) { console.warn('[v6.8.3] scores update failed', e); }
  }

  async function cleanupSoiree() {
    if (!codeId) return;
    try {
      const sref = doc(db, 'soirees', codeId);
      await updateDoc(sref, {
        status: 'setup',             // pr√™t pour relancer un autre jeu
        currentGame: deleteField(),  // supprime la r√©f√©rence √† la partie en cours
        lastEndedGame: { type: 'dame_de_pique', gid, endedAt: serverTimestamp() }
      });
    } catch (e) { console.warn('[v6.8.3] soiree cleanup failed', e); }
  }

  async function finishCleanPlus() {
    await markScoresDone();    // 1) Marque la partie comme termin√©e
    await cleanupSoiree();     // 2) Nettoie la soiree pour emp√™cher la redirection

    // 3) Pose le drapeau local + nettoie
    try { localStorage.setItem(finishedKey(gid || 'unknown'), '1'); } catch {}
  try { window.finishCleanPlus = finishCleanPlus; } catch(e) {}

    try { localStorage.removeItem('dame_gid'); localStorage.removeItem('dame_myIndex'); } catch {}

    // 4) Stoppe un √©ventuel listener
    try { window.unsubscribeMain?.(); } catch {}

    // 5) Redirection sans params
    location.replace('selection_jeux.html');
  }

  // Accrocher le bouton existant #btnReturn (√©vite double-binding avec un flag distinct)
  const btn = document.getElementById('btnReturn');
  if (btn && !btn.__finishPatched683) {
   btn.__finishPatched683 = true;
    btn.addEventListener('click', (ev) => { ev.preventDefault(); ev.stopImmediatePropagation(); }, { capture: true });
}
try { window.finishCleanPlus = finishCleanPlus; } catch(_) {}


  // S√©curit√© si l'onglet revient
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      try {
        if (gid && localStorage.getItem(finishedKey(gid))) {
          if (location.pathname.endsWith('dame_de_pique.html')) {
            location.replace('selection_jeux.html');
          }
        }
      } catch {}
    }
  }, { passive: true });

  // Garde optionnelle pour onSnapshot
  window.__antiYoyoGuard = function(data){
    try {
      if (data?.state === 'done' && localStorage.getItem(finishedKey(gid))) {
        window.unsubscribeMain?.();
        return true;
      }
    } catch {}
    return false;
  };
</script>


<!-- v6.8.3.1 patch (2025-11-08): auto-redirect all clients when soiree.currentGame disappears -->
<script type="module">
  import { getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getFirestore, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const app = getApps()[0];
  const db  = getFirestore(app);

  const qs     = new URLSearchParams(location.search);
  const codeId = qs.get('code') || localStorage.getItem('dame_code') || '';

  if (codeId) {
    const sref = doc(db, 'soirees', codeId);
    onSnapshot(sref, (snap) => {
      const data = snap.data && snap.data();
      // Quand v6.8.3 supprime currentGame -> d√©clenchement auto pour tous
      if (data && !data.currentGame) {
        const target = `selection_jeux.html?code=${codeId}`;
        if (!location.href.includes('selection_jeux.html')) {
          location.replace(target);
        }
      }
    });
  }
</script>


<script>
  try {
    console.debug('[dame] finishHostFlow available:', typeof window.finishHostFlow);
    console.debug('[dame] finishCleanPlus available:', typeof window.finishCleanPlus);
  } catch(_) {}
</script>


  <!-- Host-only always-visible finish button -->
  <div id="hostFinishContainer" style="display:none; text-align:center; margin:14px 0;">
    <button id="btnHostFinish" style="display:inline-block; background:#14532d;color:#e7f9f0;border:none;border-radius:12px;padding:10px 14px;font-size:15px;opacity:0.9;transition:opacity .2s; position:relative; overflow:hidden;">
      <span class="fill" style="position:absolute; left:0; top:0; height:100%; width:0; background:rgba(255,255,255,.18); transition:none; pointer-events:none;"></span>
      <span>Fin de la Partie (maintenir 2s)</span>
    </button>
  </div>

  <script>
  // v6.8.8: host-only finish button wiring (independent from legacy #btnReturn)
  (function(){
    function isHost(){
      try{ return String(localStorage.getItem('dame_myIndex')) === '0'; }catch(e){ return false; }
    }
    function applyHostVisibility(){
      var ctn = document.getElementById('hostFinishContainer');
      if(!ctn) return;
      ctn.style.display = isHost() ? 'block' : 'none';
    }
    function wireHostFinish(){
      var btn = document.getElementById('btnHostFinish');
      if(!btn || btn.__wiredHostFinish) return;
      btn.__wiredHostFinish = true;

      // Neutralise le clic court (on impose 2s de maintien)
      btn.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopImmediatePropagation(); }, { capture:true });

      var holdTimer = null;
      var fill = btn.querySelector('.fill');

      var start = function(ev){
        if (ev && ev.preventDefault) ev.preventDefault();
        if (fill){
          fill.style.transition='none';
          fill.style.width='0%';
          void fill.offsetWidth;
          fill.style.transition='width 2s linear';
          fill.style.width='100%';
        }
        holdTimer = setTimeout(function(){
          try {
            var fn = (window.finishHostFlow || window.finishCleanPlus);
            if (typeof fn === 'function') { fn(); }
            else { location.href='selection_jeux.html'; }
          } catch(e){
            console.error('[hostFinish] error', e);
            location.href='selection_jeux.html';
          }
        }, 2000);
      };
      var cancel = function(){
        if (holdTimer) clearTimeout(holdTimer);
        if (fill){
          fill.style.transition='none';
          fill.style.width='0%';
        }
      };

      btn.addEventListener('mousedown',  start);
      btn.addEventListener('mouseup',    cancel);
      btn.addEventListener('mouseleave', cancel);
      btn.addEventListener('touchstart', start, { passive:false });
      btn.addEventListener('touchend',   cancel);
      btn.addEventListener('touchcancel',cancel);
    }

    try{
      var orig = window.renderAll;
      if (typeof orig === 'function'){
        window.renderAll = function(){
          try { orig.apply(this, arguments); } catch(e){}
          applyHostVisibility();
          wireHostFinish();
        };
      }
    }catch(e){}

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ applyHostVisibility(); wireHostFinish(); }, { once:true });
    } else {
      applyHostVisibility(); wireHostFinish();
    }
  })();
  </script>

</body>
</html>
