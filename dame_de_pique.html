<!-- Dame de Pique — v6.5.6 (Stable)
     CHANGELOG clé:
     - Lit le brasseur depuis soirees.{leaderIndex} (fallback dealerIndex/dealerIndexStart)
     - Seed du document de score UNIQUEMENT quand le brasseur de la soirée est connu (pas de fallback 0)
     - Alignement systématique du dealerIndex côté scores vers la valeur de la soirée
     - Règles actives: somme de ronde = 25, bannière "Contrôle" si un joueur fait 25 (les autres 0), fin de partie si un total >= 125
     - UI mobile simple (modale de saisie, totaux, diagnostics)
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Dame de Pique — App (v6.5.6 — Stable)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --ok:#22c55e; --line:#243252; --danger:#ef4444; --warn:#f59e0b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:420px;margin:0 auto;padding:18px;display:grid;gap:18px}
    .titleRow{display:block;margin-bottom:8px}
    .titleRow h1{display:block;margin:0 0 8px 0;font-size:clamp(22px,5vw,28px)}
    .lbl{color:var(--muted);font-size:clamp(14px,4vw,16px)}
    .card{background:#111a2e;border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:52px;padding:0 16px;border-radius:16px;font-size:clamp(17px,4vw,19px);font-weight:800;color:#0c111b;background:var(--accent)}
    .btn[disabled]{opacity:.6;filter:grayscale(.3);cursor:not-allowed}
    .line{display:flex;align-items:center;justify-content:space-between;background:#0f1a30;border:1px solid #243252;border-radius:12px;padding:10px 12px}
    .footer{text-align:center;color:var(--muted)}
    .back{color:#9bb3d1;text-decoration:none}
    .back:hover{text-decoration:underline}
    /* Modale */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(92vw,420px);background:#0d1527;border:1px solid #2b3857;border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .sheet h3{margin:0 0 8px}
    .inp{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334567;background:#0b1324;color:var(--text);font-size:1rem}
    .row{display:grid;gap:8px}
    .msg{color:var(--ok);font-size:0.92rem;text-align:center}
    .danger{color:var(--danger)}
    .warn{color:var(--warn)}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .passTag{margin-left:auto;background:#14223f;border:1px solid #2b3e69;border-radius:10px;padding:6px 10px;font-size:.9rem}
    details.diag{border:1px dashed #2b3e69;border-radius:12px;padding:8px}
    details.diag>summary{cursor:pointer;color:#9bb3d1}
    .ok{color:var(--ok)}
    .dealerBadge{background:#14532d !important;border-color:#1a7f3a !important}
    .whoBtn{display:block;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3e69;background:#14223f;color:var(--text);font-weight:700;cursor:pointer}
    .whoBtn:hover{filter:brightness(1.05)}
    /* Status bar + toasts */
    .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .dot{inline-size:10px;block-size:10px;border-radius:999px;display:inline-block}
    .dot.ok{background:#22c55e}
    .dot.wait{background:#f59e0b}
    .dot.off{background:#ef4444}
    .muted{color:#9bb3d1;font-size:.9rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d1527;border:1px solid #2b3857;color:var(--text);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:60;display:none}
    .toast.show{display:block}
    .toast.err{border-color:#7f1d1d}
    .banner{border-radius:12px;padding:10px 12px;border:1px solid #3d2a10;background:#241707;color:#ffd99b;font-weight:700;text-align:center}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="titleRow">
      <h1>Dame De Pique</h1>
      <div class="meta metaRow">
        <div class="lbl">Brasseur : <strong id="dealerName">—</strong></div>
        <div class="lbl">Tour n° <span id="round">1</span></div>
        <div id="passInfo" class="passTag" title="Règle d'échange du tour">—</div>
      </div>
    </header>

    <!-- Status -->
    <section class="card status" id="statusBar" aria-live="polite">
      <span class="muted">Synchro:</span> <span id="syncDot" class="dot wait"></span>
      <span id="syncText" class="muted">En attente…</span>
      <span class="muted" style="margin-left:auto">Soumis: <span id="statusSubmitted">0/0</span></span>
      <span class="muted">Réseau:</span> <span id="netDot" class="dot off"></span>
    </section>

    <!-- Saisie -->
    <section class="card grid">
      <div class="lbl">Saisissez votre score</div>
      <button id="btnOpen" class="btn" type="button">Inscrire le pointage</button>
      <div id="msg" class="msg"></div>
    </section>

    <!-- Totaux -->
    <section class="card grid" id="totalsCard">
      <div class="lbl">Scores totaux</div>
      <div id="totalsList" class="grid"></div>
      <div class="lbl" id="roundStatus">0/0 soumis</div>
      <div class="lbl danger" id="roundError"></div>
      <div class="banner" id="controleBanner" style="display:none;">Contrôle !</div>
    </section>

    <div class="footer"><a class="back" href="#" id="backLink">← Retour</a></div>

    <!-- Modale -->
    <div class="modal" id="modal">
      <div class="sheet">
        <h3>Saisir mon score</h3>
        <div id="modalMsg" class="msg"></div>
        <div class="row">
          <div id="modalList" class="grid"></div>
          <input id="scoreInput" class="inp" type="number" min="0" max="25" step="1" placeholder="0–25" />
          <button id="btnSaveScore" class="btn" type="button">Valider</button>
        </div>
      </div>
    </div>

    <details class="diag" id="diag" open>
      <summary>Diagnostics / tests</summary>
      <div id="diagOutput" class="lbl"></div>
    </details>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Utils ---
    const $ = (id)=>document.getElementById(id);
    const qs = (k)=>new URLSearchParams(location.search).get(k);
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    let soireeCode = qs('code');
    let gameId = qs('gid');

    const state = {
      players: [],
      round: 1,
      roundScores: {},    // pId -> value
      totals: {},         // pId -> total
      submittedCount: 0,
      expectedCount: 0,
      myDeviceId: localStorage.getItem('deviceId') || localStorage.getItem('mgm_deviceId') || null,
      dealerIndex: -1,
      dealerIndexFromSoiree: -1,
      gameOver: false
    };

    function deviceIdEnsure(){
      if (!state.myDeviceId){
        const id = (crypto?.randomUUID?.()) || ('did_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8));
        state.myDeviceId = id; localStorage.setItem('deviceId', id);
      }
    }

    async function ensureAuth(){ try{ await signInAnonymously(auth); }catch(e){ console.warn('Auth anonyme échouée',e); } }

    // --- Rendu UI ---
    function setText(id, v){ const el=$(id); if(el) el.textContent = v; }
    function showToast(t, isErr=false){ const n=document.createElement('div'); n.className='toast'+(isErr?' err':''); n.textContent=t; document.body.appendChild(n); n.classList.add('show'); setTimeout(()=>{ n.remove(); }, 2200); }

    function renderModalList(){
      const host = $('modalList'); if(!host) return; host.innerHTML='';
      const dealer = (typeof state.dealerIndexFromSoiree==='number' && state.dealerIndexFromSoiree>=0) ? state.dealerIndexFromSoiree : state.dealerIndex;
      state.players.forEach((p, idx)=>{
        const line = document.createElement('div'); line.className='line'+(idx===dealer?' dealerBadge':'');
        const n = document.createElement('div'); n.textContent = p.name + (idx===dealer ? ' ★' : '');
        const v = document.createElement('div');
        const val = state.roundScores[p.id];
        v.textContent = (typeof val==='number' && Number.isFinite(val)) ? String(val) : '—';
        line.appendChild(n); line.appendChild(v); host.appendChild(line);
      });
    }

    function renderTotals(){
      const host = $('totalsList'); if(!host) return; host.innerHTML='';
      const dealer = (typeof state.dealerIndexFromSoiree==='number' && state.dealerIndexFromSoiree>=0) ? state.dealerIndexFromSoiree : state.dealerIndex;
      state.players.forEach((p, idx)=>{
        const line = document.createElement('div'); line.className='line'+(idx===dealer?' dealerBadge':'');
        const name = document.createElement('div'); name.textContent = p.name + (idx===dealer?' ★':'');
        const val = document.createElement('div'); val.textContent = String(state.totals[p.id]||0);
        line.appendChild(name); line.appendChild(val); host.appendChild(line);
      });
    }

    function renderAll(){
      const dealer = (typeof state.dealerIndexFromSoiree==='number' && state.dealerIndexFromSoiree>=0) ? state.dealerIndexFromSoiree : state.dealerIndex;
      setText('dealerName', state.players[dealer]?.name || '—');
      setText('round', String(state.round||1));
      const submitted = state.submittedCount||0; setText('statusSubmitted', `${submitted}/${state.expectedCount||0}`);
      renderTotals(); renderModalList();
      // Décor fond brasseur si appareil = brasseur
      const myIdx = state.players.findIndex(p=>p.deviceId && p.deviceId===state.myDeviceId);
      if (myIdx === dealer) { document.body.style.background = '#0f2e16'; } else { document.body.style.background = 'var(--bg)'; }
    }

    // --- Logique règles ---
    function validateRoundAndFlags(){
      const values = state.players.map(p=> Number(state.roundScores[p.id]||0));
      const sum = values.reduce((a,b)=>a+b,0);
      const controle = values.includes(25) && values.filter(v=>v===0).length === (values.length-1);
      const err = (sum !== 25);
      $('roundError').textContent = err ? `La somme doit être 25 (actuel ${sum}).` : '';
      $('controleBanner').style.display = controle ? 'block' : 'none';
      return { ok: !err, controle };
    }

    async function applyRoundToTotals(){
      state.players.forEach(p=>{ const v = Number(state.roundScores[p.id]||0); state.totals[p.id] = Number(state.totals[p.id]||0) + v; });
    }

    function checkGameOver(){
      const any = state.players.some(p => Number(state.totals[p.id]||0) >= 125);
      state.gameOver = any; return any;
    }

    // --- Firestore ---
    async function listenSoiree(){
      if(!soireeCode) return;
      const ref = doc(db,'soirees', soireeCode);
      onSnapshot(ref, async snap=>{
        if(!snap.exists()) return;
        const data = snap.data()||{};
        const fromSoiree =
          (typeof data.leaderIndex === 'number')      ? data.leaderIndex :
          (typeof data.dealerIndex === 'number')      ? data.dealerIndex :
          (typeof data.dealerIndexStart === 'number') ? data.dealerIndexStart :
          -1;
        state.dealerIndex = fromSoiree; state.dealerIndexFromSoiree = fromSoiree;
        // joueurs
        state.players = Array.isArray(data.players) ? data.players.map((p,i)=>({
          id: p.id || String(i),
          name: p.name || `Joueur ${i+1}`,
          deviceId: p.deviceId || null,
          order: typeof p.order==='number'?p.order:i
        })) : [];
        state.expectedCount = state.players.length;
        renderAll();
        // seed côté scores si nécessaire
        await seedScoresIfNeeded(state.players);
      });
    }

    async function seedScoresIfNeeded(players){
      if (!gameId) return;
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      const snap = await getDoc(ref);
      if (snap.exists()) return;
      const desired = state.dealerIndexFromSoiree;
      if (!(typeof desired === 'number' && desired >= 0)) {
        console.warn('[Seed] dealerIndexFromSoiree absent — attente de selection_jeux');
        return; // ❗ ne pas créer le doc tant que le dealer n'est pas connu
      }
      const totals = Object.fromEntries(players.map(p=>[p.id, 0]));
      await setDoc(ref, { createdAt: serverTimestamp(), soireeCode: soireeCode || null, round: 1, dealerIndex: desired, totals, autoDealerSeeded: true, gameOver: false });
      console.log('[Seed] scores_dame_de_pique créé avec dealerIndex =', desired);
    }

    function listenScores(){
      if (!gameId) return ()=>{};
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      return onSnapshot(ref, async (snap)=>{
        if (!snap.exists()) return;
        const d = snap.data();
        // Alignement systématique dealer -> soirée
        const desired = state.dealerIndexFromSoiree;
        if (typeof desired === 'number' && desired >= 0 && d.dealerIndex !== desired) {
          try { await updateDoc(ref, { dealerIndex: desired, autoDealerSeeded: true }); } catch(e){ console.warn('Align dealer fail', e); }
        }
        state.round = d.round||1; state.totals = d.totals||{}; state.gameOver = !!d.gameOver;
        // submittedCount (approx: nb de joueurs avec roundScores définis côté local)
        const submitted = Object.values(state.roundScores).filter(v=>Number.isFinite(Number(v))).length;
        state.submittedCount = submitted;
        renderAll();
        if (state.gameOver){ $('roundError').textContent=''; $('controleBanner').style.display='none'; showToast('Partie terminée.'); }
      });
    }

    async function saveRoundScore(value){
      const ref = doc(db, 'scores_dame_de_pique', gameId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const d = snap.data();
      const nextRound = (d.round||1);
      // appliquer localement
      await applyRoundToTotals();
      const over = checkGameOver();
      await updateDoc(ref, {
        totals: state.totals,
        round: nextRound + 1,
        gameOver: over || false,
        updatedAt: serverTimestamp()
      });
      state.roundScores = {}; // reset pour la prochaine ronde locale
      renderAll();
      if (over){
        showToast('Fin de partie. Retour à la sélection conseillé.');
        // nettoyage du pointeur côté soiree (évite redirection infinie depuis selection_jeux)
        try{ await updateDoc(doc(db,'soirees', soireeCode), { currentGame: null }); }catch{}
      }
    }

    // --- Événements UI ---
    function openModal(){ $('modal').classList.add('show'); $('modalMsg').textContent=''; $('scoreInput').value=''; renderModalList(); }
    function closeModal(){ $('modal').classList.remove('show'); }

    function collectRoundValues(){
      // On prend la valeur saisie pour CET appareil
      const me = state.players.find(p=>p.deviceId && p.deviceId===state.myDeviceId);
      const raw = Number($('scoreInput').value || 0);
      if (!me){ showToast("Associe ton appareil à un joueur dans la page d'accueil.", true); return null; }
      if (!Number.isFinite(raw) || raw<0 || raw>25){ showToast('Score invalide (0–25).', true); return null; }
      const rs = { ...state.roundScores };
      rs[me.id] = raw;
      return rs;
    }

    // --- Main ---
    let stopScores = null;
    window.addEventListener('DOMContentLoaded', async ()=>{
      deviceIdEnsure();
      await ensureAuth();
      if (!soireeCode){ showToast('Code soirée manquant', true); return; }
      await listenSoiree();
      stopScores = listenScores();

      $('btnOpen').addEventListener('click', openModal);
      $('modal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeModal(); });
      $('btnSaveScore').addEventListener('click', async ()=>{
        const rs = collectRoundValues(); if(!rs) return;
        state.roundScores = rs; renderModalList();
        const { ok } = validateRoundAndFlags();
        if (!ok){ showToast('Corrige la somme de 25.', true); return; }
        closeModal();
        await saveRoundScore(rs);
      });

      $('backLink').addEventListener('click', (e)=>{ e.preventDefault(); history.length>1 ? history.back() : (location.href = `selection_jeux.html?code=${encodeURIComponent(soireeCode||'')}`); });
    });
  </script>
</body>
</html>
