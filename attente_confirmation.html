<!-- v2.3 – 2025-11-02 – Page hôte : écoute en temps réel + redirection globale vers selection_jeux.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Soirée de cartes – Attente des joueurs</title>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --text:#f5f7fb; --muted:#b9c2d0; --accent:#4fd1c5; --danger:#ef4444; --line:#243252; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:var(--text)}
    .wrap{max-width:680px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .card{background:rgba(17,26,46,0.85);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(4px)}
    h1{margin:4px 0 0;font-size:1.7rem}
    .muted{color:var(--muted)}
    ul{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    li{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px dashed var(--line);border-radius:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1a30}
    .ok{color:#22c55e}
    .warn{color:#f59e0b}
    .footer{color:var(--muted);text-align:center;margin-top:10px}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const qs = new URLSearchParams(location.search);
    const CODE = (qs.get('code') || localStorage.getItem('sc_code') || '').replace(/\D/g,'').slice(0,4);
    if(!CODE){ alert('Code de soirée manquant'); }

    const $ = (id)=>document.getElementById(id);

    function renderPlayers(players){
      const list = $('players');
      list.innerHTML = '';
      players.sort((a,b)=>(a.order??0)-(b.order??0)).forEach((p,i)=>{
        const li = document.createElement('li');
        const name = p.name || `Joueur ${i+1}`;
        const tag = p.confirmed ? '<span class="pill ok">Confirmé ✓</span>' : '<span class="pill warn">En attente…</span>';
        li.innerHTML = `<span>${name}</span>${tag}`;
        list.appendChild(li);
      });
    }

    async function start(){
      try{ await signInAnonymously(auth); }catch{}
      const ref = doc(db,'soirees',CODE);
      onSnapshot(ref, async (snap)=>{
        if(!snap.exists()){ $('status').textContent='introuvable'; return; }
        const data = snap.data();
        const players = Array.isArray(data.players)? data.players:[];
        renderPlayers(players);

        const allConfirmed = players.length>0 && players.every(p=>p.confirmed);
        if(allConfirmed && String(data.status)!=='playing'){
          await updateDoc(ref,{status:'playing'});
        }
        if(String(data.status)==='playing'){
          window.location.href = `selection_jeux.html?code=${CODE}`;
        }
      });
    }

    window.addEventListener('DOMContentLoaded', start);
  </script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Soirée #<span id="code">----</span></h1>
      <p class="muted">En attente de la confirmation des joueurs…</p>
      <ul id="players"></ul>
    </section>
    <div class="footer">v2.3 • Hôte – Écoute Firestore + redirection automatique</div>
  </main>
</body>
</html>
