<!-- v2.6.2 ‚Äì 2025-11-02 ‚Äì Fix Firestore path + guards + tests
  - Corrige l‚Äôerreur "Invalid collection reference sessions/players" en exigeant un code valide et en ciblant sessions/{code}/players
  - Ajoute un garde: si codeClean n‚Äôest pas 4 chiffres ‚Üí pas d‚Äôabonnement Firestore
  - S√©pare les listeners: 1) session (expectedPlayers) 2) players (liste) ‚Äî plus de onSnapshot imbriqu√©
  - Redirection uniquement quand **confirm√©s** === expectedPlayers
  - Mini tests int√©gr√©s activables via ?test=1 (console)
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Attente Confirmation</title>
  <style>
    body {font-family: system-ui, sans-serif; background: #0b1220 url('https://jads.ca/image/fond_jeep.webp') center/cover no-repeat fixed; color: #f5f7fb; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center;}
    main.card {background: rgba(17,26,46,0.85); border-radius: 16px; padding: 24px; width: min(500px,90vw); box-shadow: 0 8px 24px rgba(0,0,0,.4); text-align: center;}
    h1 {margin-top: 0;}
    ul {list-style: none; padding: 0; margin: 10px 0;}
    li {padding: 8px 12px; border-bottom: 1px solid #243252; display: flex; justify-content: space-between;}
    .pill {padding: 4px 10px; border-radius: 999px; background: #1d2a45;}
    .ok {color: #22c55e;}
    .wait {color: #f59e0b;}
    .err {color:#ffd6db;background:#2b0e12;border:1px solid #6b1f28;padding:10px;border-radius:10px;display:none;margin-top:8px}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const url = new URL(location.href);
    const code = url.searchParams.get('code');
    const codeClean = (code || '').replace(/\D/g,'').slice(0,4);

    const $ = id => document.getElementById(id);

    function showErr(msg){ const el=$('err'); el.textContent=msg; el.style.display='block'; }
    function hideErr(){ const el=$('err'); el.style.display='none'; }

    function buildPlayLink(code){
      return `selection_jeux.html?code=${encodeURIComponent(code)}`;
    }

    function renderPlayers(players, expected){
      const ul = $('players');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const status = p.confirmed || p.deviceId || p.confirmedAt ? '<span class="ok">Confirm√©</span>' : '<span class="wait">En attente</span>';
        li.innerHTML = `<span>${p.name || 'Joueur'}</span><span class="pill">${status}</span>`;
        ul.appendChild(li);
      });
      const confirmedCount = players.filter(p => p.confirmed || p.deviceId || p.confirmedAt).length;
      $('counter').textContent = `${confirmedCount}/${expected ?? '?'}`;
      // Redirection automatique uniquement si tous les joueurs sont confirm√©s
      if (expected && confirmedCount === expected){
        if (!window.__sc_redirected){
          window.__sc_redirected = true;
          location.href = buildPlayLink(codeClean);
        }
      }
    }

    function subscribe(code4){
      // Listener 1: session/{code} ‚Üí expectedPlayers
      let expectedPlayers = null;
      const sessRef = doc(db,'sessions', code4);
      onSnapshot(sessRef, snap => {
        expectedPlayers = snap.exists() ? (snap.data().expectedPlayers ?? null) : null;
      });

      // Listener 2: sessions/{code}/players ‚Üí liste
      const qPlayers = query(collection(db,'sessions', code4, 'players'), orderBy('seatIndex','asc'));
      onSnapshot(qPlayers, snap => {
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderPlayers(arr, expectedPlayers);
      }, (err) => showErr('Erreur Firestore (players): '+(err?.message||err)) );
    }

    function run(){
      $('code').textContent = codeClean || '----';
      if (!/^\d{4}$/.test(codeClean)){
        showErr('Code de soir√©e manquant ou invalide. Ouvrez cette page via le lien de l\'h√¥te.');
        return; // üîí Emp√™che la cr√©ation d'un chemin Firestore invalide comme "sessions/players"
      }
      hideErr();
      subscribe(codeClean);

      // ---- Mini tests (console) : activer avec ?test=1 ----
      if (url.searchParams.get('test') === '1'){
        const tests = [];
        const assert = (name, cond)=> tests.push({name, pass: !!cond});
        // Test 1: code est 4 chiffres
        assert('codeClean est 4 chiffres', /^\d{4}$/.test(codeClean));
        // Test 2: confirmedCount calcule correctement
        const fakePlayers = [
          { name:'A', confirmed:true },
          { name:'B', deviceId:'x' },
          { name:'C', confirmedAt:{seconds:1} },
          { name:'D' }
        ];
        const confirmedCount = fakePlayers.filter(p=> p.confirmed || p.deviceId || p.confirmedAt).length;
        assert('confirmedCount == 3', confirmedCount === 3);
        // Report
        console.group('attente_confirmation tests');
        tests.forEach(t=> console.log(t.pass?'‚úÖ':'‚ùå', t.name));
        console.groupEnd();
      }
    }

    window.addEventListener('DOMContentLoaded', run);
  </script>
</head>
<body>
  <main class="card">
    <h1>Attente des confirmations</h1>
    <p>Code soir√©e¬†: <strong id="code">----</strong></p>
    <p>Joueurs confirm√©s¬†: <span id="counter">0/?</span></p>
    <ul id="players"></ul>
    <div id="err" class="err" role="alert"></div>
  </main>
</body>
</html>
