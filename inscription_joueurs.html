<!-- v1.6 – 2025-11-02 – Hôte auto-confirmé
- Le joueur de siège 0 (hôte) est automatiquement lié à l’appareil et à l’utilisateur qui démarre la soirée
- Ajout deviceId + uid + confirmed + confirmedAt sur seatIndex=0
- Reste identique : fond Jeep, validation du nombre, redirection
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Soirée de cartes – Inscription des joueurs</title>
  <style>
    :root{ --bg:#0b1220; --text:#f5f7fb; --accent:#4fd1c5; --line:#243252; }
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      margin:0;
      padding:24px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      background:url('https://jads.ca/image/fond_jeep.webp') center/cover no-repeat fixed;
    }
    .wrap{width:min(820px,94vw)}
    .card{
      background:rgba(17,26,46,.9);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px 18px 22px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      backdrop-filter:blur(4px);
    }
    h1{margin:.2rem 0 1rem;font-size:1.6rem}
    .code{font-size:2.2rem;letter-spacing:.2rem;font-weight:800;background:#0f1a33;border:1px dashed #28406d;border-radius:12px;padding:10px 16px;display:inline-block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    textarea,button,input{padding:12px 14px;border-radius:12px;border:none;font-size:1rem}
    textarea{background:#0f1a33;color:var(--text);border:1px solid #243252;width:100%;min-height:160px;resize:vertical}
    input[type="number"]{width:120px;background:#0f1a33;color:var(--text);border:1px solid #243252;text-align:center}
    button{cursor:pointer;font-weight:700}
    .btn{background:var(--accent);color:#001018}
    .btn-alt{background:#60a5fa;color:#001018}
    .list{margin-top:12px}
    .player{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid #243252;border-radius:12px;margin-top:8px;background:#0f1a33}
    .muted{color:#9fb1d1;font-size:.9rem}
    .badge{font-size:.75rem;background:#1f3b66;color:#cfe1ff;border:1px solid #2a4f8a;border-radius:999px;padding:2px 8px;margin-left:8px}
    .error{color:#ef4444;margin-top:8px;display:none}
    .ok{color:#34d399;margin-top:8px;display:none}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, setDoc, getDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLSnoOCdHXl-5sKaJ55hhFbv-quS156kg",
      authDomain: "soireecartev2.firebaseapp.com",
      projectId: "soireecartev2",
      storageBucket: "soireecartev2.firebasestorage.app",
      messagingSenderId: "784781686361",
      appId: "1:784781686361:web:033693cb22fb1a55af2348"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = (id)=> document.getElementById(id);
    const codeEl = $('code');
    const namesEl = $('names');
    const expectedEl = $('expected');
    const startBtn = $('start');
    const errorEl = $('error');
    const okEl = $('ok');
    const listEl = $('list');

    function getDeviceId(){
      const k='sc_deviceId';
      let id = localStorage.getItem(k);
      if(!id){ id = crypto.randomUUID(); localStorage.setItem(k,id); }
      return id;
    }

    let code = new URL(location.href).searchParams.get('code') || '';

    function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; okEl.style.display='none'; }
    function showOk(msg){ okEl.textContent = msg; okEl.style.display = 'block'; errorEl.style.display='none'; setTimeout(()=> okEl.style.display='none', 2200); }

    async function ensureHostForSession(uid){
      await setDoc(doc(db,'roles', uid), { role:'host', sessionCode: code }, { merge:true });
      await setDoc(doc(db,'sessions', code), { code, hostUid: uid, status:'setup', createdAt: serverTimestamp() }, { merge:true });
    }

    async function reindexPlayersAndHost(){
      const qAsc = query(collection(db,'sessions', code, 'players'), orderBy('seatIndex','asc'));
      const snap = await getDocs(qAsc);
      const batch = writeBatch(db);
      let i = 0; let firstName = '';
      snap.forEach((docSnap)=>{
        const ref = docSnap.ref; const data = docSnap.data();
        if (i===0) firstName = data.name;
        batch.set(ref, { seatIndex: i }, { merge: true });
        i++;
      });
      await batch.commit();
      if (firstName){ await setDoc(doc(db,'sessions', code), { hostName: firstName }, { merge:true }); }
    }

    function listenList(){
      const qPlayers = query(collection(db, 'sessions', code, 'players'), orderBy('seatIndex','asc'));
      return onSnapshot(qPlayers, (snap)=>{
        listEl.innerHTML = '';
        snap.forEach((docSnap)=>{ listEl.appendChild(renderPlayer(docSnap)); });
      });
    }

    function renderPlayer(docSnap){
      const d = docSnap.data();
      const li = document.createElement('div');
      li.className = 'player';
      const seat = d.seatIndex ?? 0;
      const badge = seat === 0 ? '<span class="badge">Hôte</span>' : `<span class="badge">Siège ${seat} (à gauche →)</span>`;
      li.innerHTML = `<div><strong>${d.name}</strong> ${badge}<div class=\"muted\">${new Date(d.at?.seconds?d.at.seconds*1000:Date.now()).toLocaleTimeString()}</div></div>`;
      const del = document.createElement('button');
      del.textContent = 'Retirer';
      del.onclick = async ()=>{ await deleteDoc(docSnap.ref); await reindexPlayersAndHost(); };
      del.className = 'btn-alt';
      li.appendChild(del);
      return li;
    }

    function parseNames(text){
      return text.split(/\r?\n/).map(s=> s.trim()).filter(Boolean);
    }

    async function clearPlayers(){
      const snap = await getDocs(collection(db,'sessions', code, 'players'));
      const batch = writeBatch(db);
      snap.forEach(d=> batch.delete(d.ref));
      await batch.commit();
    }

    async function addAllFromTextarea(){
      const names = parseNames(namesEl.value);
      const expected = Number(expectedEl.value || 0);
      if (expected < 2){ throw new Error('Indiquez un nombre de joueurs (≥ 2).'); }
      if (names.length === 0){ throw new Error('Entrez au moins un nom (un par ligne).'); }
      if (names.length !== expected){ throw new Error(`La liste (${names.length}) ne correspond pas au nombre prévu (${expected}).`); }

      await setDoc(doc(db,'sessions', code), { expectedPlayers: expected }, { merge:true });
      await clearPlayers();

      // Auto-confirmation de l'hôte (seatIndex=0)
      const DEVICE_ID = getDeviceId();
      const user = auth.currentUser || await new Promise(resolve=>{ const stop=onAuthStateChanged(auth,u=>{ if(u){ stop(); resolve(u);} }); signInAnonymously(auth).catch(()=>resolve(null)); });
      const uid = user?.uid || null;

      for (let seat=0; seat<names.length; seat++){
        const name = names[seat];
        const base = { name, seatIndex: seat, at: serverTimestamp() };
        const data = (seat === 0)
          ? { ...base, deviceId: DEVICE_ID, uid, confirmed: true, confirmedAt: serverTimestamp() }
          : base;
        await addDoc(collection(db,'sessions', code, 'players'), data);
        if (seat === 0){ await setDoc(doc(db,'sessions', code), { hostName: name }, { merge:true }); }
      }
      showOk('Liste enregistrée.');
    }

    function bind(){
      namesEl.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); startBtn.click(); } });
      startBtn.addEventListener('click', async ()=>{
        try{
          startBtn.disabled = true;
          await addAllFromTextarea();
          await reindexPlayersAndHost();
          await setDoc(doc(db,'sessions', code), { status:'waiting' }, { merge:true });
          location.href = `attente_confirmation.html?code=${encodeURIComponent(code)}`;
        }catch(e){ showError('Impossible de continuer : '+(e?.message||e)); }
        finally{ startBtn.disabled = false; }
      });
    }

    async function init(){
      if(!code){ showError('Code de soirée manquant'); return; }
      codeEl.textContent = code;

      onAuthStateChanged(auth, async (user)=>{
        if(!user){ await signInAnonymously(auth); return; }
        await ensureHostForSession(user.uid);
        const sess = await getDoc(doc(db,'sessions', code));
        const v = sess.exists() ? sess.data().expectedPlayers : undefined;
        if (typeof v === 'number' && v > 0) expectedEl.value = v;
        listenList();
      });

      bind();
    }

    init();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Inscription des joueurs</h1>
      <div>Numéro de soirée : <span id="code" class="code">----</span></div>
      <div class="muted" style="margin-top:6px">Collez une liste : <strong>1 nom par ligne</strong>. Le premier devient l'<strong>Hôte</strong>, les suivants sont dans l'ordre <strong>à gauche</strong> (sens horaire).</div>

      <div style="margin-top:12px" class="row">
        <label for="expected">Nombre de joueurs :</label>
        <input id="expected" type="number" min="2" step="1" placeholder="Ex. 4" />
      </div>

      <div style="margin-top:12px">
        <textarea id="names" placeholder="Exemple:\nJean (Hôte)\nMarc\nLouise\nPaul"></textarea>
      </div>

      <div id="list" class="list"></div>

      <div style="margin-top:18px" class="row">
        <button id="start" class="btn-alt">Continuer ➜ écran d'attente / QR</button>
      </div>

      <div id="error" class="error"></div>
      <div id="ok" class="ok"></div>
    </div>
  </div>
</body>
</html>
